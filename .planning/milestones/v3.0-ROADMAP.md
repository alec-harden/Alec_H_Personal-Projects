# Milestone v3.0: Multi-User & Cut Optimizer

**Status:** IN PROGRESS
**Phases:** 13-21
**Total Plans:** TBD (estimated 18-24)

## Overview

Enable real multi-user operation with proper security (RBAC, email flows), enhance BOM with lumber dimensions and board feet, and add a new Cut List Optimizer tool for minimizing material waste through 1D bin packing and 2D sheet nesting algorithms.

## Phases

### Phase 13: RBAC Foundation ✓

**Goal**: Security foundation with role-based access control protecting all admin routes.
**Depends on**: None (security retrofit must come first)
**Plans:** 2 plans
**Status:** COMPLETE (2026-01-29)

Plans:
- [x] 13-01-PLAN.md — Schema + type system + guards (role column, app.d.ts, requireAdmin)
- [x] 13-02-PLAN.md — Retrofit admin routes + first admin logic

**Requirements:**
- RBAC-01: Users have a role field (admin or user)
- RBAC-02: Admin role grants elevated permissions
- RBAC-03: User role is default for new registrations
- RBAC-04: Admin routes (/admin/*) check role before access
- RBAC-05: Users can only see their own projects, BOMs, and cut lists
- RBAC-06: First registered user becomes admin (or seed admin)

**Success Criteria:**
1. User table has role column with admin/user values
2. Non-admin user accessing /admin/* routes receives 403 Forbidden
3. User A cannot see or access User B's projects or BOMs
4. First signup becomes admin; subsequent signups become users
5. Session includes role for client-side conditional rendering

**Technical Notes:**
- Add role column to users table (Drizzle migration)
- requireAdmin() helper in $lib/server/auth.ts
- Retrofit existing /admin/templates routes with role check
- Audit all load() and action() functions for ownership verification

---

### Phase 14: User Management (Admin) ✓

**Goal**: Admin can view, create, and manage user accounts.
**Depends on**: Phase 13 (requires RBAC foundation)
**Plans:** 3 plans
**Status:** COMPLETE (2026-01-29)

Plans:
- [x] 14-01-PLAN.md — Schema (disabled field) + login blocking
- [x] 14-02-PLAN.md — User list page + create user
- [x] 14-03-PLAN.md — User detail page + password reset + toggle disabled

**Requirements:**
- USER-01: Admin can view list of all users
- USER-02: Admin can create new user account
- USER-03: Admin can reset a user's password
- USER-04: Admin can disable a user account
- USER-05: Admin can view user details (email, created date, role)
- USER-06: Disabled users cannot log in

**Success Criteria:**
1. Admin can view paginated list of all users at /admin/users
2. Admin can create new user with email and temporary password
3. Admin can reset any user's password to a new value
4. Disabled user attempting login sees "Account disabled" error
5. User details page shows email, created date, role, and status

**Technical Notes:**
- /admin/users route with list view
- /admin/users/[id] route for user detail/actions
- Add "disabled" boolean column to users table
- Password reset sets new password directly (no email flow)

---

### Phase 15: Email Infrastructure & Password Reset ✓

**Goal**: Users can reset forgotten passwords via email link.
**Depends on**: Phase 13 (requires RBAC for security context)
**Plans:** 2 plans
**Status:** COMPLETE (2026-01-29)

Plans:
- [x] 15-01-PLAN.md — Schema + email client + token utilities
- [x] 15-02-PLAN.md — Forgot password + reset password routes

**Requirements:**
- EMAIL-01: User can request password reset from login page
- EMAIL-02: User receives email with password reset link
- EMAIL-03: User can set new password via reset link (expires in 1 hour)

**Success Criteria:**
1. Login page has "Forgot password?" link leading to reset request form
2. Valid email address receives password reset email within 60 seconds
3. Reset link contains token that expires after 1 hour
4. User can set new password and immediately log in
5. Same response shown for valid and invalid emails (prevents enumeration)

**Technical Notes:**
- Resend API integration in $lib/server/email.ts
- passwordResetTokens table (hashed token, userId, expiresAt)
- /auth/forgot-password and /auth/reset-password routes
- Tokens deleted immediately after successful use

---

### Phase 16: Email Verification ✓

**Goal**: Users verify email ownership after signup.
**Depends on**: Phase 15 (requires email infrastructure)
**Plans:** 2 plans
**Status:** COMPLETE (2026-01-29)

Plans:
- [x] 16-01-PLAN.md — Schema + token infrastructure (emailVerificationTokens, emailVerified column, token functions)
- [x] 16-02-PLAN.md — Verification routes + signup integration + admin badge

**Requirements:**
- EMAIL-04: New user receives email verification request after signup
- EMAIL-05: User can verify email by clicking link in email
- EMAIL-06: User profile shows email verification status

**Success Criteria:**
1. Signup triggers verification email within 60 seconds
2. Clicking verification link marks email as verified
3. User profile shows verified/unverified badge
4. User can request new verification email if needed
5. Verification tokens expire after 24 hours

**Technical Notes:**
- emailVerificationTokens table (hashed token, userId, expiresAt)
- emailVerified boolean column on users table
- /auth/verify-email route for link handling
- Profile page shows verification status

---

### Phase 17: BOM Refinements ✓

**Goal**: Lumber items track dimensions and board feet for accurate material planning.
**Depends on**: Phase 13 (data isolation must be in place)
**Plans:** 3 plans
**Status:** COMPLETE (2026-01-29)

Plans:
- [x] 17-01-PLAN.md — Schema + eye icon toggle (dimension columns, BOMItem type, eye icon visibility)
- [x] 17-02-PLAN.md — Dimension UI + board feet (lumber inputs, board feet calc, category total)
- [x] 17-03-PLAN.md — CSV integration (export/import dimension columns)

**Requirements:**
- BOM-05: Visibility toggle uses eye icon (not checkbox)
- BOM-06: Lumber items have dimension fields (length, width, height)
- BOM-07: Lumber items display board feet (calculated from dimensions)
- BOM-08: Lumber category shows total board feet
- BOM-09: CSV export includes dimension columns for lumber
- BOM-10: CSV import parses dimension columns for lumber

**Success Criteria:**
1. Visibility toggle shows open eye (visible) / closed eye (hidden) icons
2. Lumber items can have L/W/H dimensions entered in fractional inches
3. Board feet calculated as (L x W x H) / 144 and displayed per item
4. Lumber category header shows sum of all visible board feet
5. CSV export includes length, width, height columns for lumber
6. CSV import populates dimension fields when present

**Technical Notes:**
- Add length, width, height nullable columns to bomItems table
- Board feet calculation: (L * W * H) / 144
- Eye icon SVG component (eye-open, eye-off)
- Update CSV export/import to handle dimension columns

---

### Phase 18: Cut Optimizer Foundation

**Goal**: New Cut List Optimizer tool with core UI and data schema.
**Depends on**: Phase 17 (BOM dimensions required for integration)

**Requirements:**
- CUT-01: New tool accessible from dashboard (/cutlist)
- CUT-02: User can select Linear or Sheet optimization mode
- CUT-03: User can input required cuts with dimensions
- CUT-04: User can input available stock dimensions
- CUT-05: User can configure kerf/blade width
- CUT-06: User can run optimization algorithm
- CUT-07: Results display waste percentage
- CUT-08: Results display which cuts come from which stock
- CUT-09: User can clear all inputs and start over
- CUT-10: User can save cut list to a project

**Success Criteria:**
1. Dashboard shows Cut List Optimizer card linking to /cutlist
2. Mode toggle switches between Linear and Sheet input forms
3. User can add, edit, and remove cut definitions
4. User can add, edit, and remove stock definitions
5. Kerf input defaults to 1/8" with fractional input support

**Technical Notes:**
- /cutlist route with SvelteKit file-based routing
- cutLists, cutListStock, cutListCuts tables in schema
- Mode stored in cutList record
- Kerf stored as decimal inches

---

### Phase 19: Linear Optimizer (1D)

**Goal**: 1D bin packing algorithm optimizes board and trim cuts.
**Depends on**: Phase 18 (requires cut optimizer foundation)

**Requirements:**
- CUT-11: Linear mode accepts cut lengths
- CUT-12: Linear mode accepts stock lengths
- CUT-13: Linear mode supports multiple stock length options
- CUT-14: Linear mode displays total linear feet summary
- CUT-15: Linear mode visualizes unused portions of stock
- CUT-16: 1D bin packing algorithm (FFD) produces optimal-ish cuts

**Success Criteria:**
1. Linear mode form accepts length (no width/height) for cuts
2. Multiple stock lengths can be defined (8', 10', 12' boards)
3. First Fit Decreasing algorithm assigns cuts to stock pieces
4. Results show total linear feet used vs total available
5. Visual diagram shows each stock piece with cuts and waste highlighted

**Technical Notes:**
- First Fit Decreasing (FFD) algorithm in $lib/server/optimizer/linear.ts
- Sort cuts descending by length, pack into bins
- Account for kerf between each cut
- SVG visualization with proportional cut lengths

---

### Phase 20: Sheet Optimizer (2D)

**Goal**: 2D nesting algorithm optimizes plywood and panel cuts.
**Depends on**: Phase 19 (1D validates optimizer architecture)

**Requirements:**
- CUT-17: Sheet mode accepts cut dimensions (L x W)
- CUT-18: Sheet mode accepts sheet dimensions
- CUT-19: Sheet mode supports grain direction toggle per cut
- CUT-20: Sheet mode displays cut diagram visualization
- CUT-21: Sheet mode displays number of sheets needed
- CUT-22: 2D nesting algorithm (guillotine) produces optimal-ish placement

**Success Criteria:**
1. Sheet mode form accepts length and width for cuts
2. Sheet dimensions input supports standard sizes (4x8, 5x5)
3. Grain direction toggle locks cut orientation when enabled
4. Guillotine algorithm places cuts with perpendicular cuts only
5. Visual diagram shows sheet layout with labeled cuts

**Technical Notes:**
- Guillotine nesting algorithm in $lib/server/optimizer/sheet.ts
- Web Worker for algorithm execution (prevent UI freeze)
- Limit to 50 pieces per optimization batch
- SVG visualization with cut labels and dimensions

---

### Phase 21: BOM Integration & Shop Checklist

**Goal**: Cut optimizer integrates with BOMs and provides shop-friendly checklist.
**Depends on**: Phase 20 (requires complete optimizer), Phase 17 (requires BOM dimensions)

**Requirements:**
- CUT-23: User can select a project
- CUT-24: User can multi-select BOMs within selected project
- CUT-25: Selected BOMs auto-filter to lumber items only
- CUT-26: Lumber items pre-populate as cuts with dimensions
- CUT-27: User can view cut list as shop checklist
- CUT-28: User can mark individual cuts as complete
- CUT-29: Checklist shows completion progress indicator
- CUT-30: Checklist completion state persists to project
- CUT-31: User can drag-drop materials to assign stock to cuts
- CUT-32: User can manually override algorithm cut placement

**Success Criteria:**
1. Project dropdown shows user's projects
2. BOM multi-select shows BOMs in selected project
3. Selecting BOMs populates cuts from lumber items only
4. Shop checklist view shows cuts grouped by stock piece
5. Completion checkbox persists and shows progress bar
6. Drag-drop allows manual assignment of cuts to stock
7. Manual override replaces algorithm placement for selected cuts

**Technical Notes:**
- Project/BOM selection fetches from existing tables
- Filter bomItems by category = 'Lumber'
- svelte-dnd-action for drag-drop zones
- cutPatterns table stores completion state
- Override flag on cut placement records

---

## Phase Dependencies

```
Phase 13: RBAC Foundation
    |-- Phase 14: User Management (Admin)
    |-- Phase 15: Email Infrastructure & Password Reset
    |       +-- Phase 16: Email Verification
    +-- Phase 17: BOM Refinements
            +-- Phase 18: Cut Optimizer Foundation
                    +-- Phase 19: Linear Optimizer (1D)
                            +-- Phase 20: Sheet Optimizer (2D)
                                    +-- Phase 21: BOM Integration & Shop Checklist
```

---

## Progress

| Phase | Name | Status | Plans |
|-------|------|--------|-------|
| 13 | RBAC Foundation | ✓ Complete | 2 |
| 14 | User Management (Admin) | ✓ Complete | 3 |
| 15 | Email Infrastructure & Password Reset | ✓ Complete | 2 |
| 16 | Email Verification | ✓ Complete | 2 |
| 17 | BOM Refinements | ✓ Complete | 3 |
| 18 | Cut Optimizer Foundation | Pending | - |
| 19 | Linear Optimizer (1D) | Pending | - |
| 20 | Sheet Optimizer (2D) | Pending | - |
| 21 | BOM Integration & Shop Checklist | Pending | - |

**Requirements Coverage:** 44/44 mapped

---

*Created: 2026-01-29*
*Last updated: 2026-01-29 after phase 17 completion*
