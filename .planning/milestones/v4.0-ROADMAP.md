# Milestone v4.0: BOM Lumber Categorization

**Status:** SHIPPED 2026-02-04
**Phases:** 23-29
**Total Plans:** 11

## Overview

Refactored BOM system with specialized lumber categories (Hardwood Lumber, Common Boards, Sheet Goods), cutItem flag for optimizer integration, required dimensions with admin-managed validation values, and consumables toggle in the BOM wizard.

## Phases

### Phase 23: Schema Foundation

**Goal:** Update database schema and TypeScript types for new category structure and Cut_Item flag.
**Depends on:** v3.0 complete
**Plans:** 2 plans

Plans:
- [x] 23-01: Update TypeScript types, Zod schemas, Drizzle schema, create dimension validation
- [x] 23-02: Remove board feet calculation functions

**Details:**
- BOMCategory type split from single 'lumber' to 'hardwood', 'common', 'sheet' categories
- Database schema updated with cutItem boolean flag and thickness field
- Dimension validation constants created with NHLA hardwood standards, dimensional lumber standards, and plywood standards
- Zod schema synchronized with TypeScript types for AI generation
- Removed calculateBoardFeet and formatBoardFeet functions

---

### Phase 24: Display Updates

**Goal:** Update UI components to handle new categories, remove board feet display, add thickness prefix to names.
**Depends on:** Phase 23
**Plans:** 1 plan

Plans:
- [x] 24-01: Update category configuration, labels, colors, thickness prefix, unit options

**Details:**
- 6 categories displayed: hardwood, common, sheet, hardware, finishes, consumables
- Category labels: "Hardwood Lumber", "Common Boards", "Sheet Goods"
- Color scheme: walnut (hardwood), oak-dark (common), slate (sheet)
- Thickness prefix on lumber names via isLumberCategory() + formatDimension()
- Lumber categories force 'pcs' unit only in AddItemForm

---

### Phase 25: API Validation

**Goal:** Update API endpoints to validate dimensions for lumber items and enforce constraints.
**Depends on:** Phase 23
**Plans:** 2 plans

Plans:
- [x] 25-01: API validation core: bom-validation.ts helper, save/update endpoints
- [x] 25-02: CSV updates: export with CutItem/Thickness, import 6-category fix

**Details:**
- BOM save auto-sets cutItem=true for lumber categories (hardwood/common/sheet)
- Dimension validation returns warnings (does not block save)
- API responses include optional `warnings` array for validation feedback
- CSV export includes CutItem column (Yes/No) and uses Thickness header
- CSV import fixed to accept all 6 categories

---

### Phase 26: AI & Wizard Updates

**Goal:** Update AI prompts for new categories and add consumables toggle to wizard.
**Depends on:** Phase 23, 24
**Plans:** 2 plans

Plans:
- [x] 26-01: Wizard consumables toggle (WIZ-01, WIZ-03)
- [x] 26-02: AI prompt updates for 6 categories and dimensions (AI-01, AI-02, AI-03, WIZ-02)

**Details:**
- AI prompt updated to use 6 categories
- Category assignment guidance added based on wood species
- Dimension requirements (length, width, thickness) required for all lumber items
- AI uses actual dimensions (not nominal): "2x4" = width 3.5, thickness 1.5
- Consumables toggle added to ProjectTypeStep

---

### Phase 27: Cut List Integration

**Goal:** Update cut list optimizer to filter by cutItem flag instead of category.
**Depends on:** Phase 23, 25
**Plans:** 1 plan

Plans:
- [x] 27-01: Update from-bom server and BomSelector for cutItem filtering

**Details:**
- Cut list filter changed from category === 'lumber' to cutItem === true
- Mode detection uses category === 'sheet' (not width-based heuristic)
- Thickness prefix added to stock labels: '0.75" Oak' format
- BomSelector displays "cut item" counts (not "lumber item")

---

### Phase 28: Data Migration

**Goal:** Migrate existing data and ensure all flows work correctly.
**Depends on:** Phase 23-27
**Plans:** 1 plan

Plans:
- [x] 28-01: Create and execute v4.0 data migration script

**Details:**
- Standalone migration script: `scripts/migrate-v4-data.ts`
- MIG-01: All 'lumber' category items migrated to 'hardwood'
- MIG-02: cutItem=true backfilled for all lumber categories
- MIG-03: height values copied to thickness field
- Idempotent design: script safe to re-run

---

### Phase 29: Admin Dimension Management

**Goal:** Allow admin users to manage accepted dimension values for lumber categories.
**Depends on:** Phase 23, 25
**Plans:** 2 plans

Plans:
- [x] 29-01: Database schema with dimensionValues table, startup seeding, async validation
- [x] 29-02: Admin UI for dimension management with view/add/remove/reset

**Details:**
- dimensionValues table: category, dimensionType, value, isDefault, timestamps
- Startup seeding: 41 default values on first request if table empty
- 1-minute TTL cache for dimension validation queries
- Admin UI at /admin/dimensions with view, add, remove, reset functionality
- UserMenu includes "Manage Dimensions" link for admins

---

## Milestone Summary

**Decimal Phases:** None (linear execution)

**Key Decisions:**
- Split lumber into hardwood/common/sheet categories (matches purchasing patterns)
- cutItem flag decouples optimizer from category logic
- Dimension validation warns but allows save (respects user judgment)
- Admin-managed dimension values with database-backed storage
- Actual dimensions only (not nominal) for accuracy
- Consumables toggle gives users control over AI generation scope

**Issues Resolved:**
- Board feet removed (not useful for actual dimension-based workflow)
- Category-based cut list filtering replaced with explicit cutItem flag
- Dimension validation moved from hardcoded constants to admin-managed database

**Issues Deferred:**
- TypeScript interface for cutItem type (boolean | null) - minor type safety issue
- Terminology: some UI still says "lumber items" instead of "cut items"
- Missing VERIFICATION.md for phases 24, 25, 26, 28 (code works, docs missing)

**Technical Debt Incurred:**
- height field still exists in schema (preserved for migration, can be removed later)
- Pre-existing TypeScript errors in cutlist API (unrelated to v4.0)

---

*For current project status, see .planning/ROADMAP.md (created for next milestone)*

---
*Archived: 2026-02-04 as part of v4.0 milestone completion*
