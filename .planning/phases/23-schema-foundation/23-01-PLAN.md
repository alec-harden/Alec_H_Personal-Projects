---
phase: 23-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/types/bom.ts
  - src/lib/server/schemas/bom-schema.ts
  - src/lib/server/schema.ts
  - src/lib/utils/dimension-validation.ts
autonomous: true

must_haves:
  truths:
    - "BOMCategory type includes hardwood, common, sheet (not lumber)"
    - "Database schema has cutItem boolean field"
    - "Database schema has thickness field"
    - "Dimension validation constants are available for import"
  artifacts:
    - path: "src/lib/types/bom.ts"
      provides: "Updated BOMCategory type with 6 categories"
      exports: ["BOMCategory", "LumberCategory", "CATEGORY_ORDER", "isLumberCategory"]
      contains: "hardwood"
    - path: "src/lib/server/schemas/bom-schema.ts"
      provides: "Zod schema with new categories"
      contains: "hardwood"
    - path: "src/lib/server/schema.ts"
      provides: "Drizzle schema with cutItem and thickness"
      contains: "cutItem"
    - path: "src/lib/utils/dimension-validation.ts"
      provides: "Validation constants for lumber dimensions"
      exports: ["HARDWOOD_THICKNESS_VALUES", "COMMON_THICKNESS_VALUES", "SHEET_THICKNESS_VALUES"]
  key_links:
    - from: "src/lib/types/bom.ts"
      to: "src/lib/server/schemas/bom-schema.ts"
      via: "matching category enum values"
      pattern: "hardwood.*common.*sheet"
    - from: "src/lib/types/bom.ts"
      to: "src/lib/server/schema.ts"
      via: "category string values stored in DB"
      pattern: "category.*text"
---

<objective>
Update all type definitions and database schema for v4.0 lumber categorization.

Purpose: Establish the foundation for splitting the single "lumber" category into hardwood, common, and sheet categories, adding cutItem flag for cut list filtering, and adding thickness field with dimension validation.

Output: Updated TypeScript types, Zod schemas, Drizzle schema, and new dimension validation utility.
</objective>

<execution_context>
@C:\Users\wn45mv\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\wn45mv\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-schema-foundation/23-RESEARCH.md

# Source files being modified
@src/lib/types/bom.ts
@src/lib/server/schemas/bom-schema.ts
@src/lib/server/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TypeScript BOM types</name>
  <files>src/lib/types/bom.ts</files>
  <action>
Update the BOMCategory type and BOMItem interface:

1. Replace BOMCategory union type:
   - REMOVE: 'lumber'
   - ADD: 'hardwood', 'common', 'sheet'
   - Final: 'hardwood' | 'common' | 'sheet' | 'hardware' | 'finishes' | 'consumables'

2. Add new types and exports:
   - Add `LumberCategory` type: 'hardwood' | 'common' | 'sheet'
   - Add `CATEGORY_ORDER` const array: ['hardwood', 'common', 'sheet', 'hardware', 'finishes', 'consumables']
   - Add `isLumberCategory(category: BOMCategory): category is LumberCategory` type guard function

3. Update BOMItem interface:
   - Add `cutItem?: boolean` field with JSDoc comment about cut list eligibility
   - Add `thickness?: number` field with JSDoc comment (inches)
   - Mark `height?: number` as @deprecated with migration note

Keep all other fields unchanged. Add JSDoc comments explaining the v4.0 category split.
  </action>
  <verify>Run `npm run check` - TypeScript compilation must pass with no errors related to BOMCategory</verify>
  <done>BOMCategory type has 6 values (hardwood, common, sheet, hardware, finishes, consumables), LumberCategory and isLumberCategory helper exported, BOMItem has cutItem and thickness fields</done>
</task>

<task type="auto">
  <name>Task 2: Update Zod schema for AI generation</name>
  <files>src/lib/server/schemas/bom-schema.ts</files>
  <action>
Update the bomItemSchema to match new categories:

1. Update the category enum in bomItemSchema:
   - CHANGE: z.enum(['lumber', 'hardware', 'finishes', 'consumables'])
   - TO: z.enum(['hardwood', 'common', 'sheet', 'hardware', 'finishes', 'consumables'])

2. Add new fields to bomItemSchema:
   - Add `length: z.number().optional().describe('Length in inches')`
   - Add `width: z.number().optional().describe('Width in inches')`
   - Add `thickness: z.number().optional().describe('Thickness in inches')`

The schema is used for AI-generated BOM validation. The category enum values MUST match the TypeScript BOMCategory type exactly.
  </action>
  <verify>Run `npm run check` - no type errors in bom-schema.ts</verify>
  <done>bomItemSchema has 6-value category enum matching BOMCategory type, includes length/width/thickness optional fields</done>
</task>

<task type="auto">
  <name>Task 3: Update Drizzle database schema</name>
  <files>src/lib/server/schema.ts</files>
  <action>
Update the bomItems table definition:

1. Add cutItem field after the hidden field:
   ```typescript
   cutItem: integer('cut_item', { mode: 'boolean' }).notNull().default(false),
   ```

2. Add thickness field after height field (keep height for Phase 28 migration):
   ```typescript
   thickness: real('thickness'), // inches - v4.0: renamed from height
   ```

3. Add comment above height field marking it as deprecated:
   ```typescript
   // DEPRECATED: Use thickness instead. Kept for Phase 28 migration.
   height: real('height'), // inches (thickness)
   ```

DO NOT remove or rename the height column - data migration happens in Phase 28.
After modifying schema.ts, run `npm run db:push` to sync schema to local database.
  </action>
  <verify>Run `npm run db:push` - schema syncs without errors. Run `npm run check` - no TypeScript errors.</verify>
  <done>bomItems table has cutItem (boolean, default false) and thickness (real, nullable) fields, height field preserved with deprecation comment</done>
</task>

<task type="auto">
  <name>Task 4: Create dimension validation constants</name>
  <files>src/lib/utils/dimension-validation.ts</files>
  <action>
Create NEW file `src/lib/utils/dimension-validation.ts` with validation constants:

1. Add tolerance constant:
   ```typescript
   export const DIMENSION_TOLERANCE = 0.015625; // 1/64" for floating point comparison
   ```

2. Add thickness constants (as readonly arrays):
   - HARDWOOD_THICKNESS_VALUES: [0.75, 0.8125, 1.0, 1.0625, 1.25, 1.5, 1.75, 2.0, 2.75, 3.0, 3.75, 4.0]
   - COMMON_THICKNESS_VALUES: [0.75, 1.5]
   - SHEET_THICKNESS_VALUES: [0.125, 0.1875, 0.25, 0.3125, 0.34375, 0.375, 0.46875, 0.5, 0.59375, 0.625, 0.71875, 0.75, 1.0, 1.125]

3. Add width/length constants:
   - COMMON_WIDTH_VALUES: [1.5, 2.5, 3.5, 5.5, 7.25, 9.25, 11.25]
   - SHEET_WIDTH_VALUES: [24, 48, 60]
   - SHEET_LENGTH_VALUES: [48, 96, 120]

4. Add helper functions:
   - `getThicknessValues(category: LumberCategory): readonly number[]`
   - `isStandardValue(value: number, standards: readonly number[]): boolean`
   - `validateThickness(value: number, category: LumberCategory): string | null`

Import `LumberCategory` type from '../types/bom' for type safety.

See 23-RESEARCH.md for exact constant values and function implementations.
  </action>
  <verify>Run `npm run check` - no errors. Import the module in a test: `import { HARDWOOD_THICKNESS_VALUES } from '$lib/utils/dimension-validation'`</verify>
  <done>dimension-validation.ts exists with all thickness/width/length constants and helper functions exported</done>
</task>

</tasks>

<verification>
1. `npm run check` passes with no type errors
2. `npm run db:push` completes successfully
3. All new exports are importable:
   - `import { BOMCategory, LumberCategory, isLumberCategory, CATEGORY_ORDER } from '$lib/types/bom'`
   - `import { HARDWOOD_THICKNESS_VALUES, validateThickness } from '$lib/utils/dimension-validation'`
4. Database has new columns (verify with `npm run db:studio` if needed)
</verification>

<success_criteria>
1. TypeScript compilation passes
2. BOMCategory no longer includes 'lumber'
3. BOMCategory includes 'hardwood', 'common', 'sheet'
4. bomItems schema has cutItem and thickness columns
5. dimension-validation.ts exports validation constants
6. Zod schema matches TypeScript types
</success_criteria>

<output>
After completion, create `.planning/phases/23-schema-foundation/23-01-SUMMARY.md`
</output>
