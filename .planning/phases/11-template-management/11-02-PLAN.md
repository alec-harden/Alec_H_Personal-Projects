---
phase: 11-template-management
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/routes/api/templates/+server.ts
  - src/lib/components/bom/BOMWizard.svelte
  - src/lib/components/bom/ProjectTypeStep.svelte
  - src/lib/components/bom/DimensionsStep.svelte
  - src/lib/components/bom/JoineryStep.svelte
  - src/lib/components/bom/MaterialsStep.svelte
  - src/routes/api/bom/generate/+server.ts
  - src/lib/data/templates.ts
autonomous: true

must_haves:
  truths:
    - "BOM wizard loads templates from database via API"
    - "Template changes in database appear in wizard without restart"
    - "All wizard steps work with database-sourced templates"
  artifacts:
    - path: "src/routes/api/templates/+server.ts"
      provides: "GET endpoint for templates"
      exports: ["GET"]
    - path: "src/lib/data/templates.ts"
      provides: "Type definitions only (no hardcoded data)"
      contains: "export interface ProjectTemplate"
  key_links:
    - from: "src/lib/components/bom/BOMWizard.svelte"
      to: "/api/templates"
      via: "fetch call"
      pattern: "fetch.*api/templates"
    - from: "src/routes/api/templates/+server.ts"
      to: "src/lib/server/schema.ts"
      via: "database query"
      pattern: "db\\.query\\.templates"
---

<objective>
Update BOM wizard to load templates from database instead of hardcoded imports.

Purpose: Connects the BOM wizard to database-backed templates so admin changes take effect immediately. This is the consumer side of TMPL-01.

Output: API endpoint for templates, wizard components updated to fetch from database, templates.ts reduced to type definitions only.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-template-management/11-RESEARCH.md
@.planning/phases/11-template-management/11-01-SUMMARY.md
@src/lib/components/bom/BOMWizard.svelte
@src/lib/components/bom/ProjectTypeStep.svelte
@src/lib/data/templates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create templates API endpoint</name>
  <files>src/routes/api/templates/+server.ts</files>
  <action>
Create GET endpoint that returns all templates from database:

```typescript
import { json } from '@sveltejs/kit';
import type { RequestHandler } from './$types';
import { db } from '$lib/server/db';
import { templates } from '$lib/server/schema';
import { asc } from 'drizzle-orm';

export const GET: RequestHandler = async () => {
  const allTemplates = await db.query.templates.findMany({
    orderBy: [asc(templates.name)]
  });

  return json(allTemplates);
};
```

This endpoint is public (no auth required) - templates are shared data needed for BOM generation whether logged in or not.
  </action>
  <verify>
`curl http://localhost:5173/api/templates` returns JSON array with 5 templates.
  </verify>
  <done>GET /api/templates returns all templates from database ordered by name</done>
</task>

<task type="auto">
  <name>Task 2: Update templates.ts to types-only</name>
  <files>src/lib/data/templates.ts</files>
  <action>
Refactor templates.ts to export only type definitions:

1. Keep all interface exports:
   - JoineryOption
   - ProjectTemplate (rename DimensionRange to internal if not used elsewhere)

2. Remove the hardcoded `templates` array (the const array of 5 templates)

3. Keep helper functions but update them to accept templates as parameter:
   - getTemplateById(templates: ProjectTemplate[], id: string) - or remove if not used
   - createDefaultDetails(template: ProjectTemplate) - keep as-is

4. Add deprecation comment noting templates now come from database:
```typescript
/**
 * Project Template Types
 *
 * NOTE: Template DATA now lives in database. Use /api/templates endpoint.
 * This file contains only type definitions and utility functions.
 */
```

Search codebase for any direct imports of the `templates` array and note them - they will be updated in next task.
  </action>
  <verify>
`npm run check` passes - no type errors from removed array.
Grep for "from '\$lib/data/templates'" shows files but array import will fail if used.
  </verify>
  <done>templates.ts exports types only, hardcoded array removed, utility functions updated</done>
</task>

<task type="auto">
  <name>Task 3: Update BOM wizard to fetch from API</name>
  <files>
    src/lib/components/bom/BOMWizard.svelte
    src/lib/components/bom/ProjectTypeStep.svelte
    src/lib/components/bom/DimensionsStep.svelte
    src/lib/components/bom/JoineryStep.svelte
    src/lib/components/bom/MaterialsStep.svelte
    src/routes/api/bom/generate/+server.ts
  </files>
  <action>
Update all wizard components to receive templates as a prop instead of importing directly:

1. **BOMWizard.svelte** (parent):
   - Add templates state: `let templates = $state<ProjectTemplate[]>([])`
   - Add loading state for templates
   - Fetch templates on mount: `onMount(async () => { templates = await fetch('/api/templates').then(r => r.json()); })`
   - Pass templates as prop to child steps: `<ProjectTypeStep {templates} ... />`

2. **ProjectTypeStep.svelte**:
   - Remove import of templates array
   - Add prop: `templates: ProjectTemplate[]`
   - Use prop instead of imported array

3. **DimensionsStep.svelte**:
   - Remove import of templates array (uses getTemplateById)
   - Add prop: `templates: ProjectTemplate[]`
   - Update getTemplateById call to use templates prop

4. **JoineryStep.svelte**:
   - Remove import of templates array (uses getTemplateById)
   - Add prop: `templates: ProjectTemplate[]`
   - Update to use templates prop

5. **MaterialsStep.svelte**:
   - Remove import of templates array (uses getTemplateById)
   - Add prop: `templates: ProjectTemplate[]`
   - Update to use templates prop

6. **api/bom/generate/+server.ts**:
   - Instead of importing templates array, query database
   - Use db.query.templates.findFirst({ where: eq(templates.id, projectType) })
   - This ensures AI generation uses the same templates as UI

Pattern for child components:
```svelte
<script lang="ts">
  import type { ProjectTemplate } from '$lib/data/templates';

  interface Props {
    templates: ProjectTemplate[];
    // ... other existing props
  }

  let { templates, ...otherProps }: Props = $props();

  // Replace: import { templates } from '$lib/data/templates';
  // Use templates prop instead
</script>
```

Important: Keep the type imports from templates.ts - only remove the data import.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Navigate to /bom/new
3. Verify all 5 templates appear in project type selection
4. Select a template, verify dimensions/joinery/materials steps work
5. Complete wizard and generate BOM - verify it generates correctly
  </verify>
  <done>BOM wizard fetches templates from API, all steps receive templates as props, generation uses database templates</done>
</task>

</tasks>

<verification>
1. `npm run check` passes (no type errors)
2. `npm run dev` starts without errors
3. /api/templates returns 5 templates as JSON
4. BOM wizard displays all templates from database
5. Full wizard flow works: type selection -> dimensions -> joinery -> materials -> generate
6. Generated BOM uses correct template data from database
</verification>

<success_criteria>
- GET /api/templates endpoint exists and returns database templates
- templates.ts contains only types, no hardcoded array
- BOM wizard fetches templates on mount
- All wizard steps work with database-sourced templates
- BOM generation uses database templates
</success_criteria>

<output>
After completion, create `.planning/phases/11-template-management/11-02-SUMMARY.md`
</output>
