---
phase: 11-template-management
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/routes/admin/templates/+page.server.ts
  - src/routes/admin/templates/+page.svelte
autonomous: true

must_haves:
  truths:
    - "User can view list of all templates at /admin/templates"
    - "User can create a new template via form submission"
    - "Unauthenticated users are redirected to login"
  artifacts:
    - path: "src/routes/admin/templates/+page.server.ts"
      provides: "Load function and create action"
      exports: ["load", "actions"]
    - path: "src/routes/admin/templates/+page.svelte"
      provides: "Template list and create form UI"
      contains: "form method=\"POST\""
  key_links:
    - from: "src/routes/admin/templates/+page.server.ts"
      to: "locals.user"
      via: "auth check in load AND actions"
      pattern: "if \\(!locals\\.user\\)"
    - from: "src/routes/admin/templates/+page.svelte"
      to: "src/routes/admin/templates/+page.server.ts"
      via: "form submission"
      pattern: "action=\"\\?/create\""
---

<objective>
Create admin templates list page with ability to add new templates.

Purpose: Fulfills TMPL-02 (view templates) and TMPL-03 (add template). Admin UI for managing templates.

Output: /admin/templates route with list view and create form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-template-management/11-RESEARCH.md
@.planning/phases/11-template-management/11-01-SUMMARY.md
@src/routes/projects/+page.server.ts
@src/routes/projects/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin templates list with server load</name>
  <files>src/routes/admin/templates/+page.server.ts</files>
  <action>
Create +page.server.ts with load function and create action:

```typescript
import { fail, redirect } from '@sveltejs/kit';
import type { PageServerLoad, Actions } from './$types';
import { db } from '$lib/server/db';
import { templates } from '$lib/server/schema';
import { asc } from 'drizzle-orm';

export const load: PageServerLoad = async ({ locals }) => {
  // Require authentication
  if (!locals.user) {
    throw redirect(302, '/auth/login?redirect=/admin/templates');
  }

  const allTemplates = await db.query.templates.findMany({
    orderBy: [asc(templates.name)]
  });

  return { templates: allTemplates };
};

export const actions: Actions = {
  create: async ({ request, locals }) => {
    // Auth check in action too (load check doesn't protect actions)
    if (!locals.user) {
      throw redirect(302, '/auth/login');
    }

    const data = await request.formData();
    const name = data.get('name')?.toString().trim();
    const icon = data.get('icon')?.toString().trim();
    const description = data.get('description')?.toString().trim();

    // Validation
    if (!name || name.length < 1) {
      return fail(400, { error: 'Template name is required', name: '' });
    }

    if (!icon) {
      return fail(400, { error: 'Icon is required (HTML entity like &#128736;)', name });
    }

    // Parse dimensions
    const defaultDimensions = {
      length: {
        min: Number(data.get('length_min')) || 12,
        max: Number(data.get('length_max')) || 72,
        default: Number(data.get('length_default')) || 36
      },
      width: {
        min: Number(data.get('width_min')) || 12,
        max: Number(data.get('width_max')) || 48,
        default: Number(data.get('width_default')) || 24
      },
      height: data.get('has_height') === 'on' ? {
        min: Number(data.get('height_min')) || 12,
        max: Number(data.get('height_max')) || 48,
        default: Number(data.get('height_default')) || 30
      } : undefined,
      unit: 'inches' as const
    };

    // Parse comma-separated string arrays
    const parseList = (input: string | null) =>
      input?.split(',').map(s => s.trim()).filter(Boolean) || [];

    const suggestedWoods = parseList(data.get('suggested_woods')?.toString());
    const suggestedFinishes = parseList(data.get('suggested_finishes')?.toString());
    const typicalHardware = parseList(data.get('typical_hardware')?.toString());

    // Parse joinery options (indexed form fields)
    const joineryOptions: Array<{
      id: string;
      name: string;
      description: string;
      difficulty: 'beginner' | 'intermediate' | 'advanced';
    }> = [];

    let i = 0;
    while (data.get(`joinery_${i}_id`) !== null) {
      const joineryId = data.get(`joinery_${i}_id`)?.toString().trim();
      const joineryName = data.get(`joinery_${i}_name`)?.toString().trim();

      if (joineryId && joineryName) {
        joineryOptions.push({
          id: joineryId,
          name: joineryName,
          description: data.get(`joinery_${i}_description`)?.toString().trim() || '',
          difficulty: (data.get(`joinery_${i}_difficulty`)?.toString() as any) || 'beginner'
        });
      }
      i++;
    }

    const id = crypto.randomUUID();
    const now = new Date();

    await db.insert(templates).values({
      id,
      name,
      icon,
      description: description || '',
      defaultDimensions,
      joineryOptions,
      suggestedWoods,
      suggestedFinishes,
      typicalHardware,
      createdAt: now,
      updatedAt: now
    });

    throw redirect(302, `/admin/templates/${id}`);
  }
};
```

Key patterns:
- Auth check in BOTH load AND actions
- Comma-separated inputs for simple arrays (woods, finishes, hardware)
- Indexed fields for joinery options array
- UUID generation for new template ID
- PRG pattern: redirect after create
  </action>
  <verify>TypeScript compiles: `npm run check`</verify>
  <done>+page.server.ts with load function returning templates and create action handling form submission</done>
</task>

<task type="auto">
  <name>Task 2: Create admin templates list UI</name>
  <files>src/routes/admin/templates/+page.svelte</files>
  <action>
Create +page.svelte with template list and create form:

```svelte
<script lang="ts">
  import { enhance } from '$app/forms';
  import type { PageData, ActionData } from './$types';

  let { data, form }: { data: PageData; form: ActionData } = $props();

  let showCreateForm = $state(false);
  let loading = $state(false);

  // Dynamic joinery options for create form
  let joineryOptions = $state<Array<{
    id: string;
    name: string;
    description: string;
    difficulty: string;
  }>>([]);

  function addJoineryOption() {
    joineryOptions = [...joineryOptions, {
      id: '',
      name: '',
      description: '',
      difficulty: 'beginner'
    }];
  }

  function removeJoineryOption(index: number) {
    joineryOptions = joineryOptions.filter((_, i) => i !== index);
  }
</script>

<svelte:head>
  <title>Templates | Admin | WoodShop Toolbox</title>
</svelte:head>

<div class="max-w-4xl mx-auto p-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-amber-900">Project Templates</h1>
    <button
      onclick={() => showCreateForm = !showCreateForm}
      class="px-4 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800"
    >
      {showCreateForm ? 'Cancel' : 'New Template'}
    </button>
  </div>

  {#if form?.error}
    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
      {form.error}
    </div>
  {/if}

  {#if showCreateForm}
    <div class="mb-8 p-6 bg-amber-50 border border-amber-200 rounded-lg">
      <h2 class="text-lg font-semibold mb-4">Create New Template</h2>

      <form
        method="POST"
        action="?/create"
        use:enhance={() => {
          loading = true;
          return async ({ update }) => {
            await update();
            loading = false;
          };
        }}
        class="space-y-4"
      >
        <!-- Basic Info -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">
              Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              name="name"
              required
              class="w-full px-3 py-2 border rounded-lg"
              placeholder="e.g., Table"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">
              Icon (HTML entity) <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              name="icon"
              required
              class="w-full px-3 py-2 border rounded-lg"
              placeholder="e.g., &#128437;"
            />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Description</label>
          <textarea
            name="description"
            rows="2"
            class="w-full px-3 py-2 border rounded-lg"
            placeholder="Brief description of this project type"
          ></textarea>
        </div>

        <!-- Dimensions -->
        <fieldset class="border p-4 rounded-lg">
          <legend class="font-medium px-2">Dimensions (inches)</legend>

          <div class="grid grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-xs text-gray-600 mb-1">Length</label>
              <div class="flex gap-2">
                <input type="number" name="length_min" placeholder="Min" class="w-16 px-2 py-1 border rounded text-sm" />
                <input type="number" name="length_default" placeholder="Default" class="w-16 px-2 py-1 border rounded text-sm" />
                <input type="number" name="length_max" placeholder="Max" class="w-16 px-2 py-1 border rounded text-sm" />
              </div>
            </div>
            <div>
              <label class="block text-xs text-gray-600 mb-1">Width</label>
              <div class="flex gap-2">
                <input type="number" name="width_min" placeholder="Min" class="w-16 px-2 py-1 border rounded text-sm" />
                <input type="number" name="width_default" placeholder="Default" class="w-16 px-2 py-1 border rounded text-sm" />
                <input type="number" name="width_max" placeholder="Max" class="w-16 px-2 py-1 border rounded text-sm" />
              </div>
            </div>
            <div>
              <label class="flex items-center gap-2 text-xs text-gray-600 mb-1">
                <input type="checkbox" name="has_height" />
                Height (optional)
              </label>
              <div class="flex gap-2">
                <input type="number" name="height_min" placeholder="Min" class="w-16 px-2 py-1 border rounded text-sm" />
                <input type="number" name="height_default" placeholder="Default" class="w-16 px-2 py-1 border rounded text-sm" />
                <input type="number" name="height_max" placeholder="Max" class="w-16 px-2 py-1 border rounded text-sm" />
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Joinery Options -->
        <fieldset class="border p-4 rounded-lg">
          <legend class="font-medium px-2">Joinery Options</legend>

          {#each joineryOptions as option, i}
            <div class="flex gap-2 mb-2 items-start">
              <input
                type="text"
                name="joinery_{i}_id"
                bind:value={option.id}
                placeholder="ID (e.g., mortise-tenon)"
                class="flex-1 px-2 py-1 border rounded text-sm"
              />
              <input
                type="text"
                name="joinery_{i}_name"
                bind:value={option.name}
                placeholder="Name"
                class="flex-1 px-2 py-1 border rounded text-sm"
              />
              <input
                type="text"
                name="joinery_{i}_description"
                bind:value={option.description}
                placeholder="Description"
                class="flex-2 px-2 py-1 border rounded text-sm"
              />
              <select
                name="joinery_{i}_difficulty"
                bind:value={option.difficulty}
                class="px-2 py-1 border rounded text-sm"
              >
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
              </select>
              <button
                type="button"
                onclick={() => removeJoineryOption(i)}
                class="px-2 py-1 text-red-600 hover:bg-red-50 rounded"
              >
                Remove
              </button>
            </div>
          {/each}

          <button
            type="button"
            onclick={addJoineryOption}
            class="text-sm text-amber-700 hover:text-amber-800"
          >
            + Add Joinery Option
          </button>
        </fieldset>

        <!-- Suggestions -->
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Suggested Woods</label>
            <input
              type="text"
              name="suggested_woods"
              class="w-full px-3 py-2 border rounded-lg text-sm"
              placeholder="oak, walnut, maple"
            />
            <p class="text-xs text-gray-500 mt-1">Comma-separated</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Suggested Finishes</label>
            <input
              type="text"
              name="suggested_finishes"
              class="w-full px-3 py-2 border rounded-lg text-sm"
              placeholder="polyurethane, danish oil"
            />
            <p class="text-xs text-gray-500 mt-1">Comma-separated</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Typical Hardware</label>
            <input
              type="text"
              name="typical_hardware"
              class="w-full px-3 py-2 border rounded-lg text-sm"
              placeholder="hinges, drawer slides"
            />
            <p class="text-xs text-gray-500 mt-1">Comma-separated</p>
          </div>
        </div>

        <div class="flex justify-end gap-2 pt-4">
          <button
            type="button"
            onclick={() => showCreateForm = false}
            class="px-4 py-2 border rounded-lg hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            type="submit"
            disabled={loading}
            class="px-4 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800 disabled:opacity-50"
          >
            {loading ? 'Creating...' : 'Create Template'}
          </button>
        </div>
      </form>
    </div>
  {/if}

  <!-- Template List -->
  <div class="space-y-4">
    {#each data.templates as template}
      <a
        href="/admin/templates/{template.id}"
        class="block p-4 border rounded-lg hover:bg-amber-50 hover:border-amber-300 transition-colors"
      >
        <div class="flex items-center gap-4">
          <span class="text-3xl" aria-hidden="true">{@html template.icon}</span>
          <div class="flex-1">
            <h3 class="font-semibold text-lg">{template.name}</h3>
            <p class="text-gray-600 text-sm">{template.description}</p>
          </div>
          <div class="text-right text-sm text-gray-500">
            <div>{template.joineryOptions.length} joinery options</div>
            <div>{template.suggestedWoods.length} wood types</div>
          </div>
        </div>
      </a>
    {:else}
      <div class="text-center py-12 text-gray-500">
        <p>No templates yet.</p>
        <button
          onclick={() => showCreateForm = true}
          class="mt-2 text-amber-700 hover:text-amber-800"
        >
          Create your first template
        </button>
      </div>
    {/each}
  </div>

  <div class="mt-6">
    <a href="/" class="text-amber-700 hover:text-amber-800">&larr; Back to Dashboard</a>
  </div>
</div>
```

Key UI patterns:
- Toggle form visibility (not always shown)
- Progressive enhancement with use:enhance
- Loading state during submission
- Dynamic joinery options array
- Comma-separated inputs for simple arrays
- List links to detail/edit page
- Error display from form action
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Navigate to /admin/templates (should redirect to login if not authenticated)
3. Log in, then access /admin/templates
4. Verify list shows existing 5 templates
5. Click "New Template", fill form, submit
6. Verify redirect to new template detail page
  </verify>
  <done>Admin templates list page displays all templates, create form works with all fields including dynamic joinery options</done>
</task>

</tasks>

<verification>
1. `npm run check` passes
2. /admin/templates requires authentication (redirects to login)
3. Template list displays all templates from database
4. Create form validates required fields (name, icon)
5. New template created successfully redirects to detail page
6. New template appears in list and in BOM wizard
</verification>

<success_criteria>
- /admin/templates route exists with auth protection
- Load function returns all templates ordered by name
- Create action validates, inserts, and redirects
- UI displays template list with icons, descriptions, counts
- Create form handles all fields including dynamic joinery array
- TMPL-02 (view templates) complete
- TMPL-03 (add template) complete
</success_criteria>

<output>
After completion, create `.planning/phases/11-template-management/11-03-SUMMARY.md`
</output>
