---
phase: 11-template-management
plan: 04
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - src/routes/admin/templates/[id]/+page.server.ts
  - src/routes/admin/templates/[id]/+page.svelte
autonomous: true

must_haves:
  truths:
    - "User can view a single template's details"
    - "User can edit any field of a template"
    - "User can delete a template with confirmation"
    - "Unauthenticated users are redirected to login"
  artifacts:
    - path: "src/routes/admin/templates/[id]/+page.server.ts"
      provides: "Load, update, and delete actions"
      exports: ["load", "actions"]
    - path: "src/routes/admin/templates/[id]/+page.svelte"
      provides: "Edit form and delete button UI"
      contains: "action=\"?/delete\""
  key_links:
    - from: "src/routes/admin/templates/[id]/+page.server.ts"
      to: "locals.user"
      via: "auth check in load AND all actions"
      pattern: "if \\(!locals\\.user\\)"
    - from: "src/routes/admin/templates/[id]/+page.svelte"
      to: "window.confirm"
      via: "delete confirmation dialog"
      pattern: "confirm\\("
---

<objective>
Create admin template detail page with edit and delete functionality.

Purpose: Fulfills TMPL-04 (edit template) and TMPL-05 (delete template). Completes the admin CRUD for templates.

Output: /admin/templates/[id] route with edit form and delete button.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-template-management/11-RESEARCH.md
@.planning/phases/11-template-management/11-03-SUMMARY.md
@src/routes/projects/[id]/+page.server.ts
@src/routes/projects/[id]/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template detail page server</name>
  <files>src/routes/admin/templates/[id]/+page.server.ts</files>
  <action>
Create +page.server.ts with load, update, and delete actions:

```typescript
import { error, fail, redirect } from '@sveltejs/kit';
import type { PageServerLoad, Actions } from './$types';
import { db } from '$lib/server/db';
import { templates } from '$lib/server/schema';
import { eq } from 'drizzle-orm';

export const load: PageServerLoad = async ({ locals, params }) => {
  if (!locals.user) {
    throw redirect(302, `/auth/login?redirect=/admin/templates/${params.id}`);
  }

  const template = await db.query.templates.findFirst({
    where: eq(templates.id, params.id)
  });

  if (!template) {
    throw error(404, 'Template not found');
  }

  return { template };
};

export const actions: Actions = {
  update: async ({ request, locals, params }) => {
    if (!locals.user) {
      throw redirect(302, '/auth/login');
    }

    const data = await request.formData();
    const name = data.get('name')?.toString().trim();
    const icon = data.get('icon')?.toString().trim();
    const description = data.get('description')?.toString().trim();

    // Validation
    if (!name || name.length < 1) {
      return fail(400, { error: 'Template name is required' });
    }

    if (!icon) {
      return fail(400, { error: 'Icon is required' });
    }

    // Parse dimensions
    const defaultDimensions = {
      length: {
        min: Number(data.get('length_min')) || 12,
        max: Number(data.get('length_max')) || 72,
        default: Number(data.get('length_default')) || 36
      },
      width: {
        min: Number(data.get('width_min')) || 12,
        max: Number(data.get('width_max')) || 48,
        default: Number(data.get('width_default')) || 24
      },
      height: data.get('has_height') === 'on' ? {
        min: Number(data.get('height_min')) || 12,
        max: Number(data.get('height_max')) || 48,
        default: Number(data.get('height_default')) || 30
      } : undefined,
      unit: 'inches' as const
    };

    // Parse comma-separated string arrays
    const parseList = (input: string | null) =>
      input?.split(',').map(s => s.trim()).filter(Boolean) || [];

    const suggestedWoods = parseList(data.get('suggested_woods')?.toString());
    const suggestedFinishes = parseList(data.get('suggested_finishes')?.toString());
    const typicalHardware = parseList(data.get('typical_hardware')?.toString());

    // Parse joinery options
    const joineryOptions: Array<{
      id: string;
      name: string;
      description: string;
      difficulty: 'beginner' | 'intermediate' | 'advanced';
    }> = [];

    let i = 0;
    while (data.get(`joinery_${i}_id`) !== null) {
      const joineryId = data.get(`joinery_${i}_id`)?.toString().trim();
      const joineryName = data.get(`joinery_${i}_name`)?.toString().trim();

      if (joineryId && joineryName) {
        joineryOptions.push({
          id: joineryId,
          name: joineryName,
          description: data.get(`joinery_${i}_description`)?.toString().trim() || '',
          difficulty: (data.get(`joinery_${i}_difficulty`)?.toString() as any) || 'beginner'
        });
      }
      i++;
    }

    await db.update(templates)
      .set({
        name,
        icon,
        description: description || '',
        defaultDimensions,
        joineryOptions,
        suggestedWoods,
        suggestedFinishes,
        typicalHardware,
        updatedAt: new Date()
      })
      .where(eq(templates.id, params.id));

    return { success: true };
  },

  delete: async ({ locals, params }) => {
    if (!locals.user) {
      throw redirect(302, '/auth/login');
    }

    await db.delete(templates).where(eq(templates.id, params.id));

    throw redirect(302, '/admin/templates');
  }
};
```

Key patterns:
- Auth check in load AND both actions
- 404 error if template not found
- Update sets updatedAt timestamp
- Delete redirects to list (PRG pattern)
- Same parsing logic as create action
  </action>
  <verify>TypeScript compiles: `npm run check`</verify>
  <done>+page.server.ts with load returning template, update action modifying all fields, delete action removing template</done>
</task>

<task type="auto">
  <name>Task 2: Create template edit/delete UI</name>
  <files>src/routes/admin/templates/[id]/+page.svelte</files>
  <action>
Create +page.svelte with edit form and delete functionality:

```svelte
<script lang="ts">
  import { enhance } from '$app/forms';
  import { goto } from '$app/navigation';
  import type { PageData, ActionData } from './$types';

  let { data, form }: { data: PageData; form: ActionData } = $props();

  let loading = $state(false);
  let showSuccess = $state(false);

  // Reactive copy of joinery options for editing
  let joineryOptions = $state([...data.template.joineryOptions]);

  // Handle success feedback
  $effect(() => {
    if (form?.success) {
      showSuccess = true;
      setTimeout(() => showSuccess = false, 3000);
    }
  });

  function addJoineryOption() {
    joineryOptions = [...joineryOptions, {
      id: '',
      name: '',
      description: '',
      difficulty: 'beginner' as const
    }];
  }

  function removeJoineryOption(index: number) {
    joineryOptions = joineryOptions.filter((_, i) => i !== index);
  }

  function handleDelete() {
    if (confirm(`Delete template "${data.template.name}"? This cannot be undone.`)) {
      // Form will be submitted by the button
      return true;
    }
    return false;
  }
</script>

<svelte:head>
  <title>{data.template.name} | Templates | Admin</title>
</svelte:head>

<div class="max-w-4xl mx-auto p-6">
  <div class="mb-6">
    <a href="/admin/templates" class="text-amber-700 hover:text-amber-800">
      &larr; Back to Templates
    </a>
  </div>

  <div class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-4">
      <span class="text-4xl" aria-hidden="true">{@html data.template.icon}</span>
      <h1 class="text-2xl font-bold text-amber-900">{data.template.name}</h1>
    </div>

    <!-- Delete Form -->
    <form
      method="POST"
      action="?/delete"
      onsubmit={handleDelete}
    >
      <button
        type="submit"
        class="px-4 py-2 text-red-600 border border-red-300 rounded-lg hover:bg-red-50"
      >
        Delete Template
      </button>
    </form>
  </div>

  {#if form?.error}
    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
      {form.error}
    </div>
  {/if}

  {#if showSuccess}
    <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700">
      Template updated successfully!
    </div>
  {/if}

  <!-- Edit Form -->
  <form
    method="POST"
    action="?/update"
    use:enhance={() => {
      loading = true;
      return async ({ update }) => {
        await update();
        loading = false;
      };
    }}
    class="space-y-6"
  >
    <!-- Basic Info -->
    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-lg font-semibold mb-4">Basic Information</h2>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">
            Name <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="name"
            value={data.template.name}
            required
            class="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">
            Icon (HTML entity) <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="icon"
            value={data.template.icon}
            required
            class="w-full px-3 py-2 border rounded-lg"
          />
        </div>
      </div>

      <div class="mt-4">
        <label class="block text-sm font-medium mb-1">Description</label>
        <textarea
          name="description"
          rows="2"
          class="w-full px-3 py-2 border rounded-lg"
        >{data.template.description}</textarea>
      </div>
    </div>

    <!-- Dimensions -->
    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-lg font-semibold mb-4">Dimensions (inches)</h2>

      <div class="grid grid-cols-3 gap-6">
        <div>
          <label class="block text-sm font-medium mb-2">Length</label>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500 w-12">Min</span>
              <input type="number" name="length_min" value={data.template.defaultDimensions.length.min} class="flex-1 px-2 py-1 border rounded" />
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500 w-12">Default</span>
              <input type="number" name="length_default" value={data.template.defaultDimensions.length.default} class="flex-1 px-2 py-1 border rounded" />
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500 w-12">Max</span>
              <input type="number" name="length_max" value={data.template.defaultDimensions.length.max} class="flex-1 px-2 py-1 border rounded" />
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Width</label>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500 w-12">Min</span>
              <input type="number" name="width_min" value={data.template.defaultDimensions.width.min} class="flex-1 px-2 py-1 border rounded" />
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500 w-12">Default</span>
              <input type="number" name="width_default" value={data.template.defaultDimensions.width.default} class="flex-1 px-2 py-1 border rounded" />
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500 w-12">Max</span>
              <input type="number" name="width_max" value={data.template.defaultDimensions.width.max} class="flex-1 px-2 py-1 border rounded" />
            </div>
          </div>
        </div>

        <div>
          <label class="flex items-center gap-2 text-sm font-medium mb-2">
            <input
              type="checkbox"
              name="has_height"
              checked={!!data.template.defaultDimensions.height}
            />
            Height (optional)
          </label>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500 w-12">Min</span>
              <input type="number" name="height_min" value={data.template.defaultDimensions.height?.min ?? 12} class="flex-1 px-2 py-1 border rounded" />
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500 w-12">Default</span>
              <input type="number" name="height_default" value={data.template.defaultDimensions.height?.default ?? 30} class="flex-1 px-2 py-1 border rounded" />
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500 w-12">Max</span>
              <input type="number" name="height_max" value={data.template.defaultDimensions.height?.max ?? 48} class="flex-1 px-2 py-1 border rounded" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Joinery Options -->
    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-lg font-semibold mb-4">Joinery Options</h2>

      <div class="space-y-3">
        {#each joineryOptions as option, i}
          <div class="flex gap-2 items-start p-3 bg-gray-50 rounded-lg">
            <div class="flex-1 grid grid-cols-4 gap-2">
              <input
                type="text"
                name="joinery_{i}_id"
                bind:value={option.id}
                placeholder="ID (e.g., mortise-tenon)"
                class="px-2 py-1 border rounded text-sm"
              />
              <input
                type="text"
                name="joinery_{i}_name"
                bind:value={option.name}
                placeholder="Name"
                class="px-2 py-1 border rounded text-sm"
              />
              <input
                type="text"
                name="joinery_{i}_description"
                bind:value={option.description}
                placeholder="Description"
                class="px-2 py-1 border rounded text-sm"
              />
              <select
                name="joinery_{i}_difficulty"
                bind:value={option.difficulty}
                class="px-2 py-1 border rounded text-sm"
              >
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
              </select>
            </div>
            <button
              type="button"
              onclick={() => removeJoineryOption(i)}
              class="px-2 py-1 text-red-600 hover:bg-red-100 rounded"
            >
              Remove
            </button>
          </div>
        {/each}
      </div>

      <button
        type="button"
        onclick={addJoineryOption}
        class="mt-3 text-sm text-amber-700 hover:text-amber-800"
      >
        + Add Joinery Option
      </button>
    </div>

    <!-- Suggestions -->
    <div class="bg-white border rounded-lg p-6">
      <h2 class="text-lg font-semibold mb-4">Suggestions</h2>

      <div class="grid grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Suggested Woods</label>
          <input
            type="text"
            name="suggested_woods"
            value={data.template.suggestedWoods.join(', ')}
            class="w-full px-3 py-2 border rounded-lg text-sm"
            placeholder="oak, walnut, maple"
          />
          <p class="text-xs text-gray-500 mt-1">Comma-separated</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Suggested Finishes</label>
          <input
            type="text"
            name="suggested_finishes"
            value={data.template.suggestedFinishes.join(', ')}
            class="w-full px-3 py-2 border rounded-lg text-sm"
            placeholder="polyurethane, danish oil"
          />
          <p class="text-xs text-gray-500 mt-1">Comma-separated</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Typical Hardware</label>
          <input
            type="text"
            name="typical_hardware"
            value={data.template.typicalHardware.join(', ')}
            class="w-full px-3 py-2 border rounded-lg text-sm"
            placeholder="hinges, drawer slides"
          />
          <p class="text-xs text-gray-500 mt-1">Comma-separated</p>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-between items-center pt-4 border-t">
      <p class="text-sm text-gray-500">
        Last updated: {data.template.updatedAt.toLocaleString()}
      </p>
      <button
        type="submit"
        disabled={loading}
        class="px-6 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800 disabled:opacity-50"
      >
        {loading ? 'Saving...' : 'Save Changes'}
      </button>
    </div>
  </form>
</div>
```

Key UI patterns:
- Pre-populated form fields from data.template
- Reactive joinery options array (copied from data for editing)
- Delete with confirm() dialog
- Success feedback with auto-dismiss
- Progressive enhancement with use:enhance
- Loading state during submission
- Last updated timestamp display
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Navigate to /admin/templates, click on a template
3. Verify all fields are pre-populated correctly
4. Edit name, save - verify success message and page stays
5. Edit dimensions, save - verify changes persist
6. Add/remove joinery option, save - verify changes persist
7. Click Delete, confirm - verify redirect to list
8. Verify deleted template no longer in list or BOM wizard
  </verify>
  <done>Template edit page with all fields editable, save updates template, delete removes template with confirmation</done>
</task>

</tasks>

<verification>
1. `npm run check` passes
2. /admin/templates/[id] requires authentication
3. Edit form pre-populates all fields correctly
4. Update saves all fields including joinery options array
5. Delete prompts for confirmation
6. Delete removes template and redirects to list
7. Deleted template no longer appears in BOM wizard
</verification>

<success_criteria>
- /admin/templates/[id] route exists with auth protection
- Load returns single template or 404
- Update action modifies all fields and sets updatedAt
- Delete action removes template and redirects
- UI displays all template data in editable form
- Joinery options can be added/removed dynamically
- TMPL-04 (edit template) complete
- TMPL-05 (delete template) complete
</success_criteria>

<output>
After completion, create `.planning/phases/11-template-management/11-04-SUMMARY.md`
</output>
