---
phase: 11-template-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/schema.ts
  - scripts/seed-templates.ts
autonomous: true

must_haves:
  truths:
    - "Templates table exists in database with all required columns"
    - "Existing 5 templates are seeded into database"
    - "Template types are exported for use in other files"
  artifacts:
    - path: "src/lib/server/schema.ts"
      provides: "templates table with JSON columns"
      contains: "export const templates = sqliteTable"
    - path: "scripts/seed-templates.ts"
      provides: "Migration script for hardcoded templates"
      contains: "db.insert(templates)"
  key_links:
    - from: "scripts/seed-templates.ts"
      to: "src/lib/server/schema.ts"
      via: "imports templates table"
      pattern: "from.*schema"
    - from: "scripts/seed-templates.ts"
      to: "src/lib/data/templates.ts"
      via: "imports hardcoded templates array"
      pattern: "from.*data/templates"
---

<objective>
Add templates table to database schema and create seed script to migrate existing hardcoded templates.

Purpose: Establishes the database foundation for all template management features. Templates must exist in the database before the admin UI or BOM wizard can use them.

Output: templates table in schema.ts, seed-templates.ts script, database synchronized with new table.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-template-management/11-RESEARCH.md
@src/lib/server/schema.ts
@src/lib/data/templates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add templates table to schema</name>
  <files>src/lib/server/schema.ts</files>
  <action>
Add templates table to schema.ts with the following structure:

1. Export interfaces at top of file (these will be used by other files):
   - JoineryOption: { id, name, description, difficulty }
   - DimensionRange: { min, max, default }
   - TemplateDimensions: { length, width, height?, unit }

2. Create templates table using text({ mode: 'json' }).$type<T>() pattern:
   - id: text primary key
   - name: text not null
   - icon: text not null (HTML entity)
   - description: text not null
   - defaultDimensions: text({ mode: 'json' }).$type<TemplateDimensions>().notNull()
   - joineryOptions: text({ mode: 'json' }).$type<JoineryOption[]>().notNull()
   - suggestedWoods: text({ mode: 'json' }).$type<string[]>().notNull()
   - suggestedFinishes: text({ mode: 'json' }).$type<string[]>().notNull()
   - typicalHardware: text({ mode: 'json' }).$type<string[]>().notNull()
   - createdAt: integer({ mode: 'timestamp' }).notNull()
   - updatedAt: integer({ mode: 'timestamp' }).notNull()

3. Add templatesRelations (empty for now - templates are standalone).

Important: Use text mode for JSON, NOT blob mode - SQLite JSON functions require text.
  </action>
  <verify>TypeScript compiles without errors: `npm run check`</verify>
  <done>templates table defined in schema.ts with all JSON columns typed, interfaces exported</done>
</task>

<task type="auto">
  <name>Task 2: Create seed script and push schema</name>
  <files>scripts/seed-templates.ts</files>
  <action>
1. Create scripts/ directory if it doesn't exist

2. Create scripts/seed-templates.ts:
```typescript
/**
 * Seed script to migrate hardcoded templates to database
 * Run with: npx tsx scripts/seed-templates.ts
 */
import { db } from '../src/lib/server/db';
import { templates as templatesTable } from '../src/lib/server/schema';
import { templates as hardcodedTemplates } from '../src/lib/data/templates';

async function seedTemplates() {
  console.log('Migrating templates to database...');

  for (const template of hardcodedTemplates) {
    const now = new Date();

    try {
      await db.insert(templatesTable).values({
        id: template.id,
        name: template.name,
        icon: template.icon,
        description: template.description,
        defaultDimensions: template.defaultDimensions,
        joineryOptions: template.joineryOptions,
        suggestedWoods: template.suggestedWoods,
        suggestedFinishes: template.suggestedFinishes,
        typicalHardware: template.typicalHardware,
        createdAt: now,
        updatedAt: now
      });

      console.log(`  + ${template.name}`);
    } catch (err: any) {
      // Handle duplicate key (already seeded)
      if (err.message?.includes('UNIQUE constraint')) {
        console.log(`  = ${template.name} (already exists)`);
      } else {
        console.error(`  ! ${template.name}: ${err.message}`);
      }
    }
  }

  console.log('Migration complete!');
}

seedTemplates()
  .then(() => process.exit(0))
  .catch((err) => {
    console.error('Migration failed:', err);
    process.exit(1);
  });
```

3. Run `npm run db:push` to synchronize schema

4. Run `npx tsx scripts/seed-templates.ts` to seed templates

5. Verify in Drizzle Studio: `npm run db:studio` - should see 5 templates
  </action>
  <verify>
Run `npx tsx scripts/seed-templates.ts` - should show 5 templates migrated.
Run `npm run db:studio` and verify templates table has 5 rows with correct data.
  </verify>
  <done>Schema pushed to database, 5 templates seeded successfully, visible in Drizzle Studio</done>
</task>

</tasks>

<verification>
1. `npm run check` passes (TypeScript compiles)
2. Database has templates table with correct columns
3. 5 templates exist in database with all JSON fields populated
4. Drizzle Studio shows templates with readable JSON data
</verification>

<success_criteria>
- templates table exists in schema.ts with typed JSON columns
- JoineryOption, DimensionRange, TemplateDimensions interfaces exported
- seed-templates.ts can be run successfully
- Database contains all 5 original templates with correct data
</success_criteria>

<output>
After completion, create `.planning/phases/11-template-management/11-01-SUMMARY.md`
</output>
