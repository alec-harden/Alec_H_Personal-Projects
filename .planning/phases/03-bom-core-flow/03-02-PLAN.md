---
phase: 03-bom-core-flow
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/schemas/bom-schema.ts
  - src/routes/api/bom/generate/+server.ts
autonomous: true

must_haves:
  truths:
    - "API endpoint accepts project details and returns structured BOM"
    - "BOM response includes all 4 categories (lumber, hardware, finishes, consumables)"
    - "AI generates contextually appropriate materials based on project type"
  artifacts:
    - path: "src/lib/server/schemas/bom-schema.ts"
      provides: "Zod schema for structured AI output"
      min_lines: 20
      exports: ["bomSchema", "BOMSchema"]
    - path: "src/routes/api/bom/generate/+server.ts"
      provides: "BOM generation API endpoint"
      min_lines: 40
      exports: ["POST"]
  key_links:
    - from: "src/routes/api/bom/generate/+server.ts"
      to: "src/lib/server/ai.ts"
      via: "getModel() import"
      pattern: "import.*getModel.*from.*ai"
    - from: "src/routes/api/bom/generate/+server.ts"
      to: "ai"
      via: "generateObject function"
      pattern: "generateObject"
---

<objective>
Create the BOM generation API endpoint that uses Vercel AI SDK's structured output capabilities.

Purpose: Enable AI-powered BOM generation with consistent, typed JSON output. The endpoint constructs a detailed woodworking prompt using template context and user inputs, then uses `generateObject()` with a Zod schema to ensure structured response.

Output: New API endpoint at POST /api/bom/generate that accepts project details and returns a complete BOM.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-integration/02-01-SUMMARY.md

# Existing AI setup to follow:
@src/lib/server/ai.ts
@src/routes/api/chat/+server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schema for BOM output</name>
  <files>src/lib/server/schemas/bom-schema.ts</files>
  <action>
Create a new schemas directory and Zod schema file:

1. Create `src/lib/server/schemas/` directory

2. Define Zod schema matching BOM types:

```typescript
import { z } from 'zod';

export const bomItemSchema = z.object({
  id: z.string(),
  name: z.string(),
  description: z.string().optional(),
  quantity: z.number(),
  unit: z.string(),
  category: z.enum(['lumber', 'hardware', 'finishes', 'consumables']),
  notes: z.string().optional()
});

export const bomSchema = z.object({
  projectName: z.string(),
  projectType: z.string(),
  generatedAt: z.string(),
  items: z.array(bomItemSchema)
});

export type BOMSchema = z.infer<typeof bomSchema>;
```

Export both the schema and the inferred type.
  </action>
  <verify>npm run check passes, schema is importable</verify>
  <done>Zod schema defined and exported, matches BOM type structure</done>
</task>

<task type="auto">
  <name>Task 2: Create BOM generation endpoint</name>
  <files>src/routes/api/bom/generate/+server.ts</files>
  <action>
Create the API endpoint:

1. Create directory structure: `src/routes/api/bom/generate/`

2. Implement POST handler:

```typescript
import { generateObject } from 'ai';
import { getModel } from '$lib/server/ai';
import { bomSchema } from '$lib/server/schemas/bom-schema';
import type { RequestHandler } from './$types';

export const POST: RequestHandler = async ({ request }) => {
  const projectDetails = await request.json();

  // Construct detailed prompt with template context
  const prompt = buildBOMPrompt(projectDetails);

  const result = await generateObject({
    model: getModel(),
    schema: bomSchema,
    prompt
  });

  return new Response(JSON.stringify(result.object), {
    headers: { 'Content-Type': 'application/json' }
  });
};
```

3. Implement `buildBOMPrompt()` function that constructs a detailed woodworking prompt:

The prompt should include:
- Project type and name
- Dimensions (length x width x height)
- Selected joinery methods
- Wood species preference
- Finish preference
- Additional notes

And instruct the AI to:
- Generate items for ALL 4 categories (lumber, hardware, finishes, consumables)
- Be specific with dimensions (add 1/4" for milling on lumber)
- Use standard lumber dimensions available at lumber yards
- Include specific screw sizes, quantities, etc.
- Estimate finish quantities based on project size
- Include consumables like sandpaper (multiple grits), glue, rags

4. Add error handling for AI failures with appropriate HTTP status codes.

5. Generate unique IDs for each item using crypto.randomUUID() or similar.
  </action>
  <verify>npm run build succeeds, endpoint compiles without errors</verify>
  <done>POST /api/bom/generate endpoint accepts project details and returns structured BOM JSON</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run check` passes (0 errors, 0 warnings)
- [ ] `src/lib/server/schemas/bom-schema.ts` exports bomSchema and BOMSchema type
- [ ] `src/routes/api/bom/generate/+server.ts` exports POST handler
- [ ] Endpoint uses generateObject() with the Zod schema
- [ ] Prompt includes template context and all user inputs
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Endpoint is accessible at POST /api/bom/generate
- Response matches BOM schema structure
</success_criteria>

<output>
After completion, create `.planning/phases/03-bom-core-flow/03-02-SUMMARY.md`
</output>
