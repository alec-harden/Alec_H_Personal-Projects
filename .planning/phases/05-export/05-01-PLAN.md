---
phase: 05-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/utils/csv.ts
  - src/lib/components/bom/BOMDisplay.svelte
autonomous: false

must_haves:
  truths:
    - "User can see Export CSV button on BOM display"
    - "User can click Export and receive a CSV file download"
    - "Downloaded CSV contains all visible BOM items organized by category"
    - "CSV opens correctly in spreadsheet applications"
  artifacts:
    - path: "src/lib/utils/csv.ts"
      provides: "CSV generation and download utilities"
      exports: ["generateBOMCSV", "downloadCSV", "generateBOMFilename"]
      min_lines: 40
    - path: "src/lib/components/bom/BOMDisplay.svelte"
      provides: "BOM display with export button"
      contains: "Export CSV"
  key_links:
    - from: "BOMDisplay.svelte"
      to: "csv.ts"
      via: "import and handleExport function"
      pattern: "import.*csv"
---

<objective>
Add CSV export functionality to the BOM display.

Purpose: Enable users to download their generated Bill of Materials as a CSV file for use in spreadsheets, shopping lists, or project documentation (EXPORT-01).

Output: CSV utility module, export button in BOM display, downloadable CSV file with category grouping.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-bom-core-flow/03-04-SUMMARY.md

# Current implementations:
@src/lib/types/bom.ts
@src/lib/components/bom/BOMDisplay.svelte
@src/lib/components/bom/BOMCategory.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV utility module</name>
  <files>src/lib/utils/csv.ts</files>
  <action>
Create a new utility module for CSV generation and download. The src/lib/utils/ directory does not exist yet, so create it.

**Functions to implement:**

1. `escapeCSVField(field: string): string`
   - RFC 4180 compliant CSV escaping
   - Quote fields containing commas, double quotes, or newlines
   - Escape double quotes by doubling them (`"` becomes `""`)
   - Return the escaped field

2. `generateBOMCSV(bom: BOM): string`
   - Import BOM and BOMItem types from '$lib/types/bom'
   - Define column headers: `['Category', 'Name', 'Quantity', 'Unit', 'Description', 'Notes']`
   - Filter out hidden items: `bom.items.filter(item => !item.hidden)` (works with undefined or false)
   - Sort by category order: lumber, hardware, finishes, consumables
   - Capitalize category names for display (e.g., 'lumber' -> 'Lumber')
   - Map each item to a CSV row, escaping each field
   - Handle optional fields (description, notes) - use empty string for undefined
   - Join rows with newline, prepend header row
   - Return complete CSV string

3. `generateBOMFilename(bom: BOM): string`
   - Sanitize project name: lowercase, replace non-alphanumeric with hyphens, trim hyphens
   - Format: `{sanitized-name}-bom-{YYYY-MM-DD}.csv`
   - Use bom.generatedAt date or current date if invalid

4. `downloadCSV(content: string, filename: string): void`
   - Create Blob with content type 'text/csv;charset=utf-8;'
   - Create object URL from Blob
   - Create anchor element, set href and download attributes
   - Programmatically click to trigger download
   - Revoke object URL to free memory

**Export all four functions.**
  </action>
  <verify>npm run check passes, file exists with all four exported functions</verify>
  <done>CSV utility module created with generation, escaping, filename, and download functions</done>
</task>

<task type="auto">
  <name>Task 2: Add export button to BOMDisplay</name>
  <files>src/lib/components/bom/BOMDisplay.svelte</files>
  <action>
Modify the BOMDisplay component to include an export button.

**Imports to add:**
```typescript
import { generateBOMCSV, downloadCSV, generateBOMFilename } from '$lib/utils/csv';
```

**Add handler function:**
```typescript
function handleExport() {
  const csv = generateBOMCSV(bom);
  const filename = generateBOMFilename(bom);
  downloadCSV(csv, filename);
}
```

**Modify header section:**
Replace the single "Start Over" button with a button group containing Export and Start Over.

Current structure:
```svelte
<div class="mb-6 flex items-start justify-between">
  <div>...</div>
  <button ... onStartOver>Start Over</button>
</div>
```

New structure:
```svelte
<div class="mb-6 flex items-start justify-between">
  <div>...</div>
  <div class="flex gap-2">
    <button
      type="button"
      onclick={handleExport}
      class="flex items-center gap-2 rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2"
    >
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
      </svg>
      Export CSV
    </button>
    <button ... existing Start Over button ...>
      Start Over
    </button>
  </div>
</div>
```

The Export button uses amber-600 (primary action, matches woodworking theme). The Start Over button keeps its existing secondary styling.

The download SVG icon is a standard download arrow pointing into a tray.
  </action>
  <verify>npm run check passes, export button visible in component</verify>
  <done>Export CSV button added to BOMDisplay header with handler wired</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>CSV export functionality for BOM display</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Navigate to BOM wizard: http://localhost:5173/bom/new
    3. Complete the wizard (any template, fill in details)
    4. Wait for BOM to generate and display
    5. Verify: "Export CSV" button visible in header (amber colored, next to "Start Over")
    6. Click "Export CSV" button
    7. Verify: CSV file downloads (filename format: {project-name}-bom-{date}.csv)
    8. Open downloaded CSV in Excel, Google Sheets, or text editor
    9. Verify CSV structure:
       - Header row: Category,Name,Quantity,Unit,Description,Notes
       - Items sorted by category (Lumber first, then Hardware, Finishes, Consumables)
       - All visible items present
       - Fields with commas are properly quoted
       - No "undefined" values (empty fields for missing description/notes)
  </how-to-verify>
  <resume-signal>Type "approved" if export works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run check` passes (0 errors)
- [ ] `npm run build` succeeds
- [ ] Export CSV button visible in BOM display header
- [ ] Clicking button triggers file download
- [ ] Downloaded CSV has correct filename format
- [ ] CSV opens correctly in spreadsheet application
- [ ] Items are sorted by category
- [ ] CSV escaping works for special characters
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Export button styled consistently with app theme
- CSV download works cross-browser (Chrome, Firefox, Safari)
- EXPORT-01 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-export/05-01-SUMMARY.md`
</output>
