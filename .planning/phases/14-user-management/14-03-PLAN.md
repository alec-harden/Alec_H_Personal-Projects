---
phase: 14-user-management
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/routes/admin/users/[id]/+page.server.ts
  - src/routes/admin/users/[id]/+page.svelte
autonomous: true

must_haves:
  truths:
    - "Admin can view user details (email, role, status, created date)"
    - "Admin can reset a user's password to a new value"
    - "Admin can toggle a user's disabled status"
    - "Admin cannot disable their own account"
  artifacts:
    - path: "src/routes/admin/users/[id]/+page.server.ts"
      provides: "User detail load + resetPassword, toggleDisabled actions"
      exports: ["load", "actions"]
    - path: "src/routes/admin/users/[id]/+page.svelte"
      provides: "User detail UI with action forms"
      min_lines: 100
  key_links:
    - from: "src/routes/admin/users/[id]/+page.server.ts"
      to: "requireAdmin"
      via: "import from auth.ts"
      pattern: "requireAdmin\\(event\\)"
    - from: "src/routes/admin/users/[id]/+page.server.ts"
      to: "db.update(users)"
      via: "Drizzle update for password reset and disable toggle"
      pattern: "db\\.update\\(users\\)"
---

<objective>
Create the admin user detail page with password reset and disable/enable functionality.

Purpose: Implement USER-03 (reset password), USER-04 (disable account), and USER-05 (view user details) requirements.
Output: /admin/users/[id] route with user details and action forms.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/14-user-management/14-01-SUMMARY.md
@src/routes/admin/templates/[id]/+page.server.ts
@src/routes/admin/templates/[id]/+page.svelte
@src/lib/server/auth.ts
@src/lib/server/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user detail page server with load and actions</name>
  <files>src/routes/admin/users/[id]/+page.server.ts</files>
  <action>
    Create src/routes/admin/users/[id]/+page.server.ts following /admin/templates/[id] pattern.

    Load function:
    - Call requireAdmin(event) first
    - Query user by id: db.query.users.findFirst where eq(users.id, event.params.id)
    - If not found, throw error(404, 'User not found')
    - Return user object (id, email, role, disabled, createdAt - NOT passwordHash)

    Actions:

    1. resetPassword action:
       - Call requireAdmin(event)
       - Extract newPassword from formData
       - Validate: newPassword required, minimum 8 characters
       - Hash new password using hashPassword from auth.ts
       - Update user: db.update(users).set({ passwordHash }).where(eq(users.id, event.params.id))
       - Return { success: true, message: 'Password reset successfully' }

    2. toggleDisabled action:
       - Call requireAdmin(event)
       - Get current user from db to check current disabled status
       - SECURITY: Check if params.id === event.locals.user.id - if so, return fail(400, { error: 'Cannot disable your own account' })
       - Toggle disabled: db.update(users).set({ disabled: !currentUser.disabled }).where(eq(users.id, event.params.id))
       - Return { success: true, message: currentUser.disabled ? 'User enabled' : 'User disabled' }

    Import: error, fail from @sveltejs/kit, db, users from schema, requireAdmin, hashPassword from auth, eq from drizzle-orm.
  </action>
  <verify>
    - File exists at src/routes/admin/users/[id]/+page.server.ts
    - `npm run check` passes
    - grep shows requireAdmin in load and both actions
    - grep shows self-disable prevention check
  </verify>
  <done>User detail server with load, resetPassword, and toggleDisabled actions</done>
</task>

<task type="auto">
  <name>Task 2: Create user detail page UI with action forms</name>
  <files>src/routes/admin/users/[id]/+page.svelte</files>
  <action>
    Create src/routes/admin/users/[id]/+page.svelte following /admin/templates/[id] pattern.

    Structure:

    1. Back link to /admin/users
    2. Header with user email and role/status badges
    3. Error/success message display (from form state)
    4. User details card:
       - Email (display only)
       - Role badge (Admin = amber, User = stone)
       - Status badge (Active = green, Disabled = red)
       - Created date (formatted nicely)

    5. Actions section with two forms side by side:

       Reset Password form:
       - New password input (type="password", required, minlength=8)
       - "Reset Password" button
       - action="?/resetPassword"
       - use:enhance for loading state

       Toggle Status form:
       - Confirm checkbox (required): "I understand this will {disable|enable} the user"
       - Button text changes based on current status: "Disable User" (red) or "Enable User" (green)
       - action="?/toggleDisabled"
       - use:enhance for loading state
       - If current user id matches page user id, show disabled button with "Cannot disable yourself"

    6. Back to Users link

    Use Props interface:
    ```typescript
    interface User {
      id: string;
      email: string;
      role: 'user' | 'admin';
      disabled: boolean;
      createdAt: Date;
    }
    interface Props {
      data: { user: User };
      form: { error?: string; success?: boolean; message?: string } | null;
    }
    ```

    Use Svelte 5 runes. Use $state for loading states. Show success toast that auto-hides after 3 seconds (use $effect like templates/[id]).
  </action>
  <verify>
    - File exists at src/routes/admin/users/[id]/+page.svelte
    - `npm run check` passes
    - Start dev server and navigate to /admin/users/{id} - page loads
  </verify>
  <done>User detail UI displays user info with working password reset and toggle disabled forms</done>
</task>

</tasks>

<verification>
```bash
# TypeScript check
npm run check

# Verify files exist
ls -la src/routes/admin/users/[id]/

# Verify requireAdmin in all functions
grep -n "requireAdmin" src/routes/admin/users/[id]/+page.server.ts

# Verify self-disable check
grep -n "locals.user.id" src/routes/admin/users/[id]/+page.server.ts

# Verify hashPassword usage
grep -n "hashPassword" src/routes/admin/users/[id]/+page.server.ts
```

Manual verification:
1. Start dev server: `npm run dev`
2. Log in as admin
3. Navigate to /admin/users, click on a user
4. Verify details display (email, role, status, created)
5. Test password reset - enter new password, submit
6. Test toggle disabled - check confirmation, submit
7. Verify cannot disable own account (button disabled or error on submit)
8. Test disabled user cannot log in (USER-06 from plan-01)
</verification>

<success_criteria>
- [ ] /admin/users/[id] loads with user details (USER-05)
- [ ] Password reset form works with validation (USER-03)
- [ ] Toggle disabled form works with confirmation (USER-04)
- [ ] Self-disable prevention works (cannot disable own account)
- [ ] requireAdmin() called in load and all actions
- [ ] Success/error messages display properly
- [ ] npm run check passes
</success_criteria>

<output>
After completion, create `.planning/phases/14-user-management/14-03-SUMMARY.md`
</output>
