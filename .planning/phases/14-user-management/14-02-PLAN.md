---
phase: 14-user-management
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/routes/admin/users/+page.server.ts
  - src/routes/admin/users/+page.svelte
autonomous: true

must_haves:
  truths:
    - "Admin can view a list of all users with email, role, status"
    - "Admin can create a new user account with email and password"
    - "Non-admins receive 403 when accessing /admin/users"
  artifacts:
    - path: "src/routes/admin/users/+page.server.ts"
      provides: "User list load + create action"
      exports: ["load", "actions"]
    - path: "src/routes/admin/users/+page.svelte"
      provides: "User list UI with create form"
      min_lines: 100
  key_links:
    - from: "src/routes/admin/users/+page.server.ts"
      to: "requireAdmin"
      via: "import from auth.ts"
      pattern: "requireAdmin\\(event\\)"
    - from: "src/routes/admin/users/+page.server.ts"
      to: "db.query.users"
      via: "Drizzle query"
      pattern: "db\\.query\\.users"
    - from: "src/routes/admin/users/+page.svelte"
      to: "/admin/users/{id}"
      via: "href links to detail page"
      pattern: "href=\"/admin/users/"
---

<objective>
Create the admin user list page with ability to view all users and create new accounts.

Purpose: Implement USER-01 (view all users) and USER-02 (create user account) requirements.
Output: /admin/users route with user list display and create form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/14-user-management/14-01-SUMMARY.md
@src/routes/admin/templates/+page.server.ts
@src/routes/admin/templates/+page.svelte
@src/lib/server/auth.ts
@src/lib/server/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user list page server with load and create action</name>
  <files>src/routes/admin/users/+page.server.ts</files>
  <action>
    Create the file src/routes/admin/users/+page.server.ts following the pattern from /admin/templates.

    Load function:
    - Call requireAdmin(event) first
    - Query all users with db.query.users.findMany()
    - Order by createdAt descending (newest first)
    - Return users array (include id, email, role, disabled, createdAt - NOT passwordHash)

    Create action (action name: 'create'):
    - Call requireAdmin(event) first
    - Extract email, password, role from formData
    - Validate:
      - Email required and valid format (use regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/)
      - Password required and minimum 8 characters
      - Role must be 'user' or 'admin' (default to 'user')
    - Check if email already exists (return fail 400 if so)
    - Hash password using hashPassword from auth.ts
    - Generate UUID for id
    - Insert user with db.insert(users).values(...)
    - Redirect to /admin/users/{id} after creation (PRG pattern)

    Import: fail, redirect from @sveltejs/kit, db, users from schema, requireAdmin and hashPassword from auth, eq from drizzle-orm, asc from drizzle-orm.
  </action>
  <verify>
    - File exists at src/routes/admin/users/+page.server.ts
    - `npm run check` passes
    - grep shows requireAdmin called in both load and create action
  </verify>
  <done>User list server with load returning all users and create action for new accounts</done>
</task>

<task type="auto">
  <name>Task 2: Create user list page UI with create form</name>
  <files>src/routes/admin/users/+page.svelte</files>
  <action>
    Create src/routes/admin/users/+page.svelte following the pattern from /admin/templates.

    Structure:
    1. Header with title "Users" and "New User" button (toggles create form)
    2. Error/success messages from form state
    3. Create form (shown when toggled):
       - Email input (required, type="email")
       - Password input (required, type="password", minlength=8)
       - Role select (user/admin, default user)
       - Cancel and Create buttons
       - Use use:enhance for progressive enhancement
    4. User list:
       - Card for each user showing: email, role badge, status badge (Active/Disabled), created date
       - Role badge: amber for admin, stone for user
       - Status badge: green for Active, red for Disabled
       - Link each card to /admin/users/{user.id}
       - Empty state if no users
    5. Back to Dashboard link

    Use Props interface:
    ```typescript
    interface User {
      id: string;
      email: string;
      role: 'user' | 'admin';
      disabled: boolean;
      createdAt: Date;
    }
    interface Props {
      data: { users: User[] };
      form: { error?: string; email?: string } | null;
    }
    ```

    Use $state for showCreateForm and loading.
    Use Svelte 5 runes ($props, $state).
  </action>
  <verify>
    - File exists at src/routes/admin/users/+page.svelte
    - `npm run check` passes
    - Start dev server and navigate to /admin/users (as admin) - page loads
  </verify>
  <done>User list UI displays all users with role/status badges and functional create form</done>
</task>

</tasks>

<verification>
```bash
# TypeScript check
npm run check

# Verify files exist
ls -la src/routes/admin/users/

# Verify requireAdmin in both load and action
grep -n "requireAdmin" src/routes/admin/users/+page.server.ts

# Verify user query
grep -n "users" src/routes/admin/users/+page.server.ts
```

Manual verification:
1. Start dev server: `npm run dev`
2. Log in as admin
3. Navigate to /admin/users
4. Verify user list displays with email, role, status
5. Click "New User", fill form, submit
6. Verify redirect to new user detail page
7. Log in as non-admin, try /admin/users - should see 403
</verification>

<success_criteria>
- [ ] /admin/users loads with list of all users (USER-01)
- [ ] Create form creates new user with email, password, role (USER-02)
- [ ] requireAdmin() called in load and create action
- [ ] User cards show email, role badge, status badge, created date
- [ ] Card links navigate to /admin/users/{id}
- [ ] Non-admin users receive 403
- [ ] npm run check passes
</success_criteria>

<output>
After completion, create `.planning/phases/14-user-management/14-02-SUMMARY.md`
</output>
