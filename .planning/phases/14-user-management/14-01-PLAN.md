---
phase: 14-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/schema.ts
  - src/app.d.ts
  - src/hooks.server.ts
  - src/routes/auth/login/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "Disabled users cannot log in (login form returns error)"
    - "Disabled users with active sessions are logged out on next request"
    - "Users table has disabled column with default false"
  artifacts:
    - path: "src/lib/server/schema.ts"
      provides: "disabled field on users table"
      contains: "disabled"
    - path: "src/routes/auth/login/+page.server.ts"
      provides: "Login blocking for disabled users"
      contains: "disabled"
    - path: "src/hooks.server.ts"
      provides: "Session invalidation for disabled users"
      contains: "disabled"
  key_links:
    - from: "src/routes/auth/login/+page.server.ts"
      to: "users.disabled"
      via: "check after password verification"
      pattern: "user\\.disabled"
    - from: "src/hooks.server.ts"
      to: "users.disabled"
      via: "check after session validation"
      pattern: "session\\.user\\.disabled"
---

<objective>
Add disabled field to users schema and implement login blocking for disabled accounts.

Purpose: Enable USER-04 (disable accounts) and USER-06 (disabled users cannot log in) requirements.
Output: Schema with disabled field, login action blocks disabled users, hooks middleware invalidates disabled user sessions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-rbac-foundation/13-01-SUMMARY.md
@src/lib/server/schema.ts
@src/lib/server/auth.ts
@src/hooks.server.ts
@src/routes/auth/login/+page.server.ts
@src/app.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add disabled field to users table and TypeScript types</name>
  <files>src/lib/server/schema.ts, src/app.d.ts</files>
  <action>
    In src/lib/server/schema.ts, add disabled field to users table:
    ```typescript
    disabled: integer('disabled', { mode: 'boolean' }).notNull().default(false)
    ```
    Place it after the role field, before createdAt.

    In src/app.d.ts, update the Locals.user interface to include:
    ```typescript
    disabled: boolean;
    ```

    Run `npm run db:push` to apply schema change to database.
  </action>
  <verify>
    - `npm run check` passes (TypeScript compilation)
    - `npm run db:push` completes successfully
    - Grep for "disabled" in schema.ts shows the field
  </verify>
  <done>Users table has disabled column with boolean mode and false default, TypeScript types updated</done>
</task>

<task type="auto">
  <name>Task 2: Block disabled users in login action</name>
  <files>src/routes/auth/login/+page.server.ts</files>
  <action>
    In the login action, after verifying the password is valid and before calling createSession():

    Add check for disabled user:
    ```typescript
    // Check if account is disabled
    if (user.disabled) {
      return fail(400, {
        error: 'This account has been disabled',
        email
      });
    }
    ```

    Use generic "This account has been disabled" message - slightly more specific than "Invalid email or password" since account exists and password was correct, but user needs to know why they can't log in.
  </action>
  <verify>
    - `npm run check` passes
    - Code shows disabled check before createSession call
  </verify>
  <done>Login action rejects disabled users with appropriate error message</done>
</task>

<task type="auto">
  <name>Task 3: Invalidate sessions for disabled users in hooks middleware</name>
  <files>src/hooks.server.ts</files>
  <action>
    In the hooks middleware, after validating the session and checking expiration, add a check for disabled users:

    After the line that sets event.locals.user (inside the `if (session.expiresAt > now)` block), add:
    ```typescript
    // Check if user account has been disabled
    if (session.user.disabled) {
      // Invalidate session for disabled user
      await db.delete(sessions).where(eq(sessions.id, session.id));
      event.cookies.delete('session_token', { path: '/' });
      // Don't set event.locals.user - treat as logged out
    } else {
      // Valid session - attach user to locals
      event.locals.user = {
        id: session.user.id,
        email: session.user.email,
        role: session.user.role,
        disabled: session.user.disabled,
        createdAt: session.user.createdAt
      };
      event.locals.sessionId = session.id;
    }
    ```

    Restructure the existing code to use an if/else for the disabled check. The key behavior: if user is disabled, delete their session and clear the cookie, effectively logging them out immediately.
  </action>
  <verify>
    - `npm run check` passes
    - Code shows disabled check in hooks middleware
    - Session is deleted when user.disabled is true
  </verify>
  <done>Hooks middleware invalidates sessions for disabled users, preventing app access</done>
</task>

</tasks>

<verification>
Run the following to verify phase completion:

```bash
# TypeScript check
npm run check

# Verify schema has disabled field
grep -n "disabled" src/lib/server/schema.ts

# Verify login blocks disabled users
grep -n "disabled" src/routes/auth/login/+page.server.ts

# Verify hooks checks disabled status
grep -n "disabled" src/hooks.server.ts

# Verify TypeScript types
grep -n "disabled" src/app.d.ts
```

Manual verification (optional):
1. Start dev server: `npm run dev`
2. Manually set a user's disabled=1 in database
3. Try to log in as that user - should see "This account has been disabled"
4. If already logged in, refresh page - should be logged out
</verification>

<success_criteria>
- [ ] users table has disabled column (boolean, default false)
- [ ] app.d.ts Locals.user interface includes disabled: boolean
- [ ] Login action checks user.disabled and returns error if true
- [ ] Hooks middleware checks user.disabled and invalidates session if true
- [ ] npm run check passes
- [ ] npm run db:push completed successfully
</success_criteria>

<output>
After completion, create `.planning/phases/14-user-management/14-01-SUMMARY.md`
</output>
