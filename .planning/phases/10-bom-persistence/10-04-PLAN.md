---
phase: 10-bom-persistence
plan: 04
type: execute
wave: 3
depends_on: ["10-03"]
files_modified:
  - src/routes/api/bom/[id]/+server.ts
  - src/routes/api/bom/[id]/items/[itemId]/+server.ts
  - src/routes/projects/[id]/bom/[bomId]/+page.svelte
  - src/routes/projects/[id]/bom/[bomId]/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "User can edit quantity of saved BOM items"
    - "User can toggle visibility of saved BOM items"
    - "User can delete a saved BOM"
    - "Changes persist after page refresh"
  artifacts:
    - path: "src/routes/api/bom/[id]/+server.ts"
      provides: "DELETE endpoint for BOM deletion"
      exports: ["DELETE"]
    - path: "src/routes/api/bom/[id]/items/[itemId]/+server.ts"
      provides: "PATCH endpoint for item updates"
      exports: ["PATCH"]
  key_links:
    - from: "src/routes/projects/[id]/bom/[bomId]/+page.svelte"
      to: "/api/bom/[id]/items/[itemId]"
      via: "fetch PATCH on quantity/visibility change"
    - from: "src/routes/projects/[id]/bom/[bomId]/+page.svelte"
      to: "/api/bom/[id]"
      via: "fetch DELETE for BOM removal"
---

<objective>
Add editing and deletion capabilities for saved BOMs.

Purpose: BOM-03 and BOM-04 requirements - users need to modify saved BOMs (quantities, visibility) and delete BOMs they no longer need. This completes the CRUD cycle for BOM persistence.

Output: API endpoints for item updates and BOM deletion, wired into saved BOM view with auto-save behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

# Schema
@src/lib/server/schema.ts

# BOM types
@src/lib/types/bom.ts

# Saved BOM view (from 10-03)
@src/routes/projects/[id]/bom/[bomId]/+page.svelte
@src/routes/projects/[id]/bom/[bomId]/+page.server.ts

# BOMDisplay (has edit callbacks)
@src/lib/components/bom/BOMDisplay.svelte

# Project patterns for delete/security
@src/routes/projects/[id]/+page.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API endpoints for BOM operations</name>
  <files>
    src/routes/api/bom/[id]/+server.ts
    src/routes/api/bom/[id]/items/[itemId]/+server.ts
  </files>
  <action>
**src/routes/api/bom/[id]/+server.ts:**
DELETE endpoint for removing a BOM:
1. Validate user is authenticated (401 if not)
2. Fetch BOM with project relation to verify ownership
3. Verify BOM exists and project.userId === locals.user.id (403 if not)
4. Delete BOM (cascade deletes items automatically)
5. Return { success: true }

```typescript
import { json, error } from '@sveltejs/kit';
import { db } from '$lib/server/db';
import { boms } from '$lib/server/schema';
import { eq } from 'drizzle-orm';

export const DELETE: RequestHandler = async ({ params, locals }) => {
  if (!locals.user) {
    throw error(401, 'Unauthorized');
  }

  const bom = await db.query.boms.findFirst({
    where: eq(boms.id, params.id),
    with: { project: { columns: { userId: true } } }
  });

  if (!bom || bom.project.userId !== locals.user.id) {
    throw error(403, 'Forbidden');
  }

  await db.delete(boms).where(eq(boms.id, params.id));

  return json({ success: true });
};
```

**src/routes/api/bom/[id]/items/[itemId]/+server.ts:**
PATCH endpoint for updating item quantity or visibility:
1. Validate user is authenticated
2. Fetch item with bom -> project relation to verify ownership chain
3. Validate ownership (item.bom.project.userId === locals.user.id)
4. Accept body: { quantity?: number, hidden?: boolean }
5. Update only provided fields + set bom.updatedAt
6. Return { success: true }

```typescript
export const PATCH: RequestHandler = async ({ params, request, locals }) => {
  if (!locals.user) {
    throw error(401, 'Unauthorized');
  }

  const item = await db.query.bomItems.findFirst({
    where: eq(bomItems.id, params.itemId),
    with: { bom: { with: { project: { columns: { userId: true } } } } }
  });

  if (!item || item.bom.project.userId !== locals.user.id) {
    throw error(403, 'Forbidden');
  }

  const body = await request.json();
  const updates: Partial<typeof bomItems.$inferInsert> = {};

  if (typeof body.quantity === 'number' && body.quantity >= 0) {
    updates.quantity = body.quantity;
  }
  if (typeof body.hidden === 'boolean') {
    updates.hidden = body.hidden;
  }

  if (Object.keys(updates).length > 0) {
    await db.update(bomItems).set(updates).where(eq(bomItems.id, params.itemId));
    await db.update(boms).set({ updatedAt: new Date() }).where(eq(boms.id, params.id));
  }

  return json({ success: true });
};
```
  </action>
  <verify>`npm run check` passes, endpoint files exist with correct exports</verify>
  <done>DELETE /api/bom/[id] and PATCH /api/bom/[id]/items/[itemId] endpoints created</done>
</task>

<task type="auto">
  <name>Task 2: Wire edit handlers in saved BOM view</name>
  <files>
    src/routes/projects/[id]/bom/[bomId]/+page.svelte
    src/routes/projects/[id]/bom/[bomId]/+page.server.ts
  </files>
  <action>
**+page.svelte changes:**
1. Add local state to track the BOM (so we can update it optimistically):
```typescript
let bom = $state(data.bom);
```

2. Add quantity change handler with API call:
```typescript
async function handleQuantityChange(id: string, quantity: number) {
  // Optimistic update
  bom = {
    ...bom,
    items: bom.items.map(item =>
      item.id === id ? { ...item, quantity } : item
    )
  };

  // Persist to server
  await fetch(`/api/bom/${data.bomId}/items/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ quantity })
  });
}
```

3. Add visibility toggle handler:
```typescript
async function handleToggleVisibility(id: string) {
  const item = bom.items.find(i => i.id === id);
  if (!item) return;

  const newHidden = !item.hidden;

  // Optimistic update
  bom = {
    ...bom,
    items: bom.items.map(i =>
      i.id === id ? { ...i, hidden: newHidden } : i
    )
  };

  // Persist to server
  await fetch(`/api/bom/${data.bomId}/items/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ hidden: newHidden })
  });
}
```

4. Pass handlers to BOMDisplay:
```svelte
<BOMDisplay
  {bom}
  onStartOver={handleBack}
  onQuantityChange={handleQuantityChange}
  onToggleVisibility={handleToggleVisibility}
/>
```

5. Add delete functionality:
- Add "Delete BOM" button in header or danger zone section
- Confirmation dialog (confirm())
- Call DELETE /api/bom/[id]
- On success, redirect to project detail page

```typescript
async function handleDelete() {
  if (!confirm('Delete this BOM? This cannot be undone.')) return;

  const response = await fetch(`/api/bom/${data.bomId}`, { method: 'DELETE' });
  if (response.ok) {
    goto(`/projects/${data.projectId}`);
  }
}
```

6. Add delete button below BOMDisplay or in a danger zone section (red styling like project delete).
  </action>
  <verify>
1. `npm run check` passes
2. Open saved BOM, change quantity - refreshes still show new quantity
3. Toggle visibility - refreshes preserve visibility state
4. Delete BOM - redirects to project, BOM no longer in list
  </verify>
  <done>Saved BOM view supports editing quantities, visibility, and deletion with persistence</done>
</task>

</tasks>

<verification>
1. `npm run check` passes
2. Save a BOM to project (from 10-02)
3. Open saved BOM view
4. Edit quantity: Change from 4 to 6
5. Refresh page - quantity still shows 6
6. Toggle visibility on an item
7. Refresh page - item still hidden
8. Delete BOM - confirm dialog - redirected to project
9. Project detail no longer shows deleted BOM
</verification>

<success_criteria>
- Quantity changes persist to database
- Visibility toggles persist to database
- Delete removes BOM and all items (cascade)
- Optimistic UI updates (no loading states for edits)
- Security: Only owner can edit/delete
- BOM.updatedAt updates on any item change
</success_criteria>

<output>
After completion, create `.planning/phases/10-bom-persistence/10-04-SUMMARY.md`
</output>
