---
phase: 10-bom-persistence
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/routes/api/bom/save/+server.ts
  - src/lib/components/bom/BOMDisplay.svelte
  - src/lib/components/bom/SaveToProjectModal.svelte
  - src/routes/bom/new/+page.svelte
  - src/routes/bom/new/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "User can save a generated BOM to a selected project"
    - "User sees their projects in a selection modal"
    - "Saved BOM persists after page refresh"
  artifacts:
    - path: "src/routes/api/bom/save/+server.ts"
      provides: "POST endpoint for saving BOM to project"
      exports: ["POST"]
    - path: "src/lib/components/bom/SaveToProjectModal.svelte"
      provides: "Modal for project selection when saving BOM"
      min_lines: 50
  key_links:
    - from: "BOMDisplay.svelte"
      to: "SaveToProjectModal.svelte"
      via: "Save to Project button opens modal"
    - from: "SaveToProjectModal.svelte"
      to: "/api/bom/save"
      via: "fetch POST with bom data and projectId"
    - from: "/api/bom/save"
      to: "prisma (drizzle)"
      via: "transaction insert boms + bomItems"
---

<objective>
Implement "Save to Project" functionality for generated BOMs.

Purpose: BOM-01 requirement - users need to persist AI-generated BOMs for later access. This connects the ephemeral BOM generation flow to the persistent project storage.

Output: Save button in BOMDisplay, project selector modal, API endpoint with transactional save.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

# Schema with boms/bomItems (from 10-01)
@src/lib/server/schema.ts

# BOM types to save
@src/lib/types/bom.ts

# Current BOMDisplay - add save button here
@src/lib/components/bom/BOMDisplay.svelte

# BOM new page - needs to load projects for save modal
@src/routes/bom/new/+page.svelte

# Project server patterns
@src/routes/projects/[id]/+page.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BOM save API endpoint</name>
  <files>src/routes/api/bom/save/+server.ts</files>
  <action>
Create POST endpoint at /api/bom/save that:

**Request body:**
```typescript
{
  projectId: string;
  bom: BOM;  // Full BOM object from client
}
```

**Implementation:**
1. Validate user is authenticated (check locals.user, return 401 if not)
2. Validate projectId belongs to this user (security check)
3. Validate bom object has required fields
4. Use Drizzle transaction to atomically:
   - Generate UUID for bom (use crypto.randomUUID())
   - Insert into boms table: id, projectId, name (bom.projectName), projectType, generatedAt (parse ISO string), createdAt, updatedAt
   - Insert each bom.items into bomItems: generate UUID for each, set bomId, position (index), map all fields
5. Return { success: true, bomId: string }

**Error responses:**
- 401: Not authenticated
- 403: Project not owned by user
- 400: Invalid request body
- 500: Database error

Import db from '$lib/server/db', schema from '$lib/server/schema'.
Use drizzle transaction: `await db.transaction(async (tx) => { ... })`
  </action>
  <verify>Create endpoint file, run `npm run check` passes</verify>
  <done>POST /api/bom/save endpoint saves BOM atomically to database</done>
</task>

<task type="auto">
  <name>Task 2: Create SaveToProjectModal component</name>
  <files>src/lib/components/bom/SaveToProjectModal.svelte</files>
  <action>
Create modal component for project selection:

**Props:**
```typescript
interface Props {
  open: boolean;
  projects: Array<{ id: string; name: string }>;
  onSave: (projectId: string) => void;
  onClose: () => void;
  saving: boolean;
}
```

**UI structure:**
- Modal overlay (click outside to close)
- Modal content card with:
  - Header: "Save to Project"
  - Project list (radio buttons or clickable cards)
  - If no projects: message "No projects yet" with link to /projects
  - Footer: Cancel button, Save button (disabled if no selection, shows loading state)

**Styling:**
- Use existing Tailwind classes matching project aesthetic
- Amber accent for selected project
- Card shadow and rounded corners
- Animate fade in/out

**Behavior:**
- Track selectedProjectId in $state
- onSave called with selectedProjectId when Save clicked
- onClose called when Cancel clicked or overlay clicked
  </action>
  <verify>Component file exists, `npm run check` passes</verify>
  <done>SaveToProjectModal renders project list and emits save/close events</done>
</task>

<task type="auto">
  <name>Task 3: Add Save button and integrate modal into BOM flow</name>
  <files>
    src/lib/components/bom/BOMDisplay.svelte
    src/routes/bom/new/+page.svelte
    src/routes/bom/new/+page.server.ts
  </files>
  <action>
**BOMDisplay.svelte changes:**
Add new optional props:
```typescript
onSave?: () => void;  // Called when user clicks Save to Project
showSaveButton?: boolean;  // Whether to show save button (default false)
```

In header-actions, add Save button before Export (only if showSaveButton and onSave):
```svelte
{#if showSaveButton && onSave}
  <button type="button" onclick={onSave} class="btn-primary">
    Save to Project
  </button>
{/if}
```

**+page.server.ts (new file):**
Create server load to fetch user's projects:
```typescript
export const load: PageServerLoad = async ({ locals }) => {
  if (!locals.user) {
    return { projects: [] };
  }
  const userProjects = await db.query.projects.findMany({
    where: eq(projects.userId, locals.user.id),
    columns: { id: true, name: true },
    orderBy: desc(projects.updatedAt)
  });
  return { projects: userProjects };
};
```

**+page.svelte changes:**
1. Import SaveToProjectModal
2. Add props: `data: { projects }` from server load
3. Add state: `showSaveModal`, `saving`, `saveError`, `saveSuccess`
4. Add handler `handleSaveClick()` - opens modal
5. Add handler `handleSaveConfirm(projectId)`:
   - Set saving = true
   - POST to /api/bom/save with { projectId, bom: generatedBOM }
   - On success: close modal, show success toast/message, optionally navigate to saved BOM
   - On error: show error in modal
6. Pass showSaveButton={true} and onSave={handleSaveClick} to BOMDisplay
7. Render SaveToProjectModal conditionally

Only show save button if user is authenticated (data.projects !== empty array implies auth, or check separate flag).
  </action>
  <verify>
1. `npm run check` passes
2. Manual test: Generate BOM, click Save to Project, select project, confirm save
3. Check database: boms and bom_items tables have new records
  </verify>
  <done>Users can save generated BOM to a project via modal flow</done>
</task>

</tasks>

<verification>
1. `npm run check` passes (all TypeScript valid)
2. Generate BOM via wizard
3. "Save to Project" button appears in BOMDisplay header
4. Click button opens modal with project list
5. Select project, click Save
6. Success message appears
7. Verify in Drizzle Studio: boms and bom_items tables have the saved data
</verification>

<success_criteria>
- POST /api/bom/save endpoint works with authentication
- SaveToProjectModal shows user's projects
- Save button integrated into BOMDisplay
- BOM + items saved atomically in transaction
- Success feedback shown to user
</success_criteria>

<output>
After completion, create `.planning/phases/10-bom-persistence/10-02-SUMMARY.md`
</output>
