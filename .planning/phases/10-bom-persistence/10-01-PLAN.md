---
phase: 10-bom-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/schema.ts
autonomous: true

must_haves:
  truths:
    - "BOMs table exists with projectId foreign key"
    - "BOM items table exists with bomId foreign key"
    - "Cascade deletes work (project -> boms -> items)"
  artifacts:
    - path: "src/lib/server/schema.ts"
      provides: "boms and bomItems tables with relations"
      contains: "sqliteTable('boms'"
  key_links:
    - from: "boms.projectId"
      to: "projects.id"
      via: "foreign key with cascade delete"
    - from: "bomItems.bomId"
      to: "boms.id"
      via: "foreign key with cascade delete"
---

<objective>
Add database schema for BOM persistence - boms and bomItems tables.

Purpose: Foundation for saving, viewing, and managing BOMs within projects. Without schema, no persistence features can be built.

Output: Extended schema.ts with boms and bomItems tables, relations established, database synchronized.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing schema patterns
@src/lib/server/schema.ts

# BOM type definitions to match
@src/lib/types/bom.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add boms and bomItems tables to schema</name>
  <files>src/lib/server/schema.ts</files>
  <action>
Add two new tables following existing patterns:

**boms table:**
- id: text primary key (use generateId or uuid pattern)
- projectId: text FK to projects.id with cascade delete
- name: text not null (BOM name, from BOM.projectName)
- projectType: text not null (template id, from BOM.projectType)
- generatedAt: integer timestamp not null (when AI generated it)
- createdAt: integer timestamp not null (when saved to DB)
- updatedAt: integer timestamp not null

**bomItems table:**
- id: text primary key
- bomId: text FK to boms.id with cascade delete
- name: text not null
- description: text nullable
- quantity: integer not null
- unit: text not null
- category: text not null (lumber|hardware|finishes|consumables)
- notes: text nullable
- hidden: integer boolean not null default false
- position: integer not null (preserve ordering)

**Relations:**
- Add bomsRelations: boms -> one project, many bomItems
- Add bomItemsRelations: bomItems -> one bom
- Update projectsRelations to include: many(boms)
- Update usersRelations to NOT change (projects already included)

Follow existing snake_case pattern for column names (e.g., project_id, bom_id, generated_at).
  </action>
  <verify>Run `npm run check` - TypeScript compiles without errors</verify>
  <done>boms and bomItems tables defined in schema.ts with proper relations</done>
</task>

<task type="auto">
  <name>Task 2: Synchronize database schema</name>
  <files>local.db (database file)</files>
  <action>
Run database push to apply schema changes:
```bash
npm run db:push
```

This creates the new tables in the local SQLite database.

Verify tables exist by opening Drizzle Studio:
```bash
npm run db:studio
```
(Check that boms and bom_items tables appear)
  </action>
  <verify>Run `npm run db:push` - completes without errors. Tables visible in Drizzle Studio.</verify>
  <done>Database contains boms and bom_items tables with correct structure</done>
</task>

</tasks>

<verification>
1. `npm run check` passes (TypeScript valid)
2. `npm run db:push` succeeds
3. Schema defines: boms, bomItems, bomsRelations, bomItemsRelations
4. Foreign keys cascade properly (projectId -> projects, bomId -> boms)
</verification>

<success_criteria>
- boms table exists with projectId FK
- bomItems table exists with bomId FK
- Both tables have cascade delete configured
- Drizzle relations allow querying boms with items
- Database synchronized with schema
</success_criteria>

<output>
After completion, create `.planning/phases/10-bom-persistence/10-01-SUMMARY.md`
</output>
