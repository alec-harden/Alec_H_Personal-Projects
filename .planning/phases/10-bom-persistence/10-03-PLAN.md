---
phase: 10-bom-persistence
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/routes/projects/[id]/+page.svelte
  - src/routes/projects/[id]/+page.server.ts
  - src/routes/projects/[id]/bom/[bomId]/+page.svelte
  - src/routes/projects/[id]/bom/[bomId]/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "User can see list of saved BOMs on project detail page"
    - "User can click a BOM to view its full contents"
    - "Saved BOM displays identically to generated BOM (same BOMDisplay component)"
  artifacts:
    - path: "src/routes/projects/[id]/bom/[bomId]/+page.svelte"
      provides: "Saved BOM detail view route"
      min_lines: 30
    - path: "src/routes/projects/[id]/bom/[bomId]/+page.server.ts"
      provides: "Server load for saved BOM with items"
      exports: ["load"]
  key_links:
    - from: "src/routes/projects/[id]/+page.svelte"
      to: "/projects/[id]/bom/[bomId]"
      via: "BOM list links"
    - from: "/projects/[id]/bom/[bomId]/+page.server.ts"
      to: "db.query.boms"
      via: "Drizzle query with bomItems relation"
---

<objective>
Display saved BOMs within project context - list on project page and detail view route.

Purpose: BOM-02 requirement - users need to access their saved BOMs. This creates the view layer for persisted data, enabling users to revisit completed work.

Output: Project detail page shows BOM list, new route displays individual saved BOM with all items.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

# Schema with boms/bomItems (from 10-01)
@src/lib/server/schema.ts

# BOM types
@src/lib/types/bom.ts

# Project detail page - add BOM list here
@src/routes/projects/[id]/+page.svelte
@src/routes/projects/[id]/+page.server.ts

# BOMDisplay for rendering saved BOMs
@src/lib/components/bom/BOMDisplay.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BOM list to project detail page</name>
  <files>
    src/routes/projects/[id]/+page.server.ts
    src/routes/projects/[id]/+page.svelte
  </files>
  <action>
**+page.server.ts changes:**
Update load function to fetch BOMs for this project:
```typescript
// After fetching project, also fetch its BOMs
const projectBoms = await db.query.boms.findMany({
  where: eq(boms.projectId, params.id),
  orderBy: desc(boms.updatedAt),
  columns: {
    id: true,
    name: true,
    projectType: true,
    generatedAt: true,
    updatedAt: true
  }
});

return { project, boms: projectBoms };
```

**+page.svelte changes:**
1. Update Props interface to include boms array
2. Add new section below Project Details form: "Bills of Materials"
3. If no BOMs: show empty state with "No BOMs saved yet" and link to /bom/new
4. If BOMs exist: show list/cards with:
   - BOM name
   - Project type (template)
   - Generated date
   - Last updated date
   - Click navigates to /projects/[id]/bom/[bomId]

Style the BOM list as cards similar to project cards on dashboard. Use amber accent for hover states.
  </action>
  <verify>`npm run check` passes, project detail page shows BOM section</verify>
  <done>Project detail page displays list of saved BOMs with links to view each</done>
</task>

<task type="auto">
  <name>Task 2: Create saved BOM detail route</name>
  <files>
    src/routes/projects/[id]/bom/[bomId]/+page.server.ts
    src/routes/projects/[id]/bom/[bomId]/+page.svelte
  </files>
  <action>
**+page.server.ts:**
Create server load that:
1. Validates user is authenticated (redirect to login if not)
2. Fetches BOM by bomId WITH its items relation
3. Validates BOM belongs to a project owned by this user (security check via project.userId)
4. Returns 404 if BOM not found or not authorized
5. Transform database records to BOM type for BOMDisplay:
```typescript
// Query
const bomRecord = await db.query.boms.findFirst({
  where: eq(boms.id, params.bomId),
  with: { items: true, project: true }
});

// Verify ownership
if (!bomRecord || bomRecord.project.userId !== locals.user.id) {
  throw error(404, 'BOM not found');
}

// Transform to BOM type
const bom: BOM = {
  projectName: bomRecord.name,
  projectType: bomRecord.projectType,
  generatedAt: bomRecord.generatedAt.toISOString(),
  items: bomRecord.items
    .sort((a, b) => a.position - b.position)
    .map(item => ({
      id: item.id,
      name: item.name,
      description: item.description ?? undefined,
      quantity: item.quantity,
      unit: item.unit,
      category: item.category as BOMCategory,
      notes: item.notes ?? undefined,
      hidden: item.hidden
    }))
};

return { bom, bomId: params.bomId, projectId: params.id, projectName: bomRecord.project.name };
```

**+page.svelte:**
1. Import BOMDisplay component
2. Render page with:
   - Back link to project detail: /projects/[id]
   - Page header with project name context
   - BOMDisplay with the loaded bom
3. For now, pass onStartOver that navigates back to project (no new wizard from here)
4. Do NOT pass edit handlers yet (Phase 10-04 adds editing)

Page structure:
```svelte
<div class="min-h-screen bg-stone-100 py-8 px-4">
  <div class="max-w-2xl mx-auto">
    <a href="/projects/{data.projectId}">Back to {data.projectName}</a>
    <BOMDisplay bom={data.bom} onStartOver={handleBack} />
  </div>
</div>
```
  </action>
  <verify>
1. `npm run check` passes
2. Navigate to /projects/[id]/bom/[bomId] with a saved BOM ID
3. BOM displays correctly with all items
4. Back link returns to project detail
  </verify>
  <done>Saved BOM detail route loads and displays BOM via BOMDisplay component</done>
</task>

</tasks>

<verification>
1. `npm run check` passes
2. Save a BOM (from 10-02) to a project
3. Go to /projects/[id] - BOM appears in list
4. Click BOM - navigates to /projects/[id]/bom/[bomId]
5. BOM displays with all items, categories, visibility states
6. Back link works
</verification>

<success_criteria>
- Project detail page shows BOMs section with list
- Empty state shown when no BOMs
- BOM detail route renders saved BOM via BOMDisplay
- Security: Can only view BOMs in own projects
- Data integrity: All items, categories, visibility preserved
</success_criteria>

<output>
After completion, create `.planning/phases/10-bom-persistence/10-03-SUMMARY.md`
</output>
