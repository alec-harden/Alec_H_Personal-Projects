---
phase: 18-cut-optimizer-foundation
plan: 04
type: execute
wave: 2
depends_on: ["18-01", "18-03"]
files_modified:
  - src/routes/cutlist/+page.svelte
  - src/routes/api/cutlist/save/+server.ts
  - src/routes/+page.svelte
  - src/lib/components/cutlist/SaveCutListModal.svelte
autonomous: true

must_haves:
  truths:
    - "User can clear all inputs and start over"
    - "User can save cut list to a project"
    - "Cut List Optimizer is accessible from dashboard"
  artifacts:
    - path: "src/routes/api/cutlist/save/+server.ts"
      provides: "API endpoint to save cut list to database"
      exports: ["POST"]
    - path: "src/lib/components/cutlist/SaveCutListModal.svelte"
      provides: "Modal for selecting project and naming cut list"
      min_lines: 80
  key_links:
    - from: "src/routes/cutlist/+page.svelte"
      to: "/api/cutlist/save"
      via: "fetch call"
      pattern: "fetch.*api/cutlist/save"
    - from: "src/routes/+page.svelte"
      to: "/cutlist"
      via: "href link"
      pattern: "href=\"/cutlist\""
---

<objective>
Add clear functionality, save-to-project persistence, and enable the tool on the dashboard.

Purpose: Complete the cut optimizer foundation by allowing users to reset their work, save optimized cut lists to projects for future reference, and making the tool discoverable from the main dashboard.

Output: Fully functional cut optimizer with clear/save capabilities and dashboard integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-cut-optimizer-foundation/18-RESEARCH.md
@.planning/phases/18-cut-optimizer-foundation/18-01-SUMMARY.md
@.planning/phases/18-cut-optimizer-foundation/18-03-SUMMARY.md
@src/routes/+page.svelte
@src/lib/components/bom/SaveToProjectModal.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add clear all functionality</name>
  <files>src/routes/cutlist/+page.svelte</files>
  <action>
Add "Clear All" functionality to reset the cut optimizer:

**Clear function:**
```typescript
function handleClearAll() {
  // Reset to initial state
  cuts = [createCut(mode)];
  stock = [createStock(mode)];
  kerf = 0.125;
  result = null;
  error = null;
}
```

**UI elements:**
- Add "Clear All" button in the action bar (near Optimize button)
- Style as secondary/ghost button (not primary like Optimize)
- Include a reset/trash icon
- Position: left of "Optimize Cuts" button

**Confirmation (optional but recommended):**
- If cuts.length > 1 or stock.length > 1, show confirmation
- Simple window.confirm() is acceptable for this scope
- Message: "Clear all cuts and stock? This cannot be undone."

**Button states:**
- Disable Clear All while optimization is running
- Always enabled otherwise (even with empty inputs)
  </action>
  <verify>
1. Add several cuts and stock entries
2. Click "Clear All" - confirm dialog appears
3. Confirm - all inputs reset to single empty row each
4. Kerf resets to 0.125
5. Results clear
  </verify>
  <done>
- "Clear All" button visible and functional
- Confirmation prompt prevents accidental data loss
- All state resets to initial values
  </done>
</task>

<task type="auto">
  <name>Task 2: Create save cut list API and modal</name>
  <files>
    src/routes/api/cutlist/save/+server.ts
    src/lib/components/cutlist/SaveCutListModal.svelte
  </files>
  <action>
**src/routes/api/cutlist/save/+server.ts:**
- POST endpoint requiring authentication (use requireAuth from $lib/server/auth.ts)
- Accept JSON body:
  ```typescript
  {
    projectId: string,
    name: string,
    mode: CutListMode,
    cuts: Cut[],
    stock: Stock[],
    kerf: number
  }
  ```
- Verify user owns the project (check userId match)
- Create cutList record with provided data
- Create cutListCuts records for each cut
- Create cutListStock records for each stock
- Use transaction to ensure atomicity
- Return { success: true, cutListId: string }

**src/lib/components/cutlist/SaveCutListModal.svelte:**
- Props using $props():
  - `open: boolean`
  - `projects: Project[]` (user's projects from page data)
  - `onSave: (projectId: string, name: string) => void`
  - `onClose: () => void`
  - `saving: boolean`
- Modal overlay (use similar pattern to SaveToProjectModal from BOM)
- Form fields:
  - Project dropdown (select from user's projects)
  - Cut list name input (text, required)
- Save and Cancel buttons
- Disable form while saving
- Error display area

Styling:
- Match SaveToProjectModal appearance
- Modal backdrop with blur
- Centered modal card
- Form inputs with labels
- Button row at bottom
  </action>
  <verify>
1. POST to /api/cutlist/save with valid data - creates records
2. Check database: cutLists, cutListCuts, cutListStock populated
3. Modal renders with project dropdown and name input
4. Saving state disables form
5. Run `npm run check` - no TypeScript errors
  </verify>
  <done>
- API endpoint creates cutList with related cuts and stock records
- Modal displays project selection and name input
- Save triggers onSave callback with projectId and name
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up save flow and enable dashboard card</name>
  <files>
    src/routes/cutlist/+page.svelte
    src/routes/+page.svelte
  </files>
  <action>
**src/routes/cutlist/+page.svelte - Save integration:**

Add state for save modal:
```typescript
let showSaveModal = $state(false);
let saving = $state(false);
let saveError = $state<string | null>(null);
let saveSuccess = $state(false);
```

Save handler:
```typescript
async function handleSave(projectId: string, name: string) {
  saving = true;
  saveError = null;

  try {
    const response = await fetch('/api/cutlist/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        projectId,
        name,
        mode,
        cuts,
        stock,
        kerf
      })
    });

    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error || 'Failed to save');
    }

    showSaveModal = false;
    saveSuccess = true;
  } catch (e) {
    saveError = e instanceof Error ? e.message : 'An error occurred';
  } finally {
    saving = false;
  }
}
```

UI additions:
- "Save to Project" button (shown only when authenticated and has projects)
- Import and render SaveCutListModal
- Success banner after save (similar to BOM save success)

Button placement:
- Action bar: [Clear All] [Optimize Cuts] [Save to Project]
- Save to Project: secondary style, shown conditionally

**src/routes/+page.svelte - Enable tool card:**

Find the ToolCard for "Cut List Optimizer" and:
- Remove `disabled={true}` prop
- Verify href="/cutlist" is correct

The card should now link to the working /cutlist route.
  </action>
  <verify>
1. Dashboard: Cut List Optimizer card is clickable (not disabled)
2. Click card - navigates to /cutlist
3. (When authenticated with projects) Save to Project button visible
4. Click Save - modal opens with project dropdown
5. Fill in name, select project, click Save
6. Success banner appears
7. Check database - cut list saved with cuts and stock
8. Run `npm run check` - no TypeScript errors
  </verify>
  <done>
- Save to Project flow works end-to-end
- Dashboard tool card enabled and links to /cutlist
- Success feedback after save
- All Phase 18 requirements (CUT-01 to CUT-10) satisfied
  </done>
</task>

</tasks>

<verification>
1. Clear All: Resets all inputs to initial state
2. Save API: Creates cutList record with related cuts/stock
3. Save Modal: Displays project dropdown and name input
4. Save Flow: Modal -> API -> Success banner
5. Dashboard: Tool card enabled and navigates to /cutlist
6. Full requirements: CUT-01 through CUT-10 all satisfied
</verification>

<success_criteria>
- CUT-09: Clear All resets inputs and results
- CUT-10: Save to Project persists cut list to database
- CUT-01: Dashboard shows enabled Cut List Optimizer card
- End-to-end flow: Create cuts -> Optimize -> View results -> Save
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-cut-optimizer-foundation/18-04-SUMMARY.md`
</output>
