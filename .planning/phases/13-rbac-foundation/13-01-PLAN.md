---
phase: 13-rbac-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/schema.ts
  - src/hooks.server.ts
  - src/app.d.ts
  - src/lib/server/auth.ts
autonomous: true

must_haves:
  truths:
    - "Users table has role column with admin/user enum"
    - "Session includes user role for authorization checks"
    - "requireAdmin() guard throws 403 for non-admin users"
  artifacts:
    - path: "src/lib/server/schema.ts"
      provides: "role column on users table"
      contains: "role: text('role'"
    - path: "src/app.d.ts"
      provides: "TypeScript interface with role"
      contains: "role: 'user' | 'admin'"
    - path: "src/hooks.server.ts"
      provides: "Role populated in locals.user"
      contains: "role: session.user.role"
    - path: "src/lib/server/auth.ts"
      provides: "Admin guard function"
      contains: "export function requireAdmin"
  key_links:
    - from: "src/hooks.server.ts"
      to: "src/lib/server/schema.ts"
      via: "session.user.role lookup"
      pattern: "session\\.user\\.role"
    - from: "src/lib/server/auth.ts"
      to: "locals.user.role"
      via: "requireAdmin checks role"
      pattern: "user\\.role.*admin"
---

<objective>
Add role column to users table and create authorization infrastructure.

Purpose: Foundation for all admin-only features. Without role-based guards, any authenticated user can access admin routes - this is a security vulnerability that must be fixed before adding new features.
Output: Schema with role column, TypeScript types updated, requireAdmin() guard ready for use.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/v3-ARCHITECTURE.md

@src/lib/server/schema.ts
@src/lib/server/auth.ts
@src/hooks.server.ts
@src/app.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add role column to users table</name>
  <files>src/lib/server/schema.ts</files>
  <action>
Add a `role` column to the existing `users` table definition:

```typescript
role: text('role', { enum: ['user', 'admin'] }).notNull().default('user')
```

Position: Add after `passwordHash` column, before `createdAt`.

The column:
- Uses text type with enum constraint for type safety
- Defaults to 'user' (RBAC-03: User role is default for new registrations)
- Is not null to ensure every user has a role

After modifying schema.ts, push to database:
```bash
npm run db:push
```

Note: Existing users will get 'user' role from default. This is correct - first admin logic will be added in Plan 02.
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds.
Run `npm run db:push` - schema syncs without errors.
  </verify>
  <done>
users table has role column with 'user' default. Database schema updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types and hooks middleware</name>
  <files>src/app.d.ts, src/hooks.server.ts</files>
  <action>
**Step 1: Update src/app.d.ts**

Extend the `Locals.user` interface to include role:

```typescript
interface Locals {
  user?: {
    id: string;
    email: string;
    role: 'user' | 'admin';  // NEW
    createdAt: Date;
  };
  sessionId?: string;
}
```

**Step 2: Update src/hooks.server.ts**

In the session validation block, add `role` when populating `event.locals.user`:

```typescript
event.locals.user = {
  id: session.user.id,
  email: session.user.email,
  role: session.user.role,  // NEW
  createdAt: session.user.createdAt
};
```

This ensures every authenticated request has role available for authorization checks.
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds with new role property.
Run `npm run dev` briefly and verify no runtime errors on page load.
  </verify>
  <done>
TypeScript types include role. Hooks middleware populates role from session.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create requireAdmin() guard function</name>
  <files>src/lib/server/auth.ts</files>
  <action>
Add authorization guard functions to src/lib/server/auth.ts:

```typescript
import { error, redirect } from '@sveltejs/kit';
import type { RequestEvent } from '@sveltejs/kit';

/**
 * Requires authenticated user. Redirects to login if not authenticated.
 * Use in load() functions and actions that need auth.
 */
export function requireAuth(event: RequestEvent) {
  if (!event.locals.user) {
    const redirectUrl = event.url.pathname;
    throw redirect(302, `/auth/login?redirect=${encodeURIComponent(redirectUrl)}`);
  }
  return event.locals.user;
}

/**
 * Requires admin role. Throws 403 if user is not admin.
 * Always call after requireAuth() or use standalone (it calls requireAuth internally).
 */
export function requireAdmin(event: RequestEvent) {
  const user = requireAuth(event);
  if (user.role !== 'admin') {
    throw error(403, 'Admin access required');
  }
  return user;
}
```

These guards:
- Handle the common pattern of checking auth then role
- Return the user object for convenient access to user.id, user.email
- Use SvelteKit's error() and redirect() for proper HTTP responses
- Encode redirect URL to handle special characters in paths

Place these functions after the existing deleteSession function.

Add the required imports at the top of the file:
```typescript
import { error, redirect } from '@sveltejs/kit';
import type { RequestEvent } from '@sveltejs/kit';
```
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds.
Verify the functions are exported by checking the file.
  </verify>
  <done>
requireAuth() and requireAdmin() functions exported from auth.ts. Ready for use in admin routes.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes with no TypeScript errors
2. `npm run db:push` succeeds - role column added to users table
3. schema.ts has role column with enum constraint and 'user' default
4. app.d.ts Locals.user interface includes role property
5. hooks.server.ts populates role from session.user.role
6. auth.ts exports requireAuth() and requireAdmin() functions
</verification>

<success_criteria>
- [ ] role column added to users table (text enum: 'user' | 'admin', default 'user')
- [ ] app.d.ts updated with role in Locals.user interface
- [ ] hooks.server.ts populates role in event.locals.user
- [ ] requireAuth() function exported from auth.ts
- [ ] requireAdmin() function exported from auth.ts
- [ ] npm run check passes
- [ ] npm run db:push succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/13-rbac-foundation/13-01-SUMMARY.md`
</output>
