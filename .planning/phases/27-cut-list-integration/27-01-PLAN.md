---
phase: 27-cut-list-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/cutlist/from-bom/+page.server.ts
  - src/lib/components/cutlist/BomSelector.svelte
autonomous: true

must_haves:
  truths:
    - "Cut list imports only items where cutItem=true"
    - "Sheet goods trigger sheet (2D) optimization mode"
    - "BomSelector shows accurate count of cut items"
    - "Stock labels include thickness prefix when available"
  artifacts:
    - path: "src/routes/cutlist/from-bom/+page.server.ts"
      provides: "cutItem filter, mode detection, thickness labels"
      contains: "cutItem === true"
    - path: "src/lib/components/cutlist/BomSelector.svelte"
      provides: "Cut item count display"
      contains: "cutItem === true"
  key_links:
    - from: "src/routes/cutlist/from-bom/+page.server.ts"
      to: "bomItems.cutItem"
      via: "filter predicate"
      pattern: "item\\.cutItem === true"
    - from: "src/routes/cutlist/from-bom/+page.server.ts"
      to: "bomItems.category"
      via: "mode detection"
      pattern: "category === 'sheet'"
    - from: "src/lib/components/cutlist/BomSelector.svelte"
      to: "item.cutItem"
      via: "count filter"
      pattern: "cutItem === true"
---

<objective>
Update cut list optimizer to use v4.0 BOM schema: filter by cutItem flag, detect mode by sheet category, include thickness in labels.

Purpose: Complete v4.0 schema integration - cut list now correctly imports items marked for cutting regardless of their specific lumber category (hardwood/common/sheet).

Output: Working cut list import flow using cutItem flag and thickness field.
</objective>

<execution_context>
@C:\Users\wn45mv\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\wn45mv\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-cut-list-integration/27-RESEARCH.md

# Source files to modify
@src/routes/cutlist/from-bom/+page.server.ts
@src/lib/components/cutlist/BomSelector.svelte

# Type definitions for reference
@src/lib/types/bom.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update from-bom Server Logic</name>
  <files>src/routes/cutlist/from-bom/+page.server.ts</files>
  <action>
Update the loadFromBoms action to use v4.0 schema fields:

1. **Change filter logic (CUT-01):**
   - Line 72-74: Replace `item.category === 'lumber'` with `item.cutItem === true`
   - Rename variable from `validLumberItems` to `validCutItems`
   - Use strict equality: `item.cutItem === true` (NOT just truthy check - cutItem can be null)

2. **Update error message:**
   - Line 77-79: Change "No lumber items with valid dimensions" to "No cut items with valid dimensions"

3. **Change mode detection (CUT-04):**
   - Line 83-84: Replace width-based detection with category-based
   - OLD: `const hasWidth = validLumberItems.some((item) => item.width !== null)`
   - NEW: `const hasSheetItems = validCutItems.some((item) => item.category === 'sheet')`
   - Update mode assignment: `const mode = hasSheetItems ? 'sheet' : 'linear'`

4. **Add thickness to labels (CUT-02):**
   - Line 92: Change label from just `item.name` to include thickness prefix
   - NEW: `label: item.thickness ? \`${item.thickness}" ${item.name}\` : item.name`
   - This creates labels like '0.75" Oak' or '1.5" Pine' when thickness exists

Note: Keep `item.length !== null` check in filter - cut items still need valid dimensions.
  </action>
  <verify>
Run `npm run check` - TypeScript compilation passes with no errors.
Verify filter checks `cutItem === true` not `category === 'lumber'`.
Verify mode detection checks `category === 'sheet'` not `width !== null`.
  </verify>
  <done>
Filter uses `item.cutItem === true` predicate.
Mode detection uses `item.category === 'sheet'` check.
Stock labels include thickness prefix when available.
Error message says "cut items" not "lumber items".
  </done>
</task>

<task type="auto">
  <name>Task 2: Update BomSelector Component</name>
  <files>src/lib/components/cutlist/BomSelector.svelte</files>
  <action>
Update BomSelector to count and display cut items instead of lumber items:

1. **Update interface (CUT-03 prerequisite):**
   - Lines 8-16: Add `cutItem?: boolean` to the items array type
   ```typescript
   interface BOM {
     id: string;
     name: string;
     items: Array<{
       id: string;
       category: string;
       cutItem?: boolean;  // ADD THIS
       length: number | null;
       width: number | null;
     }>;
   }
   ```

2. **Update count function (CUT-03):**
   - Lines 28-31: Rename function from `getLumberCount` to `getCutItemCount`
   - Change filter from `item.category === 'lumber'` to `item.cutItem === true`
   ```typescript
   function getCutItemCount(bom: BOM): number {
     return bom.items.filter(
       (item) => item.cutItem === true && item.length !== null
     ).length;
   }
   ```

3. **Update template variable:**
   - Line 36: Change `{@const lumberCount = getLumberCount(bom)}` to `{@const cutItemCount = getCutItemCount(bom)}`

4. **Update display text:**
   - Lines 55-58: Change variable reference and text
   - FROM: `{lumberCount} {lumberCount === 1 ? 'lumber item' : 'lumber items'}`
   - TO: `{cutItemCount} {cutItemCount === 1 ? 'cut item' : 'cut items'}`

5. **Update comment:**
   - Lines 2-4: Update comment from "lumber item count" to "cut item count"
  </action>
  <verify>
Run `npm run check` - TypeScript compilation passes.
Interface includes `cutItem?: boolean` in items array.
Function is named `getCutItemCount` and filters by `cutItem === true`.
Display shows "X cut items" (singular/plural handled correctly).
  </verify>
  <done>
BomSelector interface includes cutItem field.
Count function filters by cutItem === true.
UI displays "X cut items" for each BOM.
No references to "lumber" remain in component.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript Check:**
   ```bash
   npm run check
   ```
   Must pass with no errors.

2. **Code Review:**
   - `from-bom/+page.server.ts` contains `cutItem === true` filter
   - `from-bom/+page.server.ts` contains `category === 'sheet'` mode detection
   - `BomSelector.svelte` contains `cutItem === true` in count function
   - No remaining references to `category === 'lumber'` in either file
   - No remaining references to "lumber items" in display text

3. **Integration Test (manual if dev server running):**
   - Create BOM with hardwood items (cutItem=true set by API)
   - Create BOM with hardware items (cutItem=false)
   - Navigate to cut list from-bom page
   - Verify hardwood items appear, hardware items do not
   - Verify sheet goods trigger 2D mode selection
</verification>

<success_criteria>
1. Cut list imports only items where `cutItem === true` (not category-based)
2. Sheet category items trigger sheet (2D) optimization mode
3. BomSelector shows "X cut items" count for each BOM
4. Stock labels show thickness prefix (e.g., "0.75\" Oak") when thickness exists
5. No TypeScript errors
6. No remaining "lumber" references in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/27-cut-list-integration/27-01-SUMMARY.md`
</output>
