---
phase: 08-authentication-foundation
plan: 04
type: execute
wave: 4
depends_on: ["08-03"]
files_modified:
  - src/routes/auth/logout/+page.server.ts
  - src/lib/components/UserMenu.svelte
  - src/routes/+layout.svelte
  - src/routes/+layout.server.ts
autonomous: false

must_haves:
  truths:
    - "User can log out and session is invalidated"
    - "User session persists across browser refresh"
    - "Header shows login link when not authenticated"
    - "Header shows user menu when authenticated"
  artifacts:
    - path: "src/routes/auth/logout/+page.server.ts"
      provides: "Logout action"
      exports: ["actions"]
    - path: "src/lib/components/UserMenu.svelte"
      provides: "User dropdown with logout"
      min_lines: 20
    - path: "src/routes/+layout.server.ts"
      provides: "User data to all pages"
      exports: ["load"]
  key_links:
    - from: "src/routes/+layout.svelte"
      to: "src/lib/components/UserMenu.svelte"
      via: "component import"
      pattern: "import UserMenu"
    - from: "src/routes/+layout.server.ts"
      to: "event.locals.user"
      via: "pass user to layout"
      pattern: "locals\\.user"
---

<objective>
Implement logout functionality and integrate auth state into app layout.

Purpose: Completes AUTH-03 (session persistence) and AUTH-04 (logout). User menu in header shows auth state, logout clears session. Session persists across refreshes.
Output: Working logout, user menu component, auth-aware layout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/ARCHITECTURE.md

@.planning/phases/08-authentication-foundation/08-01-SUMMARY.md
@.planning/phases/08-authentication-foundation/08-02-SUMMARY.md
@.planning/phases/08-authentication-foundation/08-03-SUMMARY.md

@src/lib/server/auth.ts
@src/hooks.server.ts
@src/routes/+layout.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create logout route</name>
  <files>src/routes/auth/logout/+page.server.ts</files>
  <action>
Create logout route as a form action (no UI needed, just server logic):

**src/routes/auth/logout/+page.server.ts:**
```typescript
import { redirect } from '@sveltejs/kit';
import type { Actions } from './$types';
import { deleteSession } from '$lib/server/auth';

export const actions: Actions = {
  default: async ({ locals, cookies }) => {
    if (locals.sessionId) {
      await deleteSession(locals.sessionId, cookies);
    }

    throw redirect(302, '/');
  }
};
```

Key behaviors:
- Uses deleteSession from auth.ts (deletes DB record, clears cookie)
- Redirects to home page after logout
- Works even if not logged in (graceful handling)
- No page UI needed - accessed via form POST
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds.
  </verify>
  <done>
/auth/logout action deletes session from DB, clears cookie, redirects to /.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create layout server load for user data</name>
  <files>src/routes/+layout.server.ts</files>
  <action>
Create root layout server load to pass user data to all pages:

**src/routes/+layout.server.ts:**
```typescript
import type { LayoutServerLoad } from './$types';

export const load: LayoutServerLoad = async ({ locals }) => {
  return {
    user: locals.user ?? null
  };
};
```

This makes user data available to:
- +layout.svelte (for header/nav)
- All child pages via data.user
- Components that need auth state

Note: Returns null explicitly when not authenticated (clearer than undefined).
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds.
  </verify>
  <done>
Layout server load returns user data from locals.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create UserMenu component and update layout</name>
  <files>src/lib/components/UserMenu.svelte, src/routes/+layout.svelte</files>
  <action>
Create UserMenu component and integrate into layout:

**src/lib/components/UserMenu.svelte:**
```svelte
<script lang="ts">
  import { enhance } from '$app/forms';

  interface Props {
    email: string;
  }

  let { email }: Props = $props();
  let open = $state(false);

  function handleClickOutside(event: MouseEvent) {
    const target = event.target as HTMLElement;
    if (!target.closest('.user-menu')) {
      open = false;
    }
  }
</script>

<svelte:window onclick={handleClickOutside} />

<div class="user-menu relative">
  <button
    onclick={() => (open = !open)}
    class="flex items-center gap-2 px-3 py-1.5 text-sm text-stone-700 hover:text-stone-900 hover:bg-stone-100 rounded-md transition-colors"
  >
    <span class="w-7 h-7 bg-amber-600 text-white rounded-full flex items-center justify-center text-xs font-medium">
      {email[0].toUpperCase()}
    </span>
    <span class="hidden sm:inline max-w-32 truncate">{email}</span>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  {#if open}
    <div class="absolute right-0 mt-1 w-48 bg-white rounded-md shadow-lg border border-stone-200 py-1 z-50">
      <div class="px-4 py-2 border-b border-stone-100">
        <p class="text-sm font-medium text-stone-900 truncate">{email}</p>
      </div>

      <form method="POST" action="/auth/logout" use:enhance>
        <button
          type="submit"
          class="w-full text-left px-4 py-2 text-sm text-stone-700 hover:bg-stone-100"
        >
          Log out
        </button>
      </form>
    </div>
  {/if}
</div>
```

**Update src/routes/+layout.svelte:**

Read the existing layout and add:
1. Import UserMenu component
2. Access data.user from layout data
3. Show UserMenu if authenticated, Login link if not
4. Add the user menu to the header area

The layout likely has a header section - add conditional auth UI there:
```svelte
{#if data.user}
  <UserMenu email={data.user.email} />
{:else}
  <a href="/auth/login" class="text-sm text-stone-600 hover:text-amber-600">
    Log in
  </a>
{/if}
```

Key features:
- Avatar with first letter of email
- Dropdown with logout button
- Click outside to close
- Progressive enhancement for logout
- Truncates long emails
- Responsive (hides email on mobile)
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds.
Run `npm run dev` - page loads without errors.
When logged out: Login link visible in header.
When logged in: User menu shows with avatar and email.
Click user menu: Dropdown opens with logout button.
Click logout: Session cleared, redirects to home, Login link now visible.
  </verify>
  <done>
UserMenu component renders avatar + dropdown. Layout shows login link or user menu based on auth state. Logout works.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete authentication flow:
- User signup with email/password
- User login with credentials
- Session persistence across page refresh
- User menu with logout
  </what-built>
  <how-to-verify>
1. Open http://localhost:5173 in a browser
2. Verify "Log in" link appears in header (not authenticated)
3. Click "Log in", then "Sign up" link
4. Create account with:
   - Email: test@example.com
   - Password: testpass123
   - Confirm: testpass123
5. Verify redirect to home page
6. Verify user menu appears (avatar + email)
7. **Refresh the page** - verify still logged in (session persists)
8. Click user menu, click "Log out"
9. Verify redirect to home, "Log in" link reappears
10. Click "Log in"
11. Enter credentials: test@example.com / testpass123
12. Verify login succeeds, user menu appears again
13. Try login with wrong password - verify error message
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run check` passes
2. Logout action deletes session from DB, clears cookie
3. Layout server load passes user to all pages
4. UserMenu component shows avatar + email dropdown
5. Layout shows login link when not authenticated
6. Layout shows UserMenu when authenticated
7. Complete flow: signup -> auto-login -> refresh (persists) -> logout -> login
</verification>

<success_criteria>
- [ ] /auth/logout clears session (DB + cookie) and redirects
- [ ] +layout.server.ts returns user data
- [ ] UserMenu shows avatar with first letter
- [ ] UserMenu dropdown has logout button
- [ ] Click outside closes dropdown
- [ ] Layout shows login link when not authenticated
- [ ] Layout shows UserMenu when authenticated
- [ ] Session persists across page refresh (AUTH-03)
- [ ] Logout invalidates session (AUTH-04)
- [ ] Full flow verified: signup -> persist -> logout -> login
</success_criteria>

<output>
After completion, create `.planning/phases/08-authentication-foundation/08-04-SUMMARY.md`
</output>
