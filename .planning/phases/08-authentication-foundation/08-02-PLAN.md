---
phase: 08-authentication-foundation
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/hooks.server.ts
  - src/app.d.ts
autonomous: true

must_haves:
  truths:
    - "Session cookie is validated on every request"
    - "Authenticated user is available via event.locals.user"
    - "Expired sessions are cleaned up automatically"
  artifacts:
    - path: "src/hooks.server.ts"
      provides: "Session validation middleware"
      exports: ["handle"]
    - path: "src/app.d.ts"
      provides: "App.Locals type with user and sessionId"
      contains: "interface Locals"
  key_links:
    - from: "src/hooks.server.ts"
      to: "src/lib/server/schema.ts"
      via: "import sessions table"
      pattern: "import.*sessions.*from"
    - from: "src/hooks.server.ts"
      to: "database"
      via: "session token lookup"
      pattern: "db\\.query\\.sessions"
---

<objective>
Implement session middleware and TypeScript types for authentication state.

Purpose: The hooks.server.ts middleware runs on every request, validating session cookies and attaching user data to event.locals. This enables downstream routes and APIs to access the authenticated user.
Output: Working session middleware, properly typed App.Locals interface.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/ARCHITECTURE.md

@.planning/phases/08-authentication-foundation/08-01-SUMMARY.md

@src/lib/server/schema.ts
@src/lib/server/db.ts
@src/app.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update App.Locals type definition</name>
  <files>src/app.d.ts</files>
  <action>
Update src/app.d.ts to define the App.Locals interface with user and session types:

```typescript
declare global {
  namespace App {
    interface Locals {
      user?: {
        id: string;
        email: string;
        createdAt: Date;
      };
      sessionId?: string;
    }
    // Keep other interfaces commented as they are
  }
}

export {};
```

Notes:
- user is optional (undefined when not authenticated)
- Keep it simple - no role field yet (can add in future if needed)
- sessionId useful for logout functionality
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds with new types.
  </verify>
  <done>
App.Locals interface defines user and sessionId types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create session validation middleware</name>
  <files>src/hooks.server.ts</files>
  <action>
Create src/hooks.server.ts with session validation logic:

```typescript
import { type Handle } from '@sveltejs/kit';
import { db } from '$lib/server/db';
import { sessions, users } from '$lib/server/schema';
import { eq } from 'drizzle-orm';

export const handle: Handle = async ({ event, resolve }) => {
  // 1. Extract session token from cookie
  const sessionToken = event.cookies.get('session_token');

  // 2. Validate session if token exists
  if (sessionToken) {
    // Look up session with user data
    const session = await db.query.sessions.findFirst({
      where: eq(sessions.token, sessionToken),
      with: { user: true }
    });

    if (session) {
      const now = new Date();
      if (session.expiresAt > now) {
        // Valid session - attach user to locals
        event.locals.user = {
          id: session.user.id,
          email: session.user.email,
          createdAt: session.user.createdAt
        };
        event.locals.sessionId = session.id;
      } else {
        // Expired session - clean up
        await db.delete(sessions).where(eq(sessions.id, session.id));
        event.cookies.delete('session_token', { path: '/' });
      }
    } else {
      // Invalid token - clear cookie
      event.cookies.delete('session_token', { path: '/' });
    }
  }

  // 3. Continue to route handler
  return resolve(event);
};
```

Key behaviors:
- Runs on every request before page/API handlers
- Looks up session by token, joins with user data
- Checks expiration, deletes expired sessions (lazy cleanup)
- Attaches user to event.locals for downstream access
- Clears invalid/expired cookies to prevent repeated lookups
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds.
Run `npm run dev` - Server starts without errors.
Check browser dev tools - no errors in console on page load.
  </verify>
  <done>
hooks.server.ts exports handle function. Middleware runs on requests without errors. event.locals.user is undefined (no session yet).
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes - no TypeScript errors
2. `npm run dev` starts successfully
3. Visit http://localhost:5173 - page loads normally
4. No console errors related to hooks or session validation
5. In a +page.server.ts, `locals.user` is typed correctly (shows as User | undefined)
</verification>

<success_criteria>
- [ ] src/app.d.ts defines App.Locals with user and sessionId
- [ ] src/hooks.server.ts exports handle function
- [ ] Middleware reads session_token cookie
- [ ] Valid sessions attach user to event.locals
- [ ] Expired sessions are deleted and cookie cleared
- [ ] Invalid tokens clear the cookie
- [ ] Dev server starts without errors
- [ ] TypeScript check passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-authentication-foundation/08-02-SUMMARY.md`
</output>
