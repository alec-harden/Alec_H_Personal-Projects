---
phase: 08-authentication-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/schema.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Database schema includes users table with id, email, passwordHash, createdAt"
    - "Database schema includes sessions table with id, userId, token, expiresAt"
    - "oslo and @node-rs/argon2 packages are installed"
  artifacts:
    - path: "src/lib/server/schema.ts"
      provides: "users and sessions table definitions"
      contains: "export const users"
    - path: "src/lib/server/schema.ts"
      provides: "sessions table with foreign key"
      contains: "export const sessions"
    - path: "package.json"
      provides: "auth dependencies"
      contains: "@node-rs/argon2"
  key_links:
    - from: "sessions table"
      to: "users table"
      via: "userId foreign key"
      pattern: "references.*users.id"
---

<objective>
Add authentication database schema and install required dependencies.

Purpose: Foundation for all auth functionality - users and sessions tables enable signup, login, and session persistence.
Output: Extended schema.ts with users/sessions tables, auth packages installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md

@src/lib/server/schema.ts
@src/lib/server/db.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install auth dependencies</name>
  <files>package.json</files>
  <action>
Install the required auth packages:

```bash
npm install oslo @node-rs/argon2
```

oslo provides auth utility functions (session token generation, etc.)
@node-rs/argon2 provides password hashing with Argon2id algorithm (faster than bcrypt, OWASP recommended)

Note: @node-rs/argon2 has native bindings but works on Vercel serverless. If deployment issues occur, fall back to argon2 package.
  </action>
  <verify>
Run `npm ls oslo @node-rs/argon2` - both packages should appear in dependency tree.
  </verify>
  <done>
oslo and @node-rs/argon2 appear in package.json dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add users and sessions tables to schema</name>
  <files>src/lib/server/schema.ts</files>
  <action>
Extend the existing schema.ts to add users and sessions tables:

1. Add users table:
   - id: text primary key (use crypto.randomUUID() when inserting)
   - email: text, not null, unique
   - passwordHash: text, not null
   - createdAt: integer timestamp, not null

2. Add sessions table:
   - id: text primary key
   - userId: text, not null, references users.id with onDelete cascade
   - token: text, not null, unique (this is what goes in the cookie)
   - expiresAt: integer timestamp, not null
   - createdAt: integer timestamp, not null

3. Add Drizzle relations for query API:
   - usersRelations: one-to-many with sessions
   - sessionsRelations: many-to-one with users

Keep existing projects table unchanged (userId will be added in Phase 9).

Use this pattern for timestamps:
```typescript
integer('created_at', { mode: 'timestamp' }).notNull()
```
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds.
Run `npm run db:push` - schema syncs to database without errors.
  </verify>
  <done>
schema.ts exports users and sessions tables. Database has corresponding tables created.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify schema with Drizzle Studio</name>
  <files>none</files>
  <action>
Push schema to database and verify tables exist:

```bash
npm run db:push
```

Then briefly check the schema was applied correctly by starting Drizzle Studio:
```bash
npm run db:studio
```

Verify:
- users table exists with columns: id, email, password_hash, created_at
- sessions table exists with columns: id, user_id, token, expires_at, created_at
- Foreign key constraint from sessions.user_id to users.id

Stop Drizzle Studio after verification (Ctrl+C).
  </action>
  <verify>
db:push completes without errors. Tables visible in Drizzle Studio.
  </verify>
  <done>
Database schema matches TypeScript definitions. Tables ready for use.
  </done>
</task>

</tasks>

<verification>
1. `npm ls oslo @node-rs/argon2` shows both packages installed
2. `npm run check` passes with no TypeScript errors
3. `npm run db:push` succeeds - schema applied to database
4. schema.ts exports: users, sessions, usersRelations, sessionsRelations
</verification>

<success_criteria>
- [ ] oslo and @node-rs/argon2 in package.json dependencies
- [ ] users table defined with id, email, passwordHash, createdAt
- [ ] sessions table defined with id, userId, token, expiresAt, createdAt
- [ ] Foreign key from sessions.userId to users.id
- [ ] Drizzle relations defined for query API
- [ ] npm run check passes
- [ ] npm run db:push succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/08-authentication-foundation/08-01-SUMMARY.md`
</output>
