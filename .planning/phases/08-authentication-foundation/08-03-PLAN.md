---
phase: 08-authentication-foundation
plan: 03
type: execute
wave: 3
depends_on: ["08-01", "08-02"]
files_modified:
  - src/routes/auth/signup/+page.svelte
  - src/routes/auth/signup/+page.server.ts
  - src/routes/auth/login/+page.svelte
  - src/routes/auth/login/+page.server.ts
  - src/lib/server/auth.ts
autonomous: true

must_haves:
  truths:
    - "User can fill signup form with email and password"
    - "User can create account with valid credentials"
    - "User can log in with existing credentials"
    - "Invalid credentials show appropriate error messages"
    - "Session is created on successful login/signup"
  artifacts:
    - path: "src/routes/auth/signup/+page.svelte"
      provides: "Signup form UI"
      min_lines: 30
    - path: "src/routes/auth/signup/+page.server.ts"
      provides: "Signup form action"
      exports: ["actions"]
    - path: "src/routes/auth/login/+page.svelte"
      provides: "Login form UI"
      min_lines: 30
    - path: "src/routes/auth/login/+page.server.ts"
      provides: "Login form action"
      exports: ["actions"]
    - path: "src/lib/server/auth.ts"
      provides: "Auth utility functions"
      exports: ["hashPassword", "verifyPassword", "createSession"]
  key_links:
    - from: "src/routes/auth/signup/+page.server.ts"
      to: "src/lib/server/auth.ts"
      via: "import auth utilities"
      pattern: "import.*from.*auth"
    - from: "src/routes/auth/login/+page.server.ts"
      to: "src/lib/server/auth.ts"
      via: "import auth utilities"
      pattern: "import.*from.*auth"
    - from: "src/lib/server/auth.ts"
      to: "database"
      via: "session creation"
      pattern: "db\\.insert.*sessions"
---

<objective>
Build signup and login routes with form actions.

Purpose: Enables AUTH-01 (signup) and AUTH-02 (login). Users can create accounts and authenticate. Session cookies are set on successful auth.
Output: Working /auth/signup and /auth/login pages with SvelteKit form actions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/ARCHITECTURE.md

@.planning/phases/08-authentication-foundation/08-01-SUMMARY.md
@.planning/phases/08-authentication-foundation/08-02-SUMMARY.md

@src/lib/server/schema.ts
@src/lib/server/db.ts
@src/hooks.server.ts
@src/app.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth utility module</name>
  <files>src/lib/server/auth.ts</files>
  <action>
Create src/lib/server/auth.ts with password hashing and session utilities:

```typescript
import { hash, verify } from '@node-rs/argon2';
import { db } from './db';
import { sessions, users } from './schema';
import { eq } from 'drizzle-orm';
import type { Cookies } from '@sveltejs/kit';

// Argon2id settings (OWASP recommended for password hashing)
const ARGON2_OPTIONS = {
  memoryCost: 19456, // 19 MiB
  timeCost: 2,
  outputLen: 32,
  parallelism: 1
};

export async function hashPassword(password: string): Promise<string> {
  return hash(password, ARGON2_OPTIONS);
}

export async function verifyPassword(hash: string, password: string): Promise<boolean> {
  try {
    return await verify(hash, password);
  } catch {
    return false;
  }
}

export async function createSession(userId: string, cookies: Cookies): Promise<string> {
  // Generate cryptographically random session token
  const token = crypto.randomUUID();
  const id = crypto.randomUUID();

  // Session expires in 30 days
  const expiresAt = new Date();
  expiresAt.setDate(expiresAt.getDate() + 30);

  await db.insert(sessions).values({
    id,
    userId,
    token,
    expiresAt,
    createdAt: new Date()
  });

  // Set httpOnly cookie
  cookies.set('session_token', token, {
    path: '/',
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'lax',
    maxAge: 60 * 60 * 24 * 30 // 30 days in seconds
  });

  return id;
}

export async function deleteSession(sessionId: string, cookies: Cookies): Promise<void> {
  await db.delete(sessions).where(eq(sessions.id, sessionId));
  cookies.delete('session_token', { path: '/' });
}
```

Key design:
- hashPassword uses Argon2id with OWASP-recommended settings
- verifyPassword catches errors gracefully (invalid hash format)
- createSession generates random token, saves to DB, sets cookie
- deleteSession removes from DB and clears cookie
- Cookie settings: httpOnly (no JS access), secure in prod, sameSite lax
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds.
  </verify>
  <done>
auth.ts exports hashPassword, verifyPassword, createSession, deleteSession.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create signup page and form action</name>
  <files>src/routes/auth/signup/+page.svelte, src/routes/auth/signup/+page.server.ts</files>
  <action>
Create signup route with form and server action:

**src/routes/auth/signup/+page.server.ts:**
```typescript
import { fail, redirect } from '@sveltejs/kit';
import type { Actions, PageServerLoad } from './$types';
import { db } from '$lib/server/db';
import { users } from '$lib/server/schema';
import { eq } from 'drizzle-orm';
import { hashPassword, createSession } from '$lib/server/auth';

export const load: PageServerLoad = async ({ locals }) => {
  // Redirect if already logged in
  if (locals.user) {
    throw redirect(302, '/');
  }
};

export const actions: Actions = {
  default: async ({ request, cookies }) => {
    const data = await request.formData();
    const email = data.get('email')?.toString().trim().toLowerCase();
    const password = data.get('password')?.toString();
    const confirmPassword = data.get('confirmPassword')?.toString();

    // Validation
    if (!email || !password || !confirmPassword) {
      return fail(400, {
        error: 'All fields are required',
        email
      });
    }

    if (!email.includes('@') || email.length < 5) {
      return fail(400, {
        error: 'Please enter a valid email address',
        email
      });
    }

    if (password.length < 8) {
      return fail(400, {
        error: 'Password must be at least 8 characters',
        email
      });
    }

    if (password !== confirmPassword) {
      return fail(400, {
        error: 'Passwords do not match',
        email
      });
    }

    // Check if email already exists
    const existing = await db.query.users.findFirst({
      where: eq(users.email, email)
    });

    if (existing) {
      return fail(400, {
        error: 'An account with this email already exists',
        email
      });
    }

    // Create user
    const id = crypto.randomUUID();
    const passwordHash = await hashPassword(password);

    await db.insert(users).values({
      id,
      email,
      passwordHash,
      createdAt: new Date()
    });

    // Create session and set cookie
    await createSession(id, cookies);

    // Redirect to dashboard
    throw redirect(302, '/');
  }
};
```

**src/routes/auth/signup/+page.svelte:**
```svelte
<script lang="ts">
  import { enhance } from '$app/forms';

  interface Props {
    form: { error?: string; email?: string } | null;
  }

  let { form }: Props = $props();
  let loading = $state(false);
</script>

<svelte:head>
  <title>Sign Up - WoodShop Toolbox</title>
</svelte:head>

<div class="min-h-screen flex items-center justify-center bg-stone-100 py-12 px-4">
  <div class="max-w-md w-full">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-stone-800">Create Account</h1>
      <p class="mt-2 text-stone-600">Join WoodShop Toolbox</p>
    </div>

    <form
      method="POST"
      class="bg-white shadow-lg rounded-lg p-8"
      use:enhance={() => {
        loading = true;
        return async ({ update }) => {
          await update();
          loading = false;
        };
      }}
    >
      {#if form?.error}
        <div class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-md text-sm">
          {form.error}
        </div>
      {/if}

      <div class="mb-4">
        <label for="email" class="block text-sm font-medium text-stone-700 mb-1">
          Email
        </label>
        <input
          type="email"
          id="email"
          name="email"
          value={form?.email ?? ''}
          required
          class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
          placeholder="you@example.com"
        />
      </div>

      <div class="mb-4">
        <label for="password" class="block text-sm font-medium text-stone-700 mb-1">
          Password
        </label>
        <input
          type="password"
          id="password"
          name="password"
          required
          minlength="8"
          class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
          placeholder="At least 8 characters"
        />
      </div>

      <div class="mb-6">
        <label for="confirmPassword" class="block text-sm font-medium text-stone-700 mb-1">
          Confirm Password
        </label>
        <input
          type="password"
          id="confirmPassword"
          name="confirmPassword"
          required
          class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
          placeholder="Repeat your password"
        />
      </div>

      <button
        type="submit"
        disabled={loading}
        class="w-full py-2 px-4 bg-amber-600 hover:bg-amber-700 disabled:bg-amber-400 text-white font-medium rounded-md transition-colors"
      >
        {loading ? 'Creating account...' : 'Create Account'}
      </button>

      <p class="mt-4 text-center text-sm text-stone-600">
        Already have an account?
        <a href="/auth/login" class="text-amber-600 hover:text-amber-700 font-medium">
          Log in
        </a>
      </p>
    </form>
  </div>
</div>
```

Key features:
- Form validation (email format, password length, confirm match)
- Email uniqueness check
- Password hashing before storage
- Session creation on success
- Progressive enhancement with use:enhance
- Loading state during submission
- Error display with field preservation
- Amber theme matching app design
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds.
Run `npm run dev`, visit http://localhost:5173/auth/signup - form renders.
Submit with invalid data - error messages appear.
Submit with valid data - redirects to dashboard.
  </verify>
  <done>
/auth/signup page renders form. Valid signup creates user, sets session cookie, redirects to /. Invalid data shows appropriate errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create login page and form action</name>
  <files>src/routes/auth/login/+page.svelte, src/routes/auth/login/+page.server.ts</files>
  <action>
Create login route with form and server action:

**src/routes/auth/login/+page.server.ts:**
```typescript
import { fail, redirect } from '@sveltejs/kit';
import type { Actions, PageServerLoad } from './$types';
import { db } from '$lib/server/db';
import { users } from '$lib/server/schema';
import { eq } from 'drizzle-orm';
import { verifyPassword, createSession } from '$lib/server/auth';

export const load: PageServerLoad = async ({ locals, url }) => {
  // Redirect if already logged in
  if (locals.user) {
    const redirectTo = url.searchParams.get('redirect') || '/';
    throw redirect(302, redirectTo);
  }

  return {
    redirect: url.searchParams.get('redirect')
  };
};

export const actions: Actions = {
  default: async ({ request, cookies, url }) => {
    const data = await request.formData();
    const email = data.get('email')?.toString().trim().toLowerCase();
    const password = data.get('password')?.toString();

    // Validation
    if (!email || !password) {
      return fail(400, {
        error: 'Email and password are required',
        email
      });
    }

    // Find user
    const user = await db.query.users.findFirst({
      where: eq(users.email, email)
    });

    if (!user) {
      // Use generic message to prevent email enumeration
      return fail(400, {
        error: 'Invalid email or password',
        email
      });
    }

    // Verify password
    const valid = await verifyPassword(user.passwordHash, password);

    if (!valid) {
      return fail(400, {
        error: 'Invalid email or password',
        email
      });
    }

    // Create session and set cookie
    await createSession(user.id, cookies);

    // Redirect to original destination or dashboard
    const redirectTo = url.searchParams.get('redirect') || '/';
    throw redirect(302, redirectTo);
  }
};
```

**src/routes/auth/login/+page.svelte:**
```svelte
<script lang="ts">
  import { enhance } from '$app/forms';

  interface Props {
    data: { redirect?: string | null };
    form: { error?: string; email?: string } | null;
  }

  let { data, form }: Props = $props();
  let loading = $state(false);
</script>

<svelte:head>
  <title>Log In - WoodShop Toolbox</title>
</svelte:head>

<div class="min-h-screen flex items-center justify-center bg-stone-100 py-12 px-4">
  <div class="max-w-md w-full">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-stone-800">Welcome Back</h1>
      <p class="mt-2 text-stone-600">Log in to WoodShop Toolbox</p>
    </div>

    <form
      method="POST"
      class="bg-white shadow-lg rounded-lg p-8"
      use:enhance={() => {
        loading = true;
        return async ({ update }) => {
          await update();
          loading = false;
        };
      }}
    >
      {#if form?.error}
        <div class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-md text-sm">
          {form.error}
        </div>
      {/if}

      <div class="mb-4">
        <label for="email" class="block text-sm font-medium text-stone-700 mb-1">
          Email
        </label>
        <input
          type="email"
          id="email"
          name="email"
          value={form?.email ?? ''}
          required
          class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
          placeholder="you@example.com"
        />
      </div>

      <div class="mb-6">
        <label for="password" class="block text-sm font-medium text-stone-700 mb-1">
          Password
        </label>
        <input
          type="password"
          id="password"
          name="password"
          required
          class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
          placeholder="Your password"
        />
      </div>

      <button
        type="submit"
        disabled={loading}
        class="w-full py-2 px-4 bg-amber-600 hover:bg-amber-700 disabled:bg-amber-400 text-white font-medium rounded-md transition-colors"
      >
        {loading ? 'Logging in...' : 'Log In'}
      </button>

      <p class="mt-4 text-center text-sm text-stone-600">
        Don't have an account?
        <a href="/auth/signup" class="text-amber-600 hover:text-amber-700 font-medium">
          Sign up
        </a>
      </p>
    </form>
  </div>
</div>
```

Key features:
- Generic error message prevents email enumeration
- Supports ?redirect param for post-login destination
- Redirects away if already logged in
- Session creation on success
- Progressive enhancement with use:enhance
- Matching design with signup page
  </action>
  <verify>
Run `npm run check` - TypeScript compilation succeeds.
Run `npm run dev`, visit http://localhost:5173/auth/login - form renders.
Submit with wrong credentials - shows "Invalid email or password".
Submit with valid credentials (user created in signup test) - redirects to dashboard.
  </verify>
  <done>
/auth/login page renders form. Valid login creates session, sets cookie, redirects. Invalid credentials show generic error.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes
2. /auth/signup form renders with email, password, confirmPassword fields
3. Signup with invalid data shows appropriate errors (email format, password length, mismatch)
4. Signup with valid data creates user in DB, sets session cookie, redirects to /
5. /auth/login form renders with email, password fields
6. Login with invalid credentials shows "Invalid email or password"
7. Login with valid credentials sets session cookie, redirects
8. Visiting auth pages when logged in redirects to /
</verification>

<success_criteria>
- [ ] src/lib/server/auth.ts exports hashPassword, verifyPassword, createSession, deleteSession
- [ ] /auth/signup creates user with hashed password
- [ ] /auth/signup validates email, password length, password match
- [ ] /auth/signup shows error for duplicate email
- [ ] /auth/login authenticates against stored hash
- [ ] /auth/login uses generic error to prevent enumeration
- [ ] Both pages create session and set httpOnly cookie on success
- [ ] Both pages redirect if already authenticated
- [ ] Forms use progressive enhancement (use:enhance)
- [ ] UI matches app design (amber theme, stone backgrounds)
</success_criteria>

<output>
After completion, create `.planning/phases/08-authentication-foundation/08-03-SUMMARY.md`
</output>
