---
phase: 12-csv-import
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/utils/csv-import.ts
  - src/lib/components/bom/CSVUpload.svelte
autonomous: true

must_haves:
  truths:
    - "CSV file can be parsed into BOMItem[] with validation errors"
    - "Invalid CSV shows row-level error messages with field and reason"
    - "Upload UI accepts drag-and-drop and button click file selection"
    - "File validation rejects non-CSV, oversized, and empty files"
  artifacts:
    - path: "src/lib/utils/csv-import.ts"
      provides: "CSV parsing, validation, and BOMItem conversion"
      exports: ["parseCSVFile", "validateFile", "CSVValidationError", "CSVParseResult"]
    - path: "src/lib/components/bom/CSVUpload.svelte"
      provides: "Drag-and-drop + button file upload UI with error display"
      min_lines: 80
  key_links:
    - from: "src/lib/utils/csv-import.ts"
      to: "papaparse"
      via: "import Papa from 'papaparse'"
      pattern: "Papa\\.parse"
    - from: "src/lib/utils/csv-import.ts"
      to: "src/lib/types/bom.ts"
      via: "import type { BOMItem, BOMCategory }"
      pattern: "BOMItem|BOMCategory"
    - from: "src/lib/components/bom/CSVUpload.svelte"
      to: "src/lib/utils/csv-import.ts"
      via: "import { parseCSVFile, validateFile }"
      pattern: "parseCSVFile|validateFile"
---

<objective>
Create the CSV parsing utilities and upload UI component for BOM CSV import.

Purpose: Provide the foundation for CSV import - a robust parsing layer that handles RFC 4180 CSVs (including Excel BOM, encoding issues, malformed data) with detailed row-level validation errors, and a polished upload component with drag-and-drop support.

Output: Two new files - csv-import.ts utility module and CSVUpload.svelte component - ready to be integrated into the /bom/new page in Plan 02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-csv-import/12-RESEARCH.md

Key existing files to reference:
@src/lib/utils/csv.ts (export format - headers: Category, Name, Quantity, Unit, Description, Notes)
@src/lib/types/bom.ts (BOMItem, BOM, BOMCategory types)
@src/lib/components/bom/AddItemForm.svelte (ID generation pattern: `custom-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PapaParse and create CSV import utilities</name>
  <files>src/lib/utils/csv-import.ts</files>
  <action>
1. Install PapaParse and its TypeScript types:
   ```bash
   npm install papaparse
   npm install --save-dev @types/papaparse
   ```

2. Create `src/lib/utils/csv-import.ts` with the following exports:

**Types:**
- `CSVValidationError` interface: `{ row: number; field: string; message: string; code: string }`
- `CSVParseResult` interface: `{ items: BOMItem[]; errors: CSVValidationError[] }`

**Functions:**

- `validateFile(file: File): string | null` - Pre-parse file validation:
  - Check extension is `.csv` (case-insensitive)
  - Check MIME type is `text/csv`, `text/plain`, `application/csv`, or empty string (some browsers don't set MIME for CSV)
  - Check file size <= 10MB (10 * 1024 * 1024 bytes)
  - Check file size > 0 (not empty)
  - Return error string or null if valid

- `validateHeaders(headers: string[]): CSVValidationError[]` - Header validation:
  - Required headers: `['Category', 'Name', 'Quantity', 'Unit']` (case-insensitive match with trim)
  - Return errors for each missing required header with code `MISSING_HEADER`

- `validateRow(row: Record<string, string>, rowNumber: number): CSVValidationError[]` - Row validation:
  - Name required (non-empty after trim), code `REQUIRED_FIELD`
  - Category required and must be one of: `lumber`, `hardware`, `finishes`, `consumables` (case-insensitive), code `REQUIRED_FIELD` or `INVALID_CATEGORY`
  - Quantity required and must be a positive number (use `parseFloat`, check `isNaN` and `> 0`), code `REQUIRED_FIELD` or `INVALID_NUMBER`
  - Unit required (non-empty after trim), code `REQUIRED_FIELD`
  - Note: Description and Notes are optional

- `rowToBOMItem(row: Record<string, string>, position: number): BOMItem` - Convert valid CSV row to BOMItem:
  - Generate ID using same pattern as AddItemForm: `csv-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`
  - Map Category to lowercase BOMCategory
  - Parse Quantity with `parseFloat` (NOT parseInt - lumber uses fractional board feet). Note: the DB schema uses integer for quantity but the BOMItem type uses number, so keep as number for client-side display. The save endpoint will handle conversion.
  - Trim all string fields
  - Set `hidden: false`
  - Description and Notes: use `undefined` if empty/whitespace

- `parseCSVFile(file: File): Promise<CSVParseResult>` - Main entry point:
  - Call `Papa.parse` with options: `{ header: true, skipEmptyLines: 'greedy', transformHeader: (h) => h.replace(/^\uFEFF/, '').trim() }`
  - After parse completes, first validate headers from `results.meta.fields`
  - If header errors, return early with empty items and header errors
  - Collect PapaParse errors (map to CSVValidationError format, row +2 for header and 0-index)
  - Validate each row, collect errors
  - Convert valid rows (rows with no errors) to BOMItems using `rowToBOMItem`
  - Return `{ items, errors }`

**Important:** Use `import Papa from 'papaparse'` (default import). The transformHeader function strips UTF-8 BOM from first header. Use `Promise` wrapper around Papa.parse since it uses callbacks.
  </action>
  <verify>
- `npm run check` passes (TypeScript compiles without errors)
- File exists at `src/lib/utils/csv-import.ts`
- Exports: `validateFile`, `parseCSVFile`, `CSVValidationError`, `CSVParseResult`
  </verify>
  <done>
- csv-import.ts exports all required functions and types
- File validation covers extension, MIME type, size, empty
- Header validation checks required columns case-insensitively
- Row validation checks Name, Category, Quantity (positive number), Unit
- Category validation accepts lowercase variants of lumber/hardware/finishes/consumables
- BOM items created with correct ID pattern, hidden=false, position index
- UTF-8 BOM stripped from headers via transformHeader
- TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSVUpload component</name>
  <files>src/lib/components/bom/CSVUpload.svelte</files>
  <action>
Create `src/lib/components/bom/CSVUpload.svelte` - a file upload component with drag-and-drop and button click support, validation feedback, and error display.

**Props (using $props()):**
```typescript
interface Props {
  onImport: (items: BOMItem[]) => void;  // Called with parsed items on successful import
  onCancel: () => void;                   // Called when user cancels upload
}
```

**State ($state):**
- `dragging: boolean` - drag-over visual feedback
- `errors: CSVValidationError[]` - validation errors to display
- `fileError: string | null` - file-level error (wrong type, too large, etc.)
- `parsing: boolean` - loading state during parse

**Behavior:**

1. **Upload zone** - A styled drop zone area with:
   - Drag-and-drop support (`ondragover`, `ondragleave`, `ondrop` handlers)
   - Hidden `<input type="file" accept=".csv,text/csv">` triggered by button click
   - Visual feedback when dragging (border color change, background highlight)
   - Upload icon (SVG inline), "Drag and drop your CSV file here" text, "or" divider, "Browse Files" button
   - Help text below: "Expected format: Category, Name, Quantity, Unit, Description, Notes"

2. **File processing flow:**
   - Call `validateFile(file)` first - if error, set `fileError` and stop
   - Set `parsing = true`
   - Call `parseCSVFile(file)` - await result
   - If `result.errors.length > 0`, set `errors = result.errors`, clear `parsing`
   - If `result.items.length === 0` and no errors, show "No valid items found in CSV"
   - If items exist and no errors, call `onImport(result.items)`
   - Set `parsing = false`

3. **Error display** - When errors exist, show:
   - File-level error: single amber/red banner with message
   - Row-level errors: scrollable list (max-height ~200px) showing "Row {N}: {field} - {message}"
   - "Try Again" button to reset and re-upload
   - Error count summary: "{N} validation errors found"

4. **Styling** - Match existing project aesthetic:
   - Use CSS custom properties: `--color-walnut`, `--color-ink`, `--color-ink-muted`, `--color-paper`, etc.
   - Upload zone: dashed border, centered content, rounded corners
   - Dragging state: amber border and light amber background
   - Error state: red/error colors matching existing error-banner pattern
   - Use `btn-primary` and `btn-secondary` class patterns from existing components
   - Cancel button at bottom: `btn-secondary` style

5. **Loading state** - While parsing, show a spinner/message "Parsing CSV..."
  </action>
  <verify>
- `npm run check` passes
- File exists at `src/lib/components/bom/CSVUpload.svelte`
- Component uses Svelte 5 runes ($props, $state)
- Component imports from `csv-import.ts` for parsing/validation
- Has drag-and-drop zone with visual feedback
- Has file input button as fallback
- Displays validation errors with row numbers
- Shows loading state during parse
- Calls onImport with BOMItem[] on success
- Has cancel button
  </verify>
  <done>
- CSVUpload.svelte accepts onImport and onCancel props
- Drag-and-drop and button click both trigger file processing
- File validation (extension, size, empty) shows file-level error
- CSV parsing errors show row-level details (row number, field, message)
- Successful parse calls onImport with BOMItem array
- Loading state shown during parse
- Cancel button calls onCancel
- Styling matches existing project aesthetic (amber theme, CSS custom properties)
  </done>
</task>

</tasks>

<verification>
1. `npm install` completes without errors (PapaParse added to dependencies)
2. `npm run check` passes (all TypeScript compiles)
3. `npm run build` succeeds (no build errors)
4. csv-import.ts exports parseCSVFile, validateFile, CSVValidationError, CSVParseResult
5. CSVUpload.svelte is a valid Svelte 5 component with $props() and $state()
</verification>

<success_criteria>
- PapaParse installed as dependency with @types/papaparse as devDependency
- csv-import.ts handles: file validation, header validation, row validation, CSV-to-BOMItem conversion, UTF-8 BOM stripping
- CSVUpload.svelte provides drag-and-drop + button upload with error display
- Both files compile without TypeScript errors
- Components are ready for integration into /bom/new page
</success_criteria>

<output>
After completion, create `.planning/phases/12-csv-import/12-01-SUMMARY.md`
</output>
