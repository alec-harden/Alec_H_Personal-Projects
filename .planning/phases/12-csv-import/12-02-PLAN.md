---
phase: 12-csv-import
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/routes/bom/new/+page.svelte
autonomous: true

must_haves:
  truths:
    - "User can choose between AI wizard and CSV import on the BOM creation page"
    - "User can upload CSV file and see parsed BOM in BOMDisplay"
    - "Imported BOM can be edited (quantities, visibility, add items) like AI-generated BOM"
    - "Imported BOM can be saved to a project using existing save flow"
    - "CSV format matches export format for round-trip compatibility"
  artifacts:
    - path: "src/routes/bom/new/+page.svelte"
      provides: "Unified BOM creation page with wizard and CSV import tabs"
      contains: "CSVUpload"
  key_links:
    - from: "src/routes/bom/new/+page.svelte"
      to: "src/lib/components/bom/CSVUpload.svelte"
      via: "import CSVUpload"
      pattern: "CSVUpload"
    - from: "src/routes/bom/new/+page.svelte"
      to: "src/lib/components/bom/BOMDisplay.svelte"
      via: "BOMDisplay with imported BOM data"
      pattern: "generatedBOM.*=.*items"
    - from: "src/routes/bom/new/+page.svelte"
      to: "src/routes/api/bom/save/+server.ts"
      via: "existing save flow (SaveToProjectModal)"
      pattern: "handleSaveConfirm"
---

<objective>
Integrate CSV import into the BOM creation page, allowing users to choose between AI wizard and CSV upload, and reuse BOMDisplay for editing and saving imported BOMs.

Purpose: Complete the CSV import feature by wiring the CSVUpload component (from Plan 01) into the existing /bom/new page. Imported BOMs get the same editing and saving capabilities as AI-generated BOMs, satisfying all CSV requirements (CSV-01 through CSV-04).

Output: Updated /bom/new page with creation method selection (wizard vs CSV import), full CSV import flow with preview/editing in BOMDisplay, and save-to-project capability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-csv-import/12-RESEARCH.md
@.planning/phases/12-csv-import/12-01-SUMMARY.md

Key existing files:
@src/routes/bom/new/+page.svelte (current BOM creation page - wizard only)
@src/routes/bom/new/+page.server.ts (loads user projects for save modal)
@src/lib/components/bom/BOMDisplay.svelte (BOM display with editing capabilities)
@src/lib/components/bom/CSVUpload.svelte (created in Plan 01)
@src/lib/components/bom/SaveToProjectModal.svelte (existing save modal)
@src/lib/types/bom.ts (BOM, BOMItem types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add creation method selection and CSV import flow to /bom/new</name>
  <files>src/routes/bom/new/+page.svelte</files>
  <action>
Modify `src/routes/bom/new/+page.svelte` to add a creation method selector and CSV import flow. The page currently has three view states: `wizard | loading | result`. We need to add a `choose` state before wizard and a path for CSV import.

**Changes to make:**

1. **Add imports:**
   ```typescript
   import CSVUpload from '$lib/components/bom/CSVUpload.svelte';
   ```

2. **Update view state type and add creation method state:**
   ```typescript
   type ViewState = 'choose' | 'wizard' | 'csv-upload' | 'loading' | 'result';
   let currentView = $state<ViewState>('choose');

   // Track creation source for BOM metadata
   type CreationMethod = 'wizard' | 'csv';
   let creationMethod = $state<CreationMethod>('wizard');
   ```

3. **Add CSV import handler:**
   ```typescript
   function handleCSVImport(items: BOMItem[]) {
     // Create a BOM object from imported items (same shape as AI-generated BOM)
     generatedBOM = {
       projectName: 'CSV Import',
       projectType: 'csv-import',
       generatedAt: new Date().toISOString(),
       items: items
     };
     creationMethod = 'csv';
     currentView = 'result';
   }
   ```

4. **Update handleStartOver to return to choose view:**
   ```typescript
   function handleStartOver() {
     generatedBOM = null;
     error = null;
     creationMethod = 'wizard';
     currentView = 'choose';
   }
   ```

5. **Add `choose` view - creation method selection:**
   This view shows BEFORE the wizard, presenting two options: AI Wizard and CSV Import.

   Layout: Two side-by-side cards (stack on mobile) within the existing page structure.

   Card 1 - "AI-Powered Generation":
   - Icon: sparkle/wand SVG
   - Title: "AI-Powered Generation"
   - Description: "Answer guided questions and let AI generate your complete bill of materials."
   - Button: "Start Wizard" (btn-primary)
   - On click: `currentView = 'wizard'; creationMethod = 'wizard';`

   Card 2 - "Import from CSV":
   - Icon: upload/document SVG
   - Title: "Import from CSV"
   - Description: "Upload an existing CSV file to create a bill of materials."
   - Subtext: "Supports the standard BOM export format."
   - Button: "Upload CSV" (btn-secondary)
   - On click: `currentView = 'csv-upload';`

   Style the cards to match the existing project aesthetic:
   - White background, subtle border, rounded corners (var(--radius-lg))
   - Hover state with slight shadow or border color change
   - Amber accent on the AI card (primary action)
   - Even widths, responsive (stack on mobile below 640px)

6. **Add `csv-upload` view:**
   Show the CSVUpload component with the same page header structure as the wizard view:
   - Back link to dashboard
   - Page title: "Import BOM from CSV"
   - Page description: "Upload a CSV file with your bill of materials."
   - Render `<CSVUpload onImport={handleCSVImport} onCancel={() => currentView = 'choose'} />`

7. **Update the wizard view:**
   The wizard view stays the same, but the back link in the wizard header should go back to choose view instead of dashboard. Add a "Back" button/link that sets `currentView = 'choose'` when on wizard view. Keep the dashboard back link in the choose view only.

   Actually, keep it simpler: the page header for wizard view keeps the "Back to Dashboard" link as-is (users in the wizard likely want to go back to dashboard). But add a secondary link or text "or choose a different method" that returns to choose view. Alternatively, just update the header for wizard and csv-upload views to show "Back" that goes to `choose`.

   Simplest approach: In the wizard view, change the back link to go to choose view. In the choose view, show the "Back to Dashboard" link.

8. **Update the result view:**
   The result view (BOMDisplay) stays the same. It already handles:
   - Editing (quantity change, visibility toggle, add item)
   - Export CSV
   - Save to project (via SaveToProjectModal)
   - Start Over

   All these work identically for CSV-imported BOMs because they operate on the same BOM type. No changes needed to BOMDisplay, SaveToProjectModal, or the save API endpoint.

9. **Add styles for the choose view:**
   ```css
   .method-cards {
     display: grid;
     grid-template-columns: 1fr 1fr;
     gap: var(--space-lg);
     margin-top: var(--space-xl);
   }

   @media (max-width: 640px) {
     .method-cards {
       grid-template-columns: 1fr;
     }
   }
   ```

   Style each card with:
   - `.method-card` - padding, border, border-radius, background, cursor pointer, transition
   - `.method-card:hover` - shadow, border-color change
   - Icon, title, description, button inside each card
   - Center-aligned content within cards

**Important notes:**
- The `handleWizardComplete` function stays unchanged - it still posts to `/api/bom/generate`
- The `handleSaveConfirm` function stays unchanged - it still posts to `/api/bom/save` with the generatedBOM object
- The save flow works for CSV imports because `generatedBOM` has the same BOM shape regardless of source
- The `projectType` for CSV imports is `'csv-import'` to distinguish from AI-generated BOMs in the database
- Do NOT modify +page.server.ts - it already loads projects which is all we need
  </action>
  <verify>
- `npm run check` passes
- `npm run build` succeeds
- `npm run dev` starts and navigating to /bom/new shows the creation method selection
- Clicking "Start Wizard" shows the existing wizard flow
- Clicking "Upload CSV" shows the CSVUpload component
- After successful CSV import, BOMDisplay shows with all editing features
- Save to Project button appears and works for imported BOMs
- Start Over returns to the creation method selection
- Page is responsive (cards stack on mobile)
  </verify>
  <done>
- /bom/new page shows creation method selection (AI Wizard vs CSV Import)
- AI wizard flow unchanged (still generates via /api/bom/generate)
- CSV upload flow: choose -> csv-upload -> result (BOMDisplay)
- Imported BOM displayed in BOMDisplay with full editing (CSV-03)
- Imported BOM can be saved to project via existing SaveToProjectModal (CSV-04)
- CSV import creates BOM with projectType 'csv-import' and current timestamp
- Start Over returns to method selection
- Responsive layout for method cards
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify round-trip CSV compatibility and build</name>
  <files></files>
  <action>
Verify the complete CSV import feature works end-to-end:

1. Run `npm run build` to ensure production build succeeds with all changes.

2. Run `npm run check` for full TypeScript verification.

3. Verify round-trip compatibility by examining the code flow:
   - Export format (csv.ts): headers are `Category, Name, Quantity, Unit, Description, Notes`
   - Import parsing (csv-import.ts): expects same headers via `transformHeader` with BOM strip and trim
   - Category mapping: export capitalizes first letter ("Lumber"), import lowercases for BOMCategory ("lumber")
   - Quantity: export uses `String(item.quantity)`, import uses `parseFloat()`
   - Description/Notes: export uses `item.description ?? ''`, import treats empty string as `undefined`

   This means a CSV exported from BOMDisplay can be re-imported via CSVUpload and produce the same BOM items (with new IDs and position values, which is expected).

4. Verify the save endpoint compatibility:
   - csv-import creates BOM with: `{ projectName: 'CSV Import', projectType: 'csv-import', generatedAt: new Date().toISOString(), items: [...] }`
   - Save endpoint (/api/bom/save) expects: `{ projectId, bom: { projectName, projectType, generatedAt, items[] } }`
   - Items need: `id, name, description?, quantity, unit, category, notes?, hidden?`
   - All fields present in BOMItem created by csv-import.ts
  </action>
  <verify>
- `npm run build` succeeds with exit code 0
- `npm run check` succeeds with no errors
- Export CSV headers match import expected headers
- BOM type shape from CSV import matches what save endpoint expects
  </verify>
  <done>
- Production build succeeds
- TypeScript compiles without errors
- Round-trip compatibility verified: exported CSV can be re-imported
- Save endpoint compatible with CSV-imported BOM structure
- All CSV requirements satisfied: CSV-01 (upload), CSV-02 (validation), CSV-03 (editing), CSV-04 (save)
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes - all TypeScript valid
2. `npm run build` passes - production build succeeds
3. /bom/new shows creation method selection (two cards)
4. AI wizard path works unchanged
5. CSV import path: upload -> validate -> preview in BOMDisplay -> edit -> save to project
6. Invalid CSV shows clear row-level validation errors
7. Page is responsive (method cards stack on mobile)
8. Exported CSV can be re-imported (round-trip)
</verification>

<success_criteria>
- CSV-01: User can upload CSV file on /bom/new page via drag-and-drop or button click
- CSV-02: Invalid CSV shows validation errors (missing columns, bad data, row numbers)
- CSV-03: Imported BOM appears in BOMDisplay with full editing (quantity, visibility, add items)
- CSV-04: Imported BOM can be saved to a project via existing SaveToProjectModal
- Round-trip: CSV exported from app can be re-imported to produce equivalent BOM
- Build passes, TypeScript passes, no regressions to existing wizard flow
</success_criteria>

<output>
After completion, create `.planning/phases/12-csv-import/12-02-SUMMARY.md`
</output>
