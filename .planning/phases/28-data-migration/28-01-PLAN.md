---
wave: 1
depends_on: []
files_modified:
  - scripts/migrate-v4-data.ts
autonomous: no
---

# Plan 28-01: v4.0 Data Migration Script

**Objective:** Create and execute data migration script to update existing BOM data for v4.0 lumber categorization changes.

## Tasks

<task id="1">
**Create migration script**

Create `scripts/migrate-v4-data.ts` following the existing `seed-templates.ts` pattern:
- Connect to database (local or Turso)
- Pre-migration counts for affected records
- Execute three UPDATE operations (MIG-01, MIG-02, MIG-03)
- Post-migration verification
- Exit with appropriate code
</task>

<task id="2">
**Execute migration on local database**

Run: `npx tsx scripts/migrate-v4-data.ts`

Expected output:
- MIG-01: Updates lumber → hardwood category
- MIG-02: Sets cutItem=true for lumber categories
- MIG-03: Copies height values to thickness field
</task>

<task id="3" checkpoint="human-verify">
**Verify full app functionality**

Manual smoke test checklist:
- [ ] Create new BOM via wizard - verify hardwood/common/sheet categories work
- [ ] Edit existing BOM item - verify dimensions display correctly
- [ ] Export BOM to CSV - verify CutItem and Thickness columns
- [ ] Import BOM from CSV - verify all 6 categories parse
- [ ] Navigate to Cut List from BOM - verify cutItem items show
</task>

## Verification

```yaml
must_haves:
  - No items remain with category='lumber' in database
  - All hardwood/common/sheet items have cutItem=true
  - All items with height values have thickness populated
  - App smoke test passes (BOM CRUD, CSV export/import, cut list)
```

## Technical Notes

1. **Idempotent Design:** Script is safe to run multiple times
2. **Raw SQL for MIG-03:** Drizzle ORM cannot reference columns in `.set()`, so height→thickness uses `client.execute()` directly
3. **Production Run:** Set `TURSO_DATABASE_URL` and `TURSO_AUTH_TOKEN` environment variables

## Run Commands

```bash
# Local development
npx tsx scripts/migrate-v4-data.ts

# Production (after backup!)
# turso db shell <db-name> .dump > backup-$(date +%Y%m%d).sql
TURSO_DATABASE_URL=libsql://... TURSO_AUTH_TOKEN=... npx tsx scripts/migrate-v4-data.ts
```
