---
phase: 17-bom-refinements
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/lib/components/bom/BOMItem.svelte
  - src/lib/components/bom/BOMCategory.svelte
  - src/lib/utils/board-feet.ts
autonomous: true

must_haves:
  truths:
    - "Lumber items display dimension input fields (L x W x H)"
    - "Dimension fields accept fractional inches (e.g., 3/4, 1-1/2)"
    - "Board feet calculated as (L x W x H) / 144"
    - "Each lumber item shows its board feet"
    - "Lumber category header shows total board feet of visible items"
  artifacts:
    - path: "src/lib/utils/board-feet.ts"
      provides: "Board feet calculation and fractional inch parsing"
      exports: ["calculateBoardFeet", "parseFractionalInches", "formatBoardFeet"]
    - path: "src/lib/components/bom/BOMItem.svelte"
      provides: "Dimension fields for lumber items with board feet display"
      contains: "onDimensionChange"
    - path: "src/lib/components/bom/BOMCategory.svelte"
      provides: "Total board feet display in lumber header"
      contains: "totalBoardFeet"
  key_links:
    - from: "src/lib/components/bom/BOMItem.svelte"
      to: "src/lib/utils/board-feet.ts"
      via: "import calculateBoardFeet"
      pattern: "import.*board-feet"
    - from: "src/lib/components/bom/BOMCategory.svelte"
      to: "src/lib/utils/board-feet.ts"
      via: "import for total calculation"
      pattern: "import.*board-feet"
---

<objective>
Add lumber dimension input fields and board feet calculations to BOM items.

Purpose: Enable accurate material planning by tracking lumber dimensions and displaying board feet for cost estimation.
Output: Dimension inputs for lumber items, board feet per item, total board feet per category.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-bom-refinements/17-01-SUMMARY.md
@src/lib/components/bom/BOMItem.svelte
@src/lib/components/bom/BOMCategory.svelte
@src/lib/types/bom.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create board feet utility module</name>
  <files>src/lib/utils/board-feet.ts</files>
  <action>
Create new utility module `src/lib/utils/board-feet.ts` with:

1. **parseFractionalInches(input: string): number | null**
   Parse user input that may contain fractions:
   - "12" -> 12
   - "3/4" -> 0.75
   - "1-1/2" or "1 1/2" -> 1.5
   - "6.5" -> 6.5
   - Invalid input -> null

   Implementation approach:
   - Trim input
   - Handle pure decimal: parseFloat if no slash
   - Handle pure fraction: "3/4" split by "/" and divide
   - Handle mixed: "1-1/2" or "1 1/2" - split on space/hyphen, parse whole + fraction

2. **calculateBoardFeet(length: number, width: number, height: number): number**
   Formula: (L x W x H) / 144
   - All dimensions in inches
   - Returns board feet as decimal
   - Handle zero/negative gracefully (return 0)

3. **formatBoardFeet(bf: number): string**
   Format for display:
   - 0 -> "0 bf"
   - 1.5 -> "1.5 bf"
   - 12.333... -> "12.33 bf" (2 decimal places max, trim trailing zeros)

4. **formatDimension(value: number | undefined): string**
   Format dimension for display:
   - undefined -> ""
   - 12 -> "12"
   - 0.75 -> "3/4" (convert common decimals to fractions)
   - 1.5 -> "1-1/2"
   - Other decimals -> keep as decimal

Export all four functions.
  </action>
  <verify>
    - `npm run check` passes
    - Create simple test cases mentally:
      - parseFractionalInches("3/4") === 0.75
      - parseFractionalInches("1-1/2") === 1.5
      - calculateBoardFeet(12, 6, 1) === 0.5
      - formatBoardFeet(1.5) === "1.5 bf"
  </verify>
  <done>
    - board-feet.ts exports parseFractionalInches, calculateBoardFeet, formatBoardFeet, formatDimension
    - Functions handle edge cases (null, zero, negative)
    - TypeScript types are correct
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dimension inputs and board feet to BOMItem</name>
  <files>src/lib/components/bom/BOMItem.svelte</files>
  <action>
Update BOMItem.svelte to show dimension fields for lumber items:

1. Add new props to interface:
   ```typescript
   onDimensionChange?: (id: string, dimensions: { length?: number; width?: number; height?: number }) => void;
   ```

2. Import board feet utilities:
   ```typescript
   import { calculateBoardFeet, formatBoardFeet, parseFractionalInches } from '$lib/utils/board-feet';
   ```

3. Add state for dimension editing (similar to quantity editing):
   ```typescript
   let editingDimension = $state<'length' | 'width' | 'height' | null>(null);
   let dimensionInputValue = $state('');
   ```

4. Add dimension display/edit section (show only for lumber category):
   ```svelte
   {#if item.category === 'lumber'}
     <div class="dimension-section">
       <!-- Length input -->
       <div class="dimension-field">
         <label class="dimension-label">L</label>
         <!-- Click-to-edit pattern like quantity -->
         {#if editingDimension === 'length'}
           <input ... />
         {:else}
           <button onclick={() => startDimensionEdit('length')} ...>
             {item.length ?? '-'}"
           </button>
         {/if}
       </div>
       <span class="dimension-separator">x</span>
       <!-- Width input (same pattern) -->
       <div class="dimension-field">
         <label class="dimension-label">W</label>
         ...
       </div>
       <span class="dimension-separator">x</span>
       <!-- Height/Thickness input (same pattern) -->
       <div class="dimension-field">
         <label class="dimension-label">T</label>
         ...
       </div>

       <!-- Board feet display -->
       {#if item.length && item.width && item.height}
         <span class="board-feet">
           = {formatBoardFeet(calculateBoardFeet(item.length, item.width, item.height) * item.quantity)}
         </span>
       {/if}
     </div>
   {/if}
   ```

5. Add dimension edit handlers:
   - startDimensionEdit(dim: 'length' | 'width' | 'height')
   - commitDimensionEdit() - parse fractional inches, call onDimensionChange
   - cancelDimensionEdit()

6. Add CSS for dimension section:
   ```css
   .dimension-section {
     display: flex;
     align-items: center;
     gap: var(--space-xs);
     margin-left: var(--space-md);
     font-size: 0.8125rem;
   }

   .dimension-field {
     display: flex;
     align-items: center;
     gap: 2px;
   }

   .dimension-label {
     font-size: 0.6875rem;
     color: var(--color-ink-muted);
     text-transform: uppercase;
   }

   .dimension-value {
     padding: 2px 6px;
     min-width: 36px;
     text-align: center;
     background: none;
     border: none;
     border-radius: var(--radius-sm);
     cursor: pointer;
     color: var(--color-ink);
   }

   .dimension-value:hover {
     background: rgba(93, 64, 55, 0.08);
   }

   .dimension-separator {
     color: var(--color-ink-muted);
   }

   .dimension-input {
     width: 48px;
     padding: 2px 4px;
     border: 1px solid var(--color-walnut);
     border-radius: var(--radius-sm);
     font-size: 0.8125rem;
     text-align: center;
   }

   .board-feet {
     margin-left: var(--space-sm);
     padding: 2px 8px;
     background: rgba(93, 64, 55, 0.06);
     border-radius: var(--radius-sm);
     color: var(--color-walnut);
     font-weight: 500;
   }
   ```

7. Mobile responsive: Stack dimensions vertically on small screens.
  </action>
  <verify>
    - `npm run check` passes
    - `npm run dev` and view a BOM with lumber items
    - Lumber items show L x W x T dimension fields
    - Non-lumber items do NOT show dimension fields
    - Clicking dimension shows input
    - Entering "3/4" parses to 0.75
    - Board feet displays when all three dimensions have values
  </verify>
  <done>
    - Lumber items display L x W x T dimension fields
    - Click-to-edit pattern for dimension input
    - Fractional inch parsing works (3/4, 1-1/2)
    - Board feet shown when all dimensions present (quantity factored in)
    - Non-lumber items unchanged
  </done>
</task>

<task type="auto">
  <name>Task 3: Add total board feet to lumber category header</name>
  <files>src/lib/components/bom/BOMCategory.svelte</files>
  <action>
Update BOMCategory.svelte to show total board feet for lumber category:

1. Import board feet utility:
   ```typescript
   import { calculateBoardFeet, formatBoardFeet } from '$lib/utils/board-feet';
   ```

2. Add prop for dimension change handler:
   ```typescript
   onDimensionChange?: (id: string, dimensions: { length?: number; width?: number; height?: number }) => void;
   ```

3. Calculate total board feet for visible lumber items:
   ```typescript
   const totalBoardFeet = $derived(() => {
     if (category !== 'lumber') return 0;
     return items
       .filter(i => !i.hidden && i.length && i.width && i.height)
       .reduce((sum, i) => sum + calculateBoardFeet(i.length!, i.width!, i.height!) * i.quantity, 0);
   });
   ```

4. Display total board feet in category header (lumber only):
   ```svelte
   <span class="item-count">
     {#if hasHidden}
       {visibleCount} of {totalCount}
     {:else}
       {totalCount}
     {/if}
     {totalCount === 1 ? 'item' : 'items'}
     {#if category === 'lumber' && totalBoardFeet() > 0}
       <span class="board-feet-total">({formatBoardFeet(totalBoardFeet())})</span>
     {/if}
   </span>
   ```

5. Pass onDimensionChange to BOMItem:
   ```svelte
   <BOMItem {item} {onQuantityChange} {onToggleVisibility} {onDimensionChange} />
   ```

6. Add styling for board feet total:
   ```css
   .board-feet-total {
     margin-left: var(--space-xs);
     color: var(--color-walnut);
     font-weight: 500;
   }
   ```
  </action>
  <verify>
    - `npm run check` passes
    - View a BOM with lumber items that have dimensions
    - Lumber category header shows "(X.XX bf)" next to item count
    - Total updates when dimensions change
    - Total only counts visible items
    - Non-lumber categories show no board feet
  </verify>
  <done>
    - Lumber category header displays total board feet of visible items
    - Total updates reactively when dimensions change
    - Only visible lumber items with complete dimensions counted
    - Hardware/Finishes/Consumables categories unchanged
  </done>
</task>

</tasks>

<verification>
1. Utility verification:
   - `npm run check` passes
   - Board feet calculation: 12" x 6" x 1" = 0.5 bf

2. UI verification:
   - Lumber items show L x W x T dimension inputs
   - Entering "3/4" parses correctly to 0.75
   - Board feet shows per item when all dimensions filled
   - Category header shows total board feet

3. Integration verification:
   - Changing quantity updates board feet
   - Changing dimensions updates board feet
   - Hiding item removes from total
</verification>

<success_criteria>
1. Lumber items display editable L x W x T dimension fields
2. Dimension fields accept and parse fractional inches (3/4, 1-1/2)
3. Board feet calculated as (L x W x H) / 144 * quantity
4. Each lumber item shows its board feet when dimensions complete
5. Lumber category header shows sum of visible items' board feet
6. Non-lumber items unaffected (no dimension fields)
</success_criteria>

<output>
After completion, create `.planning/phases/17-bom-refinements/17-02-SUMMARY.md`
</output>
