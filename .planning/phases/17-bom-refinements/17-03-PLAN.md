---
phase: 17-bom-refinements
plan: 03
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/lib/utils/csv.ts
  - src/lib/utils/csv-import.ts
autonomous: true

must_haves:
  truths:
    - "CSV export includes Length, Width, Height columns"
    - "Dimension columns appear after Notes column"
    - "Non-lumber items have empty dimension values in export"
    - "CSV import parses dimension columns when present"
    - "Imported lumber items have dimensions populated"
    - "Import still works with old CSVs (no dimension columns)"
  artifacts:
    - path: "src/lib/utils/csv.ts"
      provides: "CSV export with dimension columns"
      contains: "Length"
    - path: "src/lib/utils/csv-import.ts"
      provides: "CSV import with dimension parsing"
      contains: "Length"
  key_links:
    - from: "src/lib/utils/csv.ts"
      to: "src/lib/types/bom.ts"
      via: "BOMItem dimension fields"
      pattern: "item\\.length"
    - from: "src/lib/utils/csv-import.ts"
      to: "src/lib/types/bom.ts"
      via: "BOMItem dimension fields"
      pattern: "length.*width.*height"
---

<objective>
Update CSV export and import to handle lumber dimension columns.

Purpose: Enable round-trip of lumber dimensions through CSV for backup, sharing, and spreadsheet editing.
Output: CSV export includes dimension columns, import parses dimensions when present.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/17-bom-refinements/17-01-SUMMARY.md
@src/lib/utils/csv.ts
@src/lib/utils/csv-import.ts
@src/lib/types/bom.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dimension columns to CSV export</name>
  <files>src/lib/utils/csv.ts</files>
  <action>
Update generateBOMCSV() in csv.ts to include dimension columns:

1. Update headers array:
   ```typescript
   const headers = ['Category', 'Name', 'Quantity', 'Unit', 'Description', 'Notes', 'Length', 'Width', 'Height'];
   ```

2. Update row generation to include dimension values:
   ```typescript
   const rows = visibleItems.map((item) => {
     const categoryDisplay = item.category.charAt(0).toUpperCase() + item.category.slice(1);

     return [
       escapeCSVField(categoryDisplay),
       escapeCSVField(item.name),
       escapeCSVField(String(item.quantity)),
       escapeCSVField(item.unit),
       escapeCSVField(item.description ?? ''),
       escapeCSVField(item.notes ?? ''),
       // Dimension columns - only for lumber, empty string otherwise
       escapeCSVField(item.length != null ? String(item.length) : ''),
       escapeCSVField(item.width != null ? String(item.width) : ''),
       escapeCSVField(item.height != null ? String(item.height) : '')
     ].join(',');
   });
   ```

Note: Use `item.length != null` (not `!== null`) to handle both null and undefined.

The dimension columns will be empty for non-lumber items, which is correct behavior since only lumber items have dimensions.
  </action>
  <verify>
    - `npm run check` passes
    - Export a BOM with lumber items that have dimensions
    - CSV has 9 columns: Category, Name, Quantity, Unit, Description, Notes, Length, Width, Height
    - Lumber items show dimension values
    - Non-lumber items have empty dimension columns
  </verify>
  <done>
    - CSV export includes Length, Width, Height columns
    - Lumber dimensions exported as decimal numbers
    - Non-lumber items have empty dimension values
    - Backward compatible (just adds columns)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dimension parsing to CSV import</name>
  <files>src/lib/utils/csv-import.ts</files>
  <action>
Update csv-import.ts to handle dimension columns:

1. Update validateRow() to validate dimension fields when present:
   ```typescript
   // Dimensions are optional - only validate if present
   const length = row.Length?.trim() || '';
   const width = row.Width?.trim() || '';
   const height = row.Height?.trim() || '';

   // If any dimension is provided, validate it's a valid positive number
   if (length) {
     const parsed = parseFloat(length);
     if (isNaN(parsed) || parsed <= 0) {
       errors.push({
         row: rowNumber,
         field: 'Length',
         message: `Invalid length: ${length}. Must be a positive number`,
         code: 'INVALID_NUMBER'
       });
     }
   }
   if (width) {
     const parsed = parseFloat(width);
     if (isNaN(parsed) || parsed <= 0) {
       errors.push({
         row: rowNumber,
         field: 'Width',
         message: `Invalid width: ${width}. Must be a positive number`,
         code: 'INVALID_NUMBER'
       });
     }
   }
   if (height) {
     const parsed = parseFloat(height);
     if (isNaN(parsed) || parsed <= 0) {
       errors.push({
         row: rowNumber,
         field: 'Height',
         message: `Invalid height: ${height}. Must be a positive number`,
         code: 'INVALID_NUMBER'
       });
     }
   }
   ```

2. Update rowToBOMItem() to include dimension fields:
   ```typescript
   export function rowToBOMItem(row: Record<string, string>, position: number): BOMItem {
     const description = row.Description?.trim() || undefined;
     const notes = row.Notes?.trim() || undefined;

     // Parse optional dimension fields
     const length = row.Length?.trim() ? parseFloat(row.Length.trim()) : undefined;
     const width = row.Width?.trim() ? parseFloat(row.Width.trim()) : undefined;
     const height = row.Height?.trim() ? parseFloat(row.Height.trim()) : undefined;

     return {
       id: `csv-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
       name: row.Name.trim(),
       category: row.Category.trim().toLowerCase() as BOMCategory,
       quantity: parseFloat(row.Quantity.trim()),
       unit: row.Unit.trim(),
       description: description && description.length > 0 ? description : undefined,
       notes: notes && notes.length > 0 ? notes : undefined,
       hidden: false,
       // Include dimensions if provided and valid
       ...(length && !isNaN(length) && length > 0 ? { length } : {}),
       ...(width && !isNaN(width) && width > 0 ? { width } : {}),
       ...(height && !isNaN(height) && height > 0 ? { height } : {})
     };
   }
   ```

3. Note: DO NOT add Length/Width/Height to required headers in validateHeaders().
   These columns are optional for backward compatibility with old CSVs.
  </action>
  <verify>
    - `npm run check` passes
    - Import a CSV with dimension columns - dimensions are populated on BOMItem
    - Import an old CSV without dimension columns - still works, no dimensions
    - Import with invalid dimension (negative, text) - shows validation error
  </verify>
  <done>
    - CSV import parses Length, Width, Height columns when present
    - Dimensions optional (old CSVs still work)
    - Invalid dimensions generate validation errors
    - Imported lumber items have dimensions populated
  </done>
</task>

</tasks>

<verification>
1. Export verification:
   - Export a BOM with lumber items that have dimensions
   - Open CSV in text editor: confirm 9 columns
   - Lumber rows have dimension values
   - Hardware/finishes/consumables rows have empty dimension columns

2. Import verification:
   - Export a BOM, then import the same CSV
   - Dimensions should round-trip correctly
   - Import an old CSV (6 columns) - should work without dimensions

3. Error handling:
   - CSV with negative dimensions shows validation error
   - CSV with text in dimension column shows validation error
</verification>

<success_criteria>
1. CSV export includes Length, Width, Height columns after Notes
2. Lumber items export their dimension values
3. Non-lumber items have empty dimension columns
4. CSV import parses dimension columns when present
5. Old CSVs (without dimension columns) still import successfully
6. Invalid dimensions in import show clear error messages
</success_criteria>

<output>
After completion, create `.planning/phases/17-bom-refinements/17-03-SUMMARY.md`
</output>
