---
phase: 19-linear-optimizer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/components/cutlist/LinearCutDiagram.svelte
  - src/lib/components/cutlist/OptimizationResults.svelte
  - src/routes/cutlist/+page.svelte
autonomous: true

# Phase 18 provides the input forms for CUT-11, CUT-12, CUT-13
# This plan adds visualization (CUT-15) and assumes input forms work
phase_dependencies:
  - phase: 18
    provides: ["CUT-11", "CUT-12", "CUT-13"]
    status: "verified complete"

must_haves:
  truths:
    - "Each stock piece displays as a visual bar showing cuts and waste"
    - "Cuts appear as proportional green rectangles on the stock bar"
    - "Kerf gaps appear as thin red lines between cuts"
    - "Waste appears as yellow/amber region at the end of stock"
    - "Cut length labels display inside cuts (if space permits)"
    - "Total linear feet summary displays used vs available"
  artifacts:
    - path: "src/lib/components/cutlist/LinearCutDiagram.svelte"
      provides: "SVG visualization of cuts on a single stock piece"
      min_lines: 80
    - path: "src/lib/components/cutlist/OptimizationResults.svelte"
      provides: "Results display with integrated diagrams and linear feet summary"
      contains: "LinearCutDiagram"
  key_links:
    - from: "src/lib/components/cutlist/OptimizationResults.svelte"
      to: "src/lib/components/cutlist/LinearCutDiagram.svelte"
      via: "import and render for each plan"
      pattern: "LinearCutDiagram"
    - from: "src/routes/cutlist/+page.svelte"
      to: "src/lib/components/cutlist/OptimizationResults.svelte"
      via: "passing kerf prop for diagram rendering"
      pattern: "kerf={kerf}"
---

<objective>
Create visual SVG diagrams showing cut placement on stock pieces for linear mode.

Purpose: Users need to visualize how cuts are arranged on stock to verify the optimization and plan their actual cuts in the shop. Visual diagrams make waste obvious at a glance.

Output: New `LinearCutDiagram.svelte` component and enhanced `OptimizationResults.svelte` with diagram integration and linear feet summary.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-linear-optimizer/19-RESEARCH.md

@src/lib/components/cutlist/OptimizationResults.svelte
@src/lib/server/cutOptimizer.ts
@src/lib/types/cutlist.ts
@src/routes/cutlist/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LinearCutDiagram Component</name>
  <files>src/lib/components/cutlist/LinearCutDiagram.svelte</files>
  <action>
Create a new Svelte component that renders a single stock piece with its cuts as an SVG diagram.

**Props interface:**
```typescript
interface Props {
  plan: StockPlan;  // From cutOptimizer.ts
  kerf: number;     // Kerf width in inches
  index: number;    // Stock piece number (0-based)
}
```

**SVG structure:**
- Fixed viewBox width (800 units) that scales to container width
- Height ~120 units to accommodate bar + labels
- Stock outline as a rounded rect (full width)
- Cuts as green filled rects, positioned left-to-right
- Kerf gaps as thin red rects between cuts
- Waste as amber/yellow dashed rect at end

**Scale calculation:**
```typescript
const svgWidth = 800;
const scale = $derived(svgWidth / plan.stockLength);
```

**Cut positions (derived):**
Track cumulative x position as you iterate through cuts:
```typescript
let x = 0;
plan.cuts.forEach((cut, i) => {
  // Draw cut at x with width = cut.length * scale
  x += cut.length * scale;
  // If not last cut, draw kerf gap
  if (i < plan.cuts.length - 1) {
    // Kerf rect at x with width = kerf * scale
    x += kerf * scale;
  }
});
// Waste starts at x, width = (plan.wasteLength * scale)
```

**Text labels:**
- Show cut length inside the cut rect (e.g., `24"`)
- Only display if cut width > 30px (scaled) to avoid cramped text
- Use `text-anchor="middle"` and `dominant-baseline="middle"` for centering
- Font size 10-11px, white text on green background
- Waste label shows "waste" if space permits

**Colors (match existing waste color coding):**
- Cuts: `#10b981` (green-500) with `#059669` stroke
- Kerf: `#dc2626` (red-600) at 60% opacity
- Waste: Color based on waste percentage:
  - <10%: `#10b981` (green)
  - <25%: `#fbbf24` (amber)
  - >=25%: `#ef4444` (red)

**Container structure:**
```svelte
<div class="diagram-container">
  <div class="diagram-header">
    <span class="stock-label">#{index + 1} {plan.stockLabel}</span>
    <span class="stock-dimensions">{plan.stockLength}"</span>
  </div>
  <svg viewBox="0 0 800 120">
    <!-- Stock outline, cuts, kerf, waste -->
  </svg>
  <div class="diagram-footer">
    <span class="cuts-count">{plan.cuts.length} cuts</span>
    <span class="waste-amount">{wasteLength}" waste ({wastePercent}%)</span>
  </div>
</div>
```

**Styling:**
- Container: white background, subtle border, rounded corners
- Responsive: SVG width 100% of container
- Consistent with project's amber/woodworking theme
  </action>
  <verify>
Component can be imported without errors:
```bash
npm run check
```

Note: Full visual verification happens after integration in Task 2.
  </verify>
  <done>
- LinearCutDiagram.svelte created with Props interface
- SVG renders stock bar with proportional cuts
- Kerf gaps visible as red lines between cuts
- Waste region visible at end with color coding
- Text labels show cut lengths (when space permits)
- Header shows stock number and dimensions
- Footer shows cut count and waste amount
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Diagrams and Linear Feet Summary</name>
  <files>src/lib/components/cutlist/OptimizationResults.svelte, src/routes/cutlist/+page.svelte</files>
  <action>
Update OptimizationResults to display diagrams and linear feet summary.

**1. Update OptimizationResults.svelte Props:**

Add `kerf` prop to receive kerf value for diagram rendering:
```typescript
interface Props {
  result: OptimizationResult;
  mode: CutListMode;
  kerf: number;  // NEW
}

let { result, mode, kerf }: Props = $props();
```

**2. Import LinearCutDiagram:**
```typescript
import LinearCutDiagram from './LinearCutDiagram.svelte';
```

**3. Add Linear Feet Summary to summary-grid (for linear mode only):**

After the existing summary cards, add two new cards when `mode === 'linear'`:

```svelte
{#if mode === 'linear'}
  <div class="summary-card">
    <div class="summary-label">Stock Used</div>
    <div class="summary-value">
      {result.summary.totalLinearFeetUsed.toFixed(1)} ft
    </div>
  </div>
  <div class="summary-card">
    <div class="summary-label">Stock Available</div>
    <div class="summary-value">
      {result.summary.totalLinearFeetAvailable.toFixed(1)} ft
    </div>
  </div>
{/if}
```

**4. Add Diagrams Section:**

Insert a new section BETWEEN the summary and the plans-grid when `mode === 'linear'`:

```svelte
{#if mode === 'linear' && result.plans.length > 0}
  <div class="diagrams-section">
    <h3 class="diagrams-title">Cut Diagrams</h3>
    <div class="diagrams-list">
      {#each result.plans as plan, index (plan.stockId)}
        <LinearCutDiagram {plan} {kerf} {index} />
      {/each}
    </div>
  </div>
{/if}
```

**5. Add styles for diagrams section:**
```css
.diagrams-section {
  display: flex;
  flex-direction: column;
  gap: var(--space-md);
}

.diagrams-title {
  font-family: var(--font-display);
  font-size: 1.25rem;
  color: var(--color-ink);
  margin: 0;
}

.diagrams-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-md);
}
```

**6. Update +page.svelte to pass kerf:**

In the OptimizationResults usage, add kerf prop:
```svelte
<OptimizationResults {result} {mode} {kerf} />
```

This passes the kerf state variable to the results component for diagram rendering.
  </action>
  <verify>
```bash
npm run check
npm run dev
```

Test visually at http://localhost:5173/cutlist:

1. **Diagram rendering:**
   - Select Linear mode
   - Add cuts: 24", 18", 12" (qty 1 each)
   - Add stock: 96" (qty 1)
   - Set kerf: 0.125"
   - Click Optimize
   - Verify: Diagram shows green cuts with red kerf gaps between
   - Verify: Yellow/amber waste region at end

2. **Multiple stock pieces:**
   - Add more cuts to require 2+ stock pieces
   - Verify: Each stock piece gets its own diagram
   - Verify: Diagrams numbered #1, #2, etc.

3. **Linear feet summary:**
   - Verify: Summary shows "Stock Used: X.X ft"
   - Verify: Summary shows "Stock Available: X.X ft"

4. **Responsive:**
   - Resize browser window
   - Verify: Diagrams scale with container width
  </verify>
  <done>
- OptimizationResults accepts kerf prop
- LinearCutDiagram imported and rendered for each plan
- Diagrams section displays between summary and plans grid
- Linear feet summary cards show used vs available
- +page.svelte passes kerf to OptimizationResults
- Diagrams scale responsively with container
  </done>
</task>

</tasks>

<verification>
Full visual and functional verification:

```bash
npm run check
npm run dev
```

Navigate to http://localhost:5173/cutlist and test:

1. **Linear mode with diagrams:**
   - Cuts: 24", 18", 12", 6" (qty 1 each)
   - Stock: 48" (qty 2)
   - Kerf: 0.125"
   - Expected: Visual diagram for each stock piece showing cut layout

2. **Verify diagram accuracy:**
   - Cuts should be proportionally sized
   - Kerf gaps visible between cuts (thin red lines)
   - Waste region correctly positioned at end

3. **Verify linear feet summary:**
   - Numbers convert correctly from inches to feet
   - "Used" reflects actual stock pieces used
   - "Available" reflects total user-provided stock

4. **Sheet mode unchanged:**
   - Switch to Sheet mode
   - Verify: No diagrams shown (diagrams are linear-only for now)
   - Verify: No linear feet summary shown
</verification>

<success_criteria>
1. LinearCutDiagram.svelte renders SVG visualization of cuts on stock
2. Cuts, kerf gaps, and waste are visually distinct with correct colors
3. Cut length labels display inside cuts (when space permits)
4. OptimizationResults shows "Cut Diagrams" section for linear mode
5. Linear feet summary shows used vs available in feet
6. Diagrams scale responsively
7. Sheet mode is unaffected (no diagrams, no linear feet)
</success_criteria>

<output>
After completion, create `.planning/phases/19-linear-optimizer/19-02-SUMMARY.md`
</output>
