---
phase: 21-bom-integration-shop-checklist
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/schema.ts
  - src/lib/components/cutlist/ShopChecklist.svelte
  - src/routes/api/cutlist/[id]/cuts/[cutId]/+server.ts
  - src/routes/cutlist/[id]/+page.svelte
  - src/routes/cutlist/[id]/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "User can view saved cut list as shop checklist"
    - "User can mark individual cuts as complete with checkbox"
    - "Checklist shows progress indicator (X of Y complete)"
    - "Completion state persists to database across page refreshes"
  artifacts:
    - path: "src/lib/server/schema.ts"
      provides: "completed and completedAt columns on cutListCuts table"
      contains: "completed.*integer.*mode.*boolean"
    - path: "src/lib/components/cutlist/ShopChecklist.svelte"
      provides: "Checklist view with completion tracking"
      min_lines: 100
    - path: "src/routes/api/cutlist/[id]/cuts/[cutId]/+server.ts"
      provides: "PATCH endpoint for toggling cut completion"
      exports: ["PATCH"]
    - path: "src/routes/cutlist/[id]/+page.svelte"
      provides: "View page for saved cut list with checklist"
      min_lines: 80
  key_links:
    - from: "src/lib/components/cutlist/ShopChecklist.svelte"
      to: "/api/cutlist/[id]/cuts/[cutId]"
      via: "fetch PATCH for completion toggle"
      pattern: "fetch.*api/cutlist.*PATCH"
    - from: "src/routes/cutlist/[id]/+page.server.ts"
      to: "db.query.cutLists"
      via: "Drizzle query with nested cuts"
      pattern: "db\\.query\\.cutLists\\.findFirst"
---

<objective>
Implement shop checklist feature for saved cut lists with persistent completion tracking.

Purpose: Allow users to track progress while making cuts in the shop, with state that persists across sessions and devices.

Output: New `/cutlist/[id]` route displaying saved cut list as checklist with completion checkboxes and progress indicator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-bom-integration-shop-checklist/21-RESEARCH.md

# Existing patterns
@src/lib/server/schema.ts
@src/lib/components/cutlist/OptimizationResults.svelte
@src/routes/api/cutlist/save/+server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Schema with Completion Fields</name>
  <files>src/lib/server/schema.ts</files>
  <action>
Add completion tracking columns to the cutListCuts table.

**Schema changes:**
Add two new columns to cutListCuts table definition:
```typescript
// After position column, add:
completed: integer('completed', { mode: 'boolean' }).notNull().default(false),
completedAt: integer('completed_at', { mode: 'timestamp' })
```

**Important:**
- completed defaults to false (not nullable)
- completedAt is nullable (only set when completed = true)
- SQLite uses integer with mode: 'boolean' for boolean columns
- SQLite uses integer with mode: 'timestamp' for Date columns

After schema change, run: `npm run db:push` to apply migration.
  </action>
  <verify>`npm run db:push` succeeds without errors</verify>
  <done>cutListCuts table has completed (boolean) and completedAt (timestamp) columns</done>
</task>

<task type="auto">
  <name>Task 2: Create API Endpoint for Completion Toggle</name>
  <files>src/routes/api/cutlist/[id]/cuts/[cutId]/+server.ts</files>
  <action>
Create PATCH endpoint to toggle cut completion status.

**Implementation:**
1. Create directory structure: `src/routes/api/cutlist/[id]/cuts/[cutId]/`
2. Import: json, RequestHandler, requireAuth, db, cutLists, cutListCuts, eq, and

3. PATCH handler:
   - Call requireAuth(event) for authentication
   - Extract cutListId and cutId from params
   - Parse request body: { completed: boolean }
   - Validate cutListId owns the cut (join check)
   - Verify user owns the cut list via userId
   - Update cutListCuts:
     ```typescript
     await db.update(cutListCuts)
       .set({
         completed: body.completed,
         completedAt: body.completed ? new Date() : null
       })
       .where(eq(cutListCuts.id, cutId))
     ```
   - Return { success: true }

4. Error handling:
   - 400 if completed not boolean
   - 404 if cut not found
   - 403 if user doesn't own the cut list
   - 500 for database errors

**Security:** Always verify ownership chain: user -> cutList -> cut
  </action>
  <verify>Test with curl: `curl -X PATCH http://localhost:5173/api/cutlist/{id}/cuts/{cutId} -H "Content-Type: application/json" -d '{"completed": true}'`</verify>
  <done>PATCH endpoint updates cut completion status with proper ownership validation</done>
</task>

<task type="auto">
  <name>Task 3: Create ShopChecklist Component and View Page</name>
  <files>
    src/lib/components/cutlist/ShopChecklist.svelte
    src/routes/cutlist/[id]/+page.svelte
    src/routes/cutlist/[id]/+page.server.ts
  </files>
  <action>
Create the checklist component and view page for saved cut lists.

**ShopChecklist.svelte:**

Props interface:
```typescript
interface ChecklistCut {
  id: string;
  length: number;
  width: number | null;
  quantity: number;
  label: string | null;
  completed: boolean;
}

interface Props {
  cuts: ChecklistCut[];
  cutListId: string;
  mode: 'linear' | 'sheet';
}
```

Implementation:
1. Accept props with $props()
2. Create local cuts state: `let localCuts = $state<ChecklistCut[]>(initialCuts)`
3. Derive progress stats:
   ```typescript
   const progress = $derived({
     total: localCuts.length,
     completed: localCuts.filter(c => c.completed).length,
     percentage: Math.round((completed / total) * 100) || 0
   });
   ```

4. toggleComplete function with optimistic updates:
   - Update localCuts immediately
   - Fire fetch PATCH to API (no await)
   - On error, revert localCuts to previous state
   - Log error to console

5. Render:
   - Progress header: "Shop Checklist" title
   - Progress bar (horizontal, fills based on percentage)
   - Progress text: "X of Y cuts complete (Z%)"
   - Cut list with checkboxes:
     - Each cut as row with checkbox, label/dimensions
     - Completed cuts: opacity reduced, text strikethrough
     - Format dimensions: `{length}"` or `{length}" x {width}"`

**Style notes:**
- Progress bar: full width, 8px height, amber fill (--color-walnut)
- Completed items: opacity 0.6, line-through text
- Match existing cutlist component styling

**+page.server.ts:**
1. Import requireAuth, db, cutLists, eq
2. Load function:
   - requireAuth for user
   - Extract id from params
   - Query cutList with nested cuts:
     ```typescript
     db.query.cutLists.findFirst({
       where: and(
         eq(cutLists.id, params.id),
         eq(cutLists.userId, user.id)
       ),
       with: { cuts: { orderBy: cutListCuts.position } }
     })
     ```
   - Return 404 if not found
   - Return { cutList }

**+page.svelte:**
1. Import ShopChecklist component
2. Display cut list name as page title
3. Back link to /cutlist
4. Render ShopChecklist with cutList.cuts, cutList.id, cutList.mode
5. Show cut list metadata (mode, kerf, created date)
  </action>
  <verify>
1. Save a cut list via existing /cutlist flow
2. Navigate to /cutlist/{id}
3. See checklist view with progress bar
4. Click checkbox to mark cut complete
5. Refresh page - completion persists
  </verify>
  <done>Shop checklist displays saved cuts, allows completion marking, shows progress, and persists state</done>
</task>

</tasks>

<verification>
1. Create and save a cut list with multiple cuts
2. Navigate to /cutlist/{savedCutListId}
3. Verify checklist displays all cuts with dimensions
4. Mark several cuts complete via checkboxes
5. Verify progress bar updates (e.g., "3 of 5 complete (60%)")
6. Refresh page - verify completion state persists
7. Unmark a cut - verify it reverts to incomplete
8. Test both linear and sheet mode displays
</verification>

<success_criteria>
- CUT-27: User can view cut list as shop checklist (view page with ShopChecklist component)
- CUT-28: User can mark individual cuts complete (checkbox toggle with API persistence)
- CUT-29: Checklist shows completion progress (progress bar + text)
- CUT-30: Completion state persists (database storage via PATCH endpoint)
- All requirements verified with manual testing
</success_criteria>

<output>
After completion, create `.planning/phases/21-bom-integration-shop-checklist/21-02-SUMMARY.md`
</output>
