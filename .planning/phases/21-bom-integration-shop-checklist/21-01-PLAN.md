---
phase: 21-bom-integration-shop-checklist
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/cutlist/from-bom/+page.svelte
  - src/routes/cutlist/from-bom/+page.server.ts
  - src/lib/components/cutlist/BomSelector.svelte
autonomous: true

must_haves:
  truths:
    - "User can select a project from their projects list"
    - "User can multi-select BOMs within the selected project"
    - "Selected BOMs filter to lumber items with valid dimensions only"
    - "Lumber items pre-populate cut list with correct dimensions"
  artifacts:
    - path: "src/routes/cutlist/from-bom/+page.svelte"
      provides: "BOM selection flow UI"
      min_lines: 100
    - path: "src/routes/cutlist/from-bom/+page.server.ts"
      provides: "Load projects with nested BOMs and items"
      exports: ["load", "actions"]
    - path: "src/lib/components/cutlist/BomSelector.svelte"
      provides: "Multi-select BOM component with checkbox list"
      min_lines: 80
  key_links:
    - from: "src/routes/cutlist/from-bom/+page.server.ts"
      to: "db.query.projects"
      via: "Drizzle relational query with nested BOMs"
      pattern: "db\\.query\\.projects\\.findMany.*with:"
    - from: "src/routes/cutlist/from-bom/+page.svelte"
      to: "/cutlist"
      via: "redirect with pre-populated cuts"
      pattern: "goto.*cutlist"
---

<objective>
Create BOM integration flow for the cut list optimizer allowing users to select a project, multi-select BOMs, and pre-populate cuts from lumber items.

Purpose: Streamline cut list creation by pulling dimension data directly from existing BOM lumber items, eliminating manual re-entry of dimensions.

Output: New `/cutlist/from-bom` route with project selection, BOM multi-select, and redirect to main cutlist page with pre-populated cuts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-bom-integration-shop-checklist/21-RESEARCH.md

# Existing patterns to follow
@src/lib/components/cutlist/SaveCutListModal.svelte
@src/routes/cutlist/+page.server.ts
@src/lib/server/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BOM Selection Server Route</name>
  <files>src/routes/cutlist/from-bom/+page.server.ts</files>
  <action>
Create the server route that loads the user's projects with nested BOMs and their lumber items.

**Implementation:**
1. Import requireAuth, db, projects, boms, bomItems from appropriate modules
2. In load function:
   - Call requireAuth(event) to ensure user is authenticated
   - Use Drizzle relational query to fetch projects with nested BOMs:
     ```typescript
     db.query.projects.findMany({
       where: eq(projects.userId, user.id),
       with: {
         boms: {
           with: {
             items: true  // Load all items, filter client-side for count display
           }
         }
       },
       orderBy: desc(projects.updatedAt)
     })
     ```
   - Return { projects: userProjects }

3. Create form action `loadFromBoms`:
   - Parse formData to get projectId and selectedBomIds (use getAll for multi-select)
   - Query bomItems for all selected BOMs where category = 'lumber' AND length IS NOT NULL
   - For sheet mode detection: check if any item has width dimension
   - Transform lumber items to Cut format:
     - id: crypto.randomUUID()
     - length: item.length
     - width: item.width (null for linear)
     - quantity: item.quantity
     - label: item.name
     - grainMatters: false (default)
   - Return { cuts, mode: detectedMode }

**Important:** Use formData.getAll('selectedBoms') NOT formData.get() for multi-select checkboxes.
  </action>
  <verify>TypeScript compiles without errors: `npm run check`</verify>
  <done>Server route loads user projects with BOMs and form action returns filtered lumber items as cuts</done>
</task>

<task type="auto">
  <name>Task 2: Create BomSelector Component</name>
  <files>src/lib/components/cutlist/BomSelector.svelte</files>
  <action>
Create a reusable component for multi-selecting BOMs from a project.

**Props interface:**
```typescript
interface BOM {
  id: string;
  name: string;
  items: Array<{ id: string; category: string; length: number | null; width: number | null }>;
}

interface Props {
  boms: BOM[];
  selectedBomIds: Set<string>;
  onToggle: (bomId: string) => void;
  disabled?: boolean;
}
```

**Implementation:**
1. Accept props using $props()
2. Create derived lumberCount for each BOM:
   - Filter items where category === 'lumber' AND length is not null
   - Display count next to BOM name
3. Render checkbox list (follow SaveCutListModal project-card pattern):
   - Each BOM as a card with checkbox
   - Show BOM name and lumber item count
   - Checkbox checked state from selectedBomIds.has(bom.id)
   - onclick calls onToggle(bom.id)
4. Style using existing card patterns (see SaveCutListModal .project-card styles)

**Key details:**
- Use native checkbox input with name="selectedBoms" value={bom.id}
- Show "(X lumber items)" count to help user understand what will be imported
- Items with null length should NOT count toward lumber count (incomplete dimensions)
  </action>
  <verify>Component renders without console errors when imported into a test page</verify>
  <done>BomSelector displays BOMs with checkboxes, shows lumber count, and toggles selection correctly</done>
</task>

<task type="auto">
  <name>Task 3: Create From-BOM Selection Page</name>
  <files>src/routes/cutlist/from-bom/+page.svelte</files>
  <action>
Create the page that orchestrates the BOM selection flow with two-step UI.

**Implementation:**
1. Import dependencies:
   - BomSelector from $lib/components/cutlist/BomSelector.svelte
   - enhance from $app/forms
   - goto from $app/navigation
   - type PageData from './$types'

2. State management:
   - selectedProjectId: string | null (step 1)
   - selectedBomIds: Set<string> (step 2)
   - loading: boolean (during form submission)

3. Step 1 - Project Selection (when selectedProjectId is null):
   - Display project cards similar to SaveCutListModal
   - onclick sets selectedProjectId and resets selectedBomIds

4. Step 2 - BOM Selection (when project selected):
   - Show "Back to projects" link to reset selectedProjectId
   - Use BomSelector component with current project's BOMs
   - Display selected count: "X BOMs selected"
   - "Load Cuts" button enabled when selectedBomIds.size > 0

5. Form handling with use:enhance:
   - On successful response, redirect to /cutlist with cuts in URL state
   - Use goto('/cutlist', { state: { cuts: result.cuts, mode: result.mode } })

6. Page styling:
   - Use page-header pattern from /cutlist
   - Back link to /cutlist
   - Card-based selection similar to SaveCutListModal

**Edge cases:**
- Empty projects: Show "No projects yet" with link to /projects
- Empty BOMs in project: Show "No BOMs in this project" message
- No lumber items: Show warning that selected BOMs have no lumber items
  </action>
  <verify>Navigate to /cutlist/from-bom, select project, select BOMs, verify lumber count displays</verify>
  <done>Full selection flow works: project selection, BOM multi-select, redirect to cutlist with pre-populated cuts</done>
</task>

</tasks>

<verification>
1. Navigate to /cutlist/from-bom as authenticated user
2. See list of user's projects
3. Click a project to see its BOMs
4. Check multiple BOMs with lumber items
5. Click "Load Cuts" and verify redirect to /cutlist
6. Verify cuts are pre-populated with correct dimensions from BOM lumber items
7. Verify linear vs sheet mode is auto-detected based on width presence
</verification>

<success_criteria>
- CUT-23: User can select a project (project selection step)
- CUT-24: User can multi-select BOMs (checkbox multi-select)
- CUT-25: BOMs auto-filter to lumber items (category + dimension check)
- CUT-26: Lumber items pre-populate as cuts (redirect with state)
- All requirements verified with manual testing
</success_criteria>

<output>
After completion, create `.planning/phases/21-bom-integration-shop-checklist/21-01-SUMMARY.md`
</output>
