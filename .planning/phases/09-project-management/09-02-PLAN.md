---
phase: 09-project-management
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/routes/projects/+page.server.ts
  - src/routes/projects/+page.svelte
  - src/routes/projects/[id]/+page.server.ts
  - src/routes/projects/[id]/+page.svelte
autonomous: false

must_haves:
  truths:
    - "User can see list of their projects at /projects"
    - "User can create a new project with name and description"
    - "User can view a single project's details"
    - "User can edit project name, description, and notes"
    - "User can delete a project with confirmation"
    - "Unauthenticated users are redirected to login"
  artifacts:
    - path: "src/routes/projects/+page.server.ts"
      provides: "List load + create action"
      exports: ["load", "actions"]
    - path: "src/routes/projects/+page.svelte"
      provides: "Project list UI with create form"
      min_lines: 80
    - path: "src/routes/projects/[id]/+page.server.ts"
      provides: "Detail load + update/delete actions"
      exports: ["load", "actions"]
    - path: "src/routes/projects/[id]/+page.svelte"
      provides: "Project detail UI with edit/delete forms"
      min_lines: 100
  key_links:
    - from: "src/routes/projects/+page.server.ts"
      to: "db.query.projects"
      via: "load function with userId filter"
      pattern: "eq\\(projects\\.userId.*locals\\.user\\.id\\)"
    - from: "src/routes/projects/[id]/+page.server.ts"
      to: "db.query.projects"
      via: "load with userId + id filter"
      pattern: "and\\(.*eq\\(projects\\.id"
---

<objective>
Create project management routes with full CRUD functionality.

Purpose: Implement /projects (list + create) and /projects/[id] (view + edit + delete) routes following established auth route patterns.
Output: Working project CRUD with form actions and progressive enhancement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-project-management/09-RESEARCH.md
@.planning/phases/09-project-management/09-01-SUMMARY.md
@src/lib/server/schema.ts
@src/routes/auth/login/+page.server.ts
@src/routes/auth/login/+page.svelte
@src/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /projects list page with create action</name>
  <files>src/routes/projects/+page.server.ts, src/routes/projects/+page.svelte</files>
  <action>
Create the projects list route with server load and create action.

**+page.server.ts:**

```typescript
import { fail, redirect } from '@sveltejs/kit';
import type { PageServerLoad, Actions } from './$types';
import { db } from '$lib/server/db';
import { projects } from '$lib/server/schema';
import { eq, desc } from 'drizzle-orm';

export const load: PageServerLoad = async ({ locals }) => {
    // Require authentication
    if (!locals.user) {
        throw redirect(302, '/auth/login?redirect=/projects');
    }

    const userProjects = await db.query.projects.findMany({
        where: eq(projects.userId, locals.user.id),
        orderBy: [desc(projects.updatedAt)]
    });

    return { projects: userProjects };
};

export const actions: Actions = {
    create: async ({ request, locals }) => {
        // Auth check in action (important!)
        if (!locals.user) {
            throw redirect(302, '/auth/login');
        }

        const data = await request.formData();
        const name = data.get('name')?.toString().trim();
        const description = data.get('description')?.toString().trim() || null;

        // Validation
        if (!name || name.length < 1) {
            return fail(400, {
                error: 'Project name is required',
                name: '',
                description: description || ''
            });
        }

        if (name.length > 100) {
            return fail(400, {
                error: 'Project name must be 100 characters or less',
                name,
                description: description || ''
            });
        }

        const id = crypto.randomUUID();
        const now = new Date();

        await db.insert(projects).values({
            id,
            userId: locals.user.id,
            name,
            description,
            notes: null,
            createdAt: now,
            updatedAt: now
        });

        // PRG pattern - redirect after create
        throw redirect(302, `/projects/${id}`);
    }
};
```

**+page.svelte:**

Create a page with:
1. Page title "My Projects"
2. Create project form at top (name input, optional description textarea)
3. Grid of projects using simple cards (not ProjectCard - that's for dashboard with progress)
4. Empty state when no projects

Use existing CSS classes: artisan-card, btn-primary, btn-ghost, input-field, label.
Use `use:enhance` for progressive enhancement with loading state.

Style the project list as a simple grid with project name, description preview, and "Last updated" time.
Each project card links to /projects/[id].
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Visit http://localhost:5173/projects (should redirect to login if not authenticated)
3. Log in and return to /projects
4. Verify empty state displays when no projects
5. Create a project with name and description
6. Verify redirect to project detail page
  </verify>
  <done>
/projects page loads user's projects, create form works, redirects unauthenticated users to login.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /projects/[id] detail page with edit and delete</name>
  <files>src/routes/projects/[id]/+page.server.ts, src/routes/projects/[id]/+page.svelte</files>
  <action>
Create the project detail route with view, edit, and delete functionality.

**+page.server.ts:**

```typescript
import { error, fail, redirect } from '@sveltejs/kit';
import type { PageServerLoad, Actions } from './$types';
import { db } from '$lib/server/db';
import { projects } from '$lib/server/schema';
import { eq, and } from 'drizzle-orm';

export const load: PageServerLoad = async ({ locals, params }) => {
    if (!locals.user) {
        throw redirect(302, '/auth/login?redirect=/projects/' + params.id);
    }

    // IMPORTANT: Filter by BOTH id AND userId for security
    const project = await db.query.projects.findFirst({
        where: and(
            eq(projects.id, params.id),
            eq(projects.userId, locals.user.id)
        )
    });

    if (!project) {
        throw error(404, 'Project not found');
    }

    return { project };
};

export const actions: Actions = {
    update: async ({ request, locals, params }) => {
        if (!locals.user) {
            throw redirect(302, '/auth/login');
        }

        const data = await request.formData();
        const name = data.get('name')?.toString().trim();
        const description = data.get('description')?.toString().trim() || null;
        const notes = data.get('notes')?.toString().trim() || null;

        if (!name || name.length < 1) {
            return fail(400, { error: 'Project name is required' });
        }

        if (name.length > 100) {
            return fail(400, { error: 'Project name must be 100 characters or less' });
        }

        // Update with userId check for security
        await db.update(projects)
            .set({
                name,
                description,
                notes,
                updatedAt: new Date()
            })
            .where(and(
                eq(projects.id, params.id),
                eq(projects.userId, locals.user.id)
            ));

        return { success: true };
    },

    delete: async ({ locals, params }) => {
        if (!locals.user) {
            throw redirect(302, '/auth/login');
        }

        // Delete with userId check for security
        await db.delete(projects)
            .where(and(
                eq(projects.id, params.id),
                eq(projects.userId, locals.user.id)
            ));

        // PRG pattern - redirect to list after delete
        throw redirect(302, '/projects');
    }
};
```

**+page.svelte:**

Create a detail page with:
1. Back link to /projects
2. Project name as heading (editable)
3. Edit form with: name (required), description (optional), notes (optional textarea)
4. Save button (update action)
5. Delete button with client-side confirm() dialog (delete action)
6. Success feedback after save (use form.success)

Layout:
- Header section with back link and project name
- Edit form in artisan-card
- Delete section at bottom (subtle, secondary styling)

Use Svelte 5 patterns: `let { data, form } = $props()`, `$state()` for loading.
Use `use:enhance` for progressive enhancement.
Notes field should be a larger textarea (4-6 rows).
  </action>
  <verify>
1. Navigate to a project detail page
2. Verify project data loads correctly
3. Edit name and save - verify success message
4. Edit description and notes - verify changes persist
5. Test delete with confirmation dialog
6. Verify redirect to /projects after delete
7. Test accessing another user's project ID returns 404
  </verify>
  <done>
Project detail page shows project data, edit form saves changes, delete removes project and redirects.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete project CRUD functionality at /projects and /projects/[id]</what-built>
  <how-to-verify>
1. Open http://localhost:5173/ in browser
2. If not logged in, click "Sign Up" and create an account
3. Navigate to /projects (or click "Projects" if nav link exists)
4. Verify empty state shows when no projects
5. Create a new project with name "Test Project" and description "My first project"
6. Verify redirect to /projects/[id] detail page
7. Edit the description to "Updated description" and click Save
8. Verify success message appears
9. Add some notes in the notes field, click Save
10. Navigate back to /projects list
11. Verify your project appears in the list
12. Go back to project detail
13. Click Delete, confirm the dialog
14. Verify redirect to /projects and project is gone
15. Test security: Copy a project URL, log out, try accessing it - should redirect to login
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. /projects route exists and requires authentication
2. /projects loads user's projects (not other users')
3. Create project form validates name, creates project, redirects to detail
4. /projects/[id] route loads project with ownership check
5. Edit form updates project and shows success feedback
6. Delete action removes project and redirects to list
7. All actions verify userId ownership (security)
</verification>

<success_criteria>
- PROJ-01: User can create a named project with description (create action)
- PROJ-02: User can view list of their projects (/projects load)
- PROJ-03: User can edit project metadata (update action)
- PROJ-04: User can delete a project (delete action with confirm)
- Security: All queries filter by userId, all actions check auth
</success_criteria>

<output>
After completion, create `.planning/phases/09-project-management/09-02-SUMMARY.md`
</output>
