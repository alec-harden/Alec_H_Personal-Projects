---
phase: 20-sheet-optimizer-2d
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/types/cutlist.ts
  - src/lib/server/cutOptimizer.ts
  - src/lib/components/cutlist/CutInputForm.svelte
autonomous: true

must_haves:
  truths:
    - "User can toggle grain direction per cut in sheet mode"
    - "2D optimizer places multiple cuts on a single sheet"
    - "Cuts are placed using guillotine algorithm (edge-to-edge cuts)"
    - "Grain-constrained cuts are not rotated during placement"
    - "Waste percentage reflects realistic 2D packing efficiency"
  artifacts:
    - path: "src/lib/types/cutlist.ts"
      provides: "grainMatters field on Cut interface"
      contains: "grainMatters"
    - path: "src/lib/server/cutOptimizer.ts"
      provides: "Guillotine BSSF+SAS 2D packing algorithm"
      contains: "guillotinePack"
    - path: "src/lib/components/cutlist/CutInputForm.svelte"
      provides: "Grain direction toggle checkbox for sheet mode"
      contains: "grainMatters"
  key_links:
    - from: "src/lib/components/cutlist/CutInputForm.svelte"
      to: "src/lib/types/cutlist.ts"
      via: "grainMatters property binding"
      pattern: "bind:checked.*grainMatters"
    - from: "src/lib/server/cutOptimizer.ts"
      to: "guillotinePack function"
      via: "optimizeCuts2D calls guillotinePack"
      pattern: "guillotinePack.*freeRectangles"
---

<objective>
Implement 2D guillotine bin packing algorithm with grain direction support

Purpose: Replace the placeholder one-cut-per-sheet 2D optimizer with a proper guillotine BSSF+SAS algorithm that packs multiple cuts onto sheets efficiently while respecting grain direction constraints.

Output: Working 2D optimizer that places cuts with x/y coordinates, tracks rotation state, and calculates realistic waste percentages. Grain direction toggle in UI prevents rotation for grain-sensitive plywood cuts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-sheet-optimizer-2d/20-RESEARCH.md
@.planning/phases/18-cut-optimizer-foundation/18-03-SUMMARY.md
@.planning/phases/19-linear-optimizer/19-01-SUMMARY.md

Reference existing files:
@src/lib/types/cutlist.ts
@src/lib/server/cutOptimizer.ts
@src/lib/components/cutlist/CutInputForm.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add grainMatters field and enhance CutAssignment for 2D</name>
  <files>src/lib/types/cutlist.ts, src/lib/server/cutOptimizer.ts</files>
  <action>
1. In `src/lib/types/cutlist.ts`:
   - Add `grainMatters: boolean` field to the `Cut` interface (after `label`)
   - Update `createCut()` helper to initialize `grainMatters: false` (default: rotation allowed)

2. In `src/lib/server/cutOptimizer.ts`:
   - Enhance `CutAssignment` interface to add 2D placement fields:
     - `x: number | null` (position on sheet, null for 1D)
     - `y: number | null` (position on sheet, null for 1D)
     - `rotated: boolean` (true if 90-degree rotated from original)
   - These fields are null for 1D mode, populated for 2D mode

This sets up the type foundation for the guillotine algorithm and UI grain toggle.
  </action>
  <verify>
Run `npm run check` - TypeScript compilation passes with no errors related to Cut or CutAssignment types.
  </verify>
  <done>
Cut interface has grainMatters boolean field. CutAssignment has x, y, and rotated fields for 2D placement tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement guillotine BSSF+SAS algorithm in optimizeCuts2D</name>
  <files>src/lib/server/cutOptimizer.ts</files>
  <action>
Replace the placeholder `optimizeCuts2D` function with a proper guillotine bin packing algorithm:

1. Create helper interfaces (inside the file, not exported):
   ```typescript
   interface FreeRectangle {
     x: number;
     y: number;
     width: number;
     height: number;
   }

   interface ExpandedCut2D {
     id: string;
     label: string;
     length: number;
     width: number;
     originalId: string;
     grainMatters: boolean;
   }
   ```

2. Create helper functions:
   - `scoreBSSF(freeWidth, freeHeight, itemWidth, itemHeight): number` - Best Short Side Fit scoring: `Math.min(freeWidth - itemWidth, freeHeight - itemHeight)`
   - `splitSAS(freeRect, placedWidth, placedHeight, kerf): FreeRectangle[]` - Shorter Axis Split: creates new free rectangles after placement, applying kerf to split edges

3. Create main packing function:
   - `guillotinePack(cuts: ExpandedCut2D[], stockWidth: number, stockHeight: number, kerf: number, existingFreeRects?: FreeRectangle[]): { placed: Array<{cut, x, y, rotated}>, freeRectangles: FreeRectangle[] }`

   Algorithm:
   - For each cut (sorted by area descending):
     - Try each free rectangle
     - Score both orientations (upright and rotated) using BSSF if rotation allowed (!grainMatters)
     - Select best fit (lowest score)
     - Place cut at free rectangle's x,y
     - Remove used free rectangle, add new free rectangles from splitSAS
   - Return placed cuts and remaining free rectangles

4. Update `optimizeCuts2D` to use `guillotinePack`:
   - Expand cuts and stock as before (keeping existing validation)
   - Sort cuts by area descending (largest first)
   - Sort stock by area descending (use largest sheets first)
   - For each cut:
     - Try to place in existing plans (pass plan's freeRectangles to guillotinePack)
     - If no room, start new sheet with fresh free rectangle covering entire sheet
   - Store freeRectangles on each plan (add to StockPlan interface if needed, or track internally)
   - Calculate waste using 2D kerf formula: `stockArea - totalCutArea - kerfLossArea`
   - Populate x, y, rotated on each CutAssignment

5. Kerf handling in 2D:
   - Apply kerf to split operation (usedWidth = placedWidth + kerf, usedHeight = placedHeight + kerf)
   - Conservative waste estimate: `kerfLossArea = sum((cut.length * kerf) + (cut.width * kerf))`

Reference the research patterns in 20-RESEARCH.md for the exact algorithm structure.
  </action>
  <verify>
1. Run `npm run check` - TypeScript compilation passes
2. Manual test: Navigate to /cutlist, switch to Sheet mode, add cuts:
   - Cut 1: 24" x 12", qty 4
   - Cut 2: 12" x 12", qty 6
   - Stock: 48" x 24", qty 2
   - Run optimization
   - Verify: Multiple cuts placed per sheet, waste < 30% (placeholder was 80%+)
  </verify>
  <done>
2D optimizer uses guillotine BSSF+SAS algorithm. Multiple cuts pack onto single sheets. Waste percentage is realistic (10-25% for typical cuts).
  </done>
</task>

<task type="auto">
  <name>Task 3: Add grain direction toggle to CutInputForm</name>
  <files>src/lib/components/cutlist/CutInputForm.svelte</files>
  <action>
Add a grain direction checkbox for each cut in sheet mode:

1. Update the entries-header to include a new column for sheet mode:
   - Add header cell "Grain" between Label and Actions (only visible in sheet mode)
   - Adjust grid-template-columns to accommodate new column in sheet mode

2. Update entry-row for sheet mode:
   - Add new entry-field for grain toggle (only visible in sheet mode)
   - Use a checkbox input bound to `cut.grainMatters`
   - Style as a small toggle or checkbox with label

3. Implementation details:
   ```svelte
   {#if mode === 'sheet'}
     <div class="entry-field entry-grain">
       <label class="grain-toggle">
         <input type="checkbox" bind:checked={cut.grainMatters} />
         <span class="grain-label">Lock</span>
       </label>
     </div>
   {/if}
   ```

4. Mobile responsive handling:
   - Add `::before` content for mobile stacking: "Grain Lock"
   - Ensure checkbox is accessible on mobile

5. Styling:
   - Keep consistent with existing form styling
   - Checkbox aligned center in column
   - Consider using a grain icon (lines) if checkbox feels unclear

The toggle defaults to unchecked (grainMatters: false), meaning rotation is allowed. When checked (grainMatters: true), the cut will not be rotated during optimization.
  </action>
  <verify>
1. Navigate to /cutlist in browser
2. Select "Sheet" mode
3. Add a cut - grain toggle checkbox should appear
4. Toggle checkbox on/off - verify it binds correctly (check cut object in dev tools or via form state)
5. Switch to "Linear" mode - grain toggle should disappear
6. Mobile: Resize browser, verify grain field shows with proper label
  </verify>
  <done>
Sheet mode shows grain direction toggle for each cut. Checkbox correctly binds to cut.grainMatters. Toggle hidden in linear mode.
  </done>
</task>

</tasks>

<verification>
1. Type checking: `npm run check` passes with no errors
2. Algorithm test: Sheet mode optimization with 10 cuts produces <30% waste (was 80%+ with placeholder)
3. Grain constraint: Cuts with grainMatters=true are not rotated in output
4. UI: Grain toggle visible in sheet mode, hidden in linear mode
5. Kerf: Waste calculation accounts for blade width in both dimensions
</verification>

<success_criteria>
- Guillotine BSSF+SAS algorithm replaces placeholder 2D optimizer
- Multiple cuts pack onto single sheets (not one-cut-per-sheet)
- Grain direction toggle prevents rotation when enabled
- CutAssignment includes x, y, rotated fields for visualization (Phase 20-02)
- Waste percentages are realistic (10-25% for typical cuts)
</success_criteria>

<output>
After completion, create `.planning/phases/20-sheet-optimizer-2d/20-01-SUMMARY.md` using the summary template.
</output>
