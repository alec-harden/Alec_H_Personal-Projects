---
phase: 20-sheet-optimizer-2d
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/lib/components/cutlist/SheetCutDiagram.svelte
  - src/lib/components/cutlist/OptimizationResults.svelte
autonomous: true

must_haves:
  truths:
    - "User can see visual 2D diagram of cuts placed on sheets"
    - "Diagram shows cuts as colored rectangles with labels"
    - "Rotated cuts are visually indicated"
    - "Waste areas are visible with color-coded severity"
    - "Diagram maintains aspect ratio of actual sheet dimensions"
  artifacts:
    - path: "src/lib/components/cutlist/SheetCutDiagram.svelte"
      provides: "SVG-based 2D cut visualization component"
      min_lines: 100
    - path: "src/lib/components/cutlist/OptimizationResults.svelte"
      provides: "Sheet mode diagram integration"
      contains: "SheetCutDiagram"
  key_links:
    - from: "src/lib/components/cutlist/OptimizationResults.svelte"
      to: "src/lib/components/cutlist/SheetCutDiagram.svelte"
      via: "import and render in sheet mode"
      pattern: "import SheetCutDiagram"
    - from: "src/lib/components/cutlist/SheetCutDiagram.svelte"
      to: "src/lib/server/cutOptimizer.ts"
      via: "StockPlan type with x/y coordinates"
      pattern: "type.*StockPlan"
---

<objective>
Create 2D sheet cut diagram visualization

Purpose: Provide a visual representation of how cuts are placed on each sheet, similar to the LinearCutDiagram for 1D mode. Shows cut positions, rotation state, and waste regions using SVG.

Output: SheetCutDiagram.svelte component integrated into OptimizationResults for sheet mode, displaying nested rectangles on each sheet with labels, rotation indicators, and waste visualization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-sheet-optimizer-2d/20-RESEARCH.md
@.planning/phases/19-linear-optimizer/19-02-SUMMARY.md

Reference existing files:
@src/lib/components/cutlist/LinearCutDiagram.svelte
@src/lib/components/cutlist/OptimizationResults.svelte
@src/lib/server/cutOptimizer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SheetCutDiagram.svelte component</name>
  <files>src/lib/components/cutlist/SheetCutDiagram.svelte</files>
  <action>
Create a new SVG-based component for visualizing 2D sheet cuts:

1. Component props (use Svelte 5 `$props()` syntax):
   ```typescript
   interface Props {
     plan: StockPlan;
     kerf: number;
     index: number;
   }
   ```

2. SVG setup:
   - Fixed viewBox dimensions: 600 x 400 (horizontal orientation for sheets)
   - Padding: 20px on all sides
   - Calculate scale factor: `scale = Math.min((svgWidth - 2*padding) / stockLength, (svgHeight - 2*padding) / stockWidth)`
   - Maintain aspect ratio (use same scale for both axes)

3. Derive scaled dimensions using `$derived`:
   ```typescript
   const scale = $derived(Math.min(
     (svgWidth - 2 * padding) / (plan.stockLength || 1),
     (svgHeight - 2 * padding) / (plan.stockWidth || 1)
   ));
   const scaledStockWidth = $derived((plan.stockLength || 0) * scale);
   const scaledStockHeight = $derived((plan.stockWidth || 0) * scale);
   ```

4. Transform cuts to SVG coordinates using `$derived.by()`:
   ```typescript
   interface CutRect {
     x: number;
     y: number;
     width: number;
     height: number;
     label: string;
     id: string;
     showLabel: boolean;
     rotated: boolean;
   }
   ```
   - For each cut in plan.cuts:
     - x = padding + (cut.x || 0) * scale
     - y = padding + (cut.y || 0) * scale
     - width = (cut.length || 0) * scale
     - height = (cut.width || 0) * scale
     - showLabel = width > 40 && height > 20

5. SVG structure:
   - Stock outline: rect with light gray fill (#f9fafb), gray border (#d1d5db)
   - Placed cuts: green rects (#10b981 fill, #059669 stroke)
   - Cut labels: white text centered in rect (only if showLabel)
   - Rotation indicator: small circle with rotation symbol for rotated cuts (if width > 30)

6. Waste visualization:
   - Calculate waste percentage from plan.wasteArea
   - Color code: green <10%, amber <25%, red >=25%
   - Display in footer

7. Component structure:
   ```svelte
   <div class="diagram-container">
     <div class="diagram-header">
       <span class="stock-label">Sheet #{index + 1}: {plan.stockLabel}</span>
       <span class="stock-dimensions">{plan.stockLength}" x {plan.stockWidth}"</span>
     </div>
     <svg viewBox="0 0 {svgWidth} {svgHeight}" class="diagram-svg">
       <!-- Stock outline -->
       <!-- Cuts -->
       <!-- Rotation indicators -->
     </svg>
     <div class="diagram-footer">
       <span class="cuts-count">{plan.cuts.length} cuts</span>
       <span class="waste-amount">{wasteArea} sq in waste ({wastePercent}%)</span>
     </div>
   </div>
   ```

8. Styling: Match LinearCutDiagram styling patterns (copy existing CSS classes with minor adjustments for 2D).
  </action>
  <verify>
Create the component file and run `npm run check` to verify TypeScript types are correct. Component should compile without errors.
  </verify>
  <done>
SheetCutDiagram.svelte component created with SVG visualization showing cuts as positioned rectangles, rotation indicators, and waste statistics.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate SheetCutDiagram into OptimizationResults</name>
  <files>src/lib/components/cutlist/OptimizationResults.svelte</files>
  <action>
Add sheet mode diagram rendering parallel to the existing linear mode diagrams:

1. Add import at top of script:
   ```typescript
   import SheetCutDiagram from './SheetCutDiagram.svelte';
   ```

2. Find the existing linear mode diagram section:
   ```svelte
   {#if mode === 'linear' && result.plans.length > 0}
     <!-- Cut Diagrams Section (Linear Mode Only) -->
   {/if}
   ```

3. Add sheet mode diagram section after the linear mode section:
   ```svelte
   {:else if mode === 'sheet' && result.plans.length > 0}
     <div class="diagrams-section">
       <h3 class="diagrams-title">Cut Diagrams</h3>
       <div class="diagrams-list">
         {#each result.plans as plan, index (plan.stockId)}
           <SheetCutDiagram {plan} {kerf} {index} />
         {/each}
       </div>
     </div>
   {/if}
   ```

4. Verify the existing styles for `.diagrams-section`, `.diagrams-title`, `.diagrams-list` apply to both modes (they should already work since they're mode-agnostic).

5. Ensure sheet mode summary shows "sq in" for waste units (already implemented) and number of sheets used.
  </action>
  <verify>
1. Navigate to /cutlist in browser
2. Switch to "Sheet" mode
3. Add cuts and stock:
   - Cut 1: 24" x 12", qty 4
   - Cut 2: 18" x 12", qty 3
   - Stock: 48" x 24", qty 2
4. Click "Optimize"
5. Verify: Cut Diagrams section appears with SheetCutDiagram components
6. Verify: Each sheet shows positioned cuts as colored rectangles
7. Verify: Rotated cuts (if any) show rotation indicator
8. Verify: Waste percentage displayed in footer
  </verify>
  <done>
OptimizationResults renders SheetCutDiagram components for sheet mode. 2D cut placement visualized with proper scaling and labeling.
  </done>
</task>

</tasks>

<verification>
1. Type checking: `npm run check` passes
2. Linear mode: Diagrams still work correctly (no regression)
3. Sheet mode: Cut Diagrams section displays for sheet optimization results
4. Visual test: Cuts render at correct positions matching algorithm output
5. Rotation: Rotated cuts show visual indicator (rotation symbol)
6. Waste: Color coding matches percentage thresholds
7. Responsiveness: Diagrams scale properly on mobile
</verification>

<success_criteria>
- SheetCutDiagram.svelte component renders 2D cut placements as nested rectangles
- Diagram maintains aspect ratio of actual sheet dimensions
- Rotated cuts display rotation indicator
- Waste percentage shown with color coding (green/amber/red)
- Integration into OptimizationResults for sheet mode only
- No regression to linear mode diagrams
</success_criteria>

<output>
After completion, create `.planning/phases/20-sheet-optimizer-2d/20-02-SUMMARY.md` using the summary template.
</output>
