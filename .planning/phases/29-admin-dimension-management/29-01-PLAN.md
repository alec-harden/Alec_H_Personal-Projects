# 29-01: Database Schema & Validation Logic

---
wave: 1
depends_on: []
files_modified:
  - src/lib/server/schema.ts
  - src/lib/server/seed-dimensions.ts
  - src/hooks.server.ts
  - src/lib/utils/dimension-validation.ts
  - src/lib/server/bom-validation.ts
  - src/routes/api/bom/save/+server.ts
  - src/routes/api/bom/[id]/items/[itemId]/+server.ts
autonomous: true
---

## Objective

Create database table for dimension values, add seeding on startup, and update validation logic to read from database with caching.

## Requirements

- ADM-01: Create `dimensionValues` database table
- ADM-02: Seed default dimension values on first run
- ADM-08: Validation logic reads from database instead of hardcoded constants

## must_haves

- [ ] dimensionValues table exists in schema.ts with id, category, dimensionType, value, isDefault, timestamps
- [ ] seedDefaultDimensions function creates 41 default values
- [ ] hooks.server.ts seeds on first request if table empty
- [ ] dimension-validation.ts reads from database with 1-minute TTL cache
- [ ] validation functions are async and await database queries
- [ ] API routes await validation calls
- [ ] `npm run db:push` creates the table successfully

## Tasks

<task id="1">
**Add dimensionValues table to schema.ts**

Add after the existing tables:
```typescript
export const dimensionValues = sqliteTable('dimension_values', {
  id: text('id').primaryKey(),
  category: text('category', { enum: ['hardwood', 'common', 'sheet'] }).notNull(),
  dimensionType: text('dimension_type', { enum: ['thickness', 'width', 'length'] }).notNull(),
  value: real('value').notNull(),
  isDefault: integer('is_default', { mode: 'boolean' }).notNull().default(false),
  createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
  updatedAt: integer('updated_at', { mode: 'timestamp' }).notNull()
});

export const dimensionValuesRelations = relations(dimensionValues, () => ({}));
```

File: [src/lib/server/schema.ts](src/lib/server/schema.ts)
</task>

<task id="2">
**Create seed-dimensions.ts**

Create new file with seedDefaultDimensions function. Extract all 41 values from existing constants in dimension-validation.ts:
- 12 hardwood thickness values
- 2 common thickness values
- 7 common width values
- 14 sheet thickness values
- 3 sheet width values
- 3 sheet length values

Set isDefault=true for all seeded values.

File: [src/lib/server/seed-dimensions.ts](src/lib/server/seed-dimensions.ts) (NEW)
</task>

<task id="3">
**Update hooks.server.ts for startup seeding**

Add at top of file:
```typescript
import { seedDefaultDimensions } from '$lib/server/seed-dimensions';
import { dimensionValues } from '$lib/server/schema';
import { sql } from 'drizzle-orm';

let dimensionsSeeded = false;
```

Add inside handle() before session logic:
```typescript
if (!dimensionsSeeded) {
  try {
    const result = await db
      .select({ count: sql<number>`count(*)` })
      .from(dimensionValues);

    if (result[0].count === 0) {
      console.log('Seeding default dimension values...');
      await seedDefaultDimensions(db);
      console.log('Dimension values seeded successfully');
    }
    dimensionsSeeded = true;
  } catch (error) {
    console.error('Failed to seed dimension values:', error);
  }
}
```

File: [src/hooks.server.ts](src/hooks.server.ts)
</task>

<task id="4">
**Update dimension-validation.ts to use database**

Replace hardcoded constants with database queries:

1. Add imports for db and schema
2. Add cache variables:
```typescript
let dimensionCache: Map<string, number[]> | null = null;
let cacheTimestamp = 0;
const CACHE_TTL = 60000; // 1 minute
```

3. Convert getThicknessValues() to async, query database
4. Add getWidthValues() async function
5. Add getLengthValues() async function
6. Convert validateThickness() to async
7. Add validateWidth() async function
8. Add validateLength() async function
9. Export invalidateDimensionCache() function

Keep DIMENSION_TOLERANCE and isStandardValue() unchanged.

File: [src/lib/utils/dimension-validation.ts](src/lib/utils/dimension-validation.ts)
</task>

<task id="5">
**Update bom-validation.ts to async**

Convert validateBOMItemDimensions() to async:
- Make function async
- Await all validateThickness/validateWidth/validateLength calls
- Return type remains same (warnings array)

File: [src/lib/server/bom-validation.ts](src/lib/server/bom-validation.ts)
</task>

<task id="6">
**Update API routes to await validation**

In both files, update the validation calls:
- Add await before validateBOMItemDimensions() calls
- Ensure the containing function is async (should already be)

Files:
- [src/routes/api/bom/save/+server.ts](src/routes/api/bom/save/+server.ts)
- [src/routes/api/bom/[id]/items/[itemId]/+server.ts](src/routes/api/bom/[id]/items/[itemId]/+server.ts)
</task>

<task id="7">
**Run db:push to create table**

```bash
npm run db:push
```

Verify output shows dimension_values table created.
</task>

## Verification

1. TypeScript compiles without errors
2. `npm run db:push` creates dimension_values table
3. Start dev server - console shows "Seeding default dimension values..."
4. Query database to verify 41 rows in dimension_values table
5. Create BOM with standard dimension - no warning
6. Create BOM with non-standard dimension - warning appears
