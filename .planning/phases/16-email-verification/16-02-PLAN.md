---
phase: 16-email-verification
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/routes/auth/verify-email/+page.svelte
  - src/routes/auth/verify-email/+page.server.ts
  - src/routes/auth/resend-verification/+page.svelte
  - src/routes/auth/resend-verification/+page.server.ts
  - src/routes/auth/signup/+page.server.ts
  - src/routes/admin/users/[id]/+page.svelte
  - src/routes/admin/users/[id]/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "Signup sends verification email within 60 seconds"
    - "Clicking verification link marks email as verified"
    - "User can request new verification email"
    - "Admin user detail shows verification badge"
    - "Rate limiting prevents resend abuse"
  artifacts:
    - path: "src/routes/auth/verify-email/+page.server.ts"
      provides: "Token validation and email verification"
      exports: ["load"]
    - path: "src/routes/auth/verify-email/+page.svelte"
      provides: "Verification result UI"
      min_lines: 30
    - path: "src/routes/auth/resend-verification/+page.server.ts"
      provides: "Rate-limited resend functionality"
      exports: ["load", "actions"]
    - path: "src/routes/auth/resend-verification/+page.svelte"
      provides: "Resend verification UI"
      min_lines: 40
    - path: "src/routes/auth/signup/+page.server.ts"
      provides: "Signup with verification email"
      contains: "sendVerificationEmail"
    - path: "src/routes/admin/users/[id]/+page.svelte"
      provides: "Verification badge display"
      contains: "emailVerified"
  key_links:
    - from: "src/routes/auth/signup/+page.server.ts"
      to: "src/lib/server/auth.ts"
      via: "generateEmailVerificationToken call"
      pattern: "generateEmailVerificationToken"
    - from: "src/routes/auth/verify-email/+page.server.ts"
      to: "src/lib/server/auth.ts"
      via: "verifyEmailToken and markEmailAsVerified calls"
      pattern: "verifyEmailToken|markEmailAsVerified"
    - from: "src/routes/auth/resend-verification/+page.server.ts"
      to: "src/lib/server/email.ts"
      via: "sendVerificationEmail call"
      pattern: "sendVerificationEmail"
---

<objective>
Create verification routes and integrate with signup flow.

Purpose: Implement the user-facing routes for email verification, modify signup to send verification emails, and add verification status display to admin UI.

Output: Working email verification flow where signup triggers verification email, users can verify via link or request resend, and admins see verification status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-email-verification/16-RESEARCH.md
@.planning/phases/16-email-verification/16-01-SUMMARY.md

# Existing files to modify
@src/routes/auth/signup/+page.server.ts
@src/routes/admin/users/[id]/+page.svelte
@src/routes/admin/users/[id]/+page.server.ts

# Reference patterns
@src/routes/auth/reset-password/+page.server.ts
@src/routes/auth/reset-password/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verify-email route</name>
  <files>src/routes/auth/verify-email/+page.server.ts, src/routes/auth/verify-email/+page.svelte</files>
  <action>
Create the verify-email route to handle verification link clicks.

**src/routes/auth/verify-email/+page.server.ts:**
```typescript
import type { PageServerLoad } from './$types';
import { verifyEmailToken, markEmailAsVerified } from '$lib/server/auth';

export const load: PageServerLoad = async ({ url }) => {
  const token = url.searchParams.get('token');

  if (!token) {
    return { success: false, error: 'Missing verification token' };
  }

  // Validate token
  const userId = await verifyEmailToken(token);

  if (!userId) {
    return {
      success: false,
      error: 'Invalid or expired verification link. Please request a new one.'
    };
  }

  // Mark email as verified and consume token
  await markEmailAsVerified(userId, token);

  return { success: true };
};
```

**src/routes/auth/verify-email/+page.svelte:**
```svelte
<script lang="ts">
  interface Props {
    data: { success: boolean; error?: string };
  }

  let { data }: Props = $props();
</script>

<svelte:head>
  <title>Email Verification | WoodShop Toolbox</title>
</svelte:head>

<div class="min-h-screen bg-stone-100 flex items-center justify-center py-12 px-4">
  <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
    {#if data.success}
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
          <span class="text-green-600 text-2xl">&#x2713;</span>
        </div>
        <h1 class="text-2xl font-bold text-stone-800 mb-2">Email Verified!</h1>
        <p class="text-stone-600 mb-6">
          Your email address has been successfully verified. You can now enjoy all features of WoodShop Toolbox.
        </p>
        <a
          href="/"
          class="inline-block px-6 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800 transition-colors"
        >
          Go to Dashboard
        </a>
      </div>
    {:else}
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
          <span class="text-red-600 text-2xl">&#x2717;</span>
        </div>
        <h1 class="text-2xl font-bold text-stone-800 mb-2">Verification Failed</h1>
        <p class="text-stone-600 mb-6">
          {data.error}
        </p>
        <a
          href="/auth/resend-verification"
          class="inline-block px-6 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800 transition-colors"
        >
          Request New Verification Email
        </a>
      </div>
    {/if}
  </div>
</div>
```

Key patterns:
- Verification happens in load() so result shows immediately on page render
- Token consumed after successful verification (single use)
- Clear success/error states with appropriate icons
- Links to resend page on failure
  </action>
  <verify>
Run `npm run check` - TypeScript should pass.
Navigate to /auth/verify-email (without token) - should show error.
Navigate to /auth/verify-email?token=invalid - should show "Invalid or expired" error.
  </verify>
  <done>
verify-email route handles verification link clicks. Shows success with dashboard link or failure with resend link.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create resend-verification route with rate limiting</name>
  <files>src/routes/auth/resend-verification/+page.server.ts, src/routes/auth/resend-verification/+page.svelte</files>
  <action>
Create the resend-verification route for users to request new verification emails.

**src/routes/auth/resend-verification/+page.server.ts:**
```typescript
import { fail } from '@sveltejs/kit';
import type { Actions, PageServerLoad } from './$types';
import { requireAuth, generateEmailVerificationToken } from '$lib/server/auth';
import { sendVerificationEmail } from '$lib/server/email';
import { db } from '$lib/server/db';
import { users } from '$lib/server/schema';
import { eq } from 'drizzle-orm';

// Simple in-memory rate limiter (3 resends per 15-minute window)
const resendAttempts = new Map<string, { count: number; resetAt: Date }>();

function canResendVerification(userId: string): boolean {
  const now = new Date();
  const userAttempts = resendAttempts.get(userId);

  if (!userAttempts || userAttempts.resetAt < now) {
    // Reset window (15 minutes)
    resendAttempts.set(userId, {
      count: 1,
      resetAt: new Date(now.getTime() + 15 * 60 * 1000)
    });
    return true;
  }

  // Limit: 3 resends per 15 minutes
  if (userAttempts.count >= 3) {
    return false;
  }

  userAttempts.count++;
  return true;
}

export const load: PageServerLoad = async (event) => {
  const user = requireAuth(event);

  // Get fresh user data to check emailVerified status
  const freshUser = await db.query.users.findFirst({
    where: eq(users.id, user.id),
    columns: { email: true, emailVerified: true }
  });

  return {
    email: freshUser?.email ?? user.email,
    emailVerified: freshUser?.emailVerified ?? false
  };
};

export const actions: Actions = {
  default: async (event) => {
    const user = requireAuth(event);

    // Get fresh user data
    const freshUser = await db.query.users.findFirst({
      where: eq(users.id, user.id),
      columns: { email: true, emailVerified: true }
    });

    if (!freshUser) {
      return fail(404, { error: 'User not found' });
    }

    // Already verified
    if (freshUser.emailVerified) {
      return { success: true, message: 'Your email is already verified!' };
    }

    // Check rate limiting
    if (!canResendVerification(user.id)) {
      return fail(429, {
        error: 'Too many requests. Please wait 15 minutes before requesting another verification email.'
      });
    }

    try {
      const token = await generateEmailVerificationToken(user.id);
      await sendVerificationEmail(freshUser.email, token);

      return {
        success: true,
        message: 'Verification email sent! Check your inbox.'
      };
    } catch (error) {
      console.error('Resend verification error:', error);
      return fail(500, {
        error: 'Failed to send verification email. Please try again later.'
      });
    }
  }
};
```

**src/routes/auth/resend-verification/+page.svelte:**
```svelte
<script lang="ts">
  import { enhance } from '$app/forms';

  interface Props {
    data: { email: string; emailVerified: boolean };
    form: { error?: string; success?: boolean; message?: string } | null;
  }

  let { data, form }: Props = $props();
  let loading = $state(false);
</script>

<svelte:head>
  <title>Resend Verification | WoodShop Toolbox</title>
</svelte:head>

<div class="min-h-screen bg-stone-100 flex items-center justify-center py-12 px-4">
  <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
    <h1 class="text-2xl font-bold text-stone-800 mb-2 text-center">Email Verification</h1>

    {#if data.emailVerified}
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4 mt-4">
          <span class="text-green-600 text-2xl">&#x2713;</span>
        </div>
        <p class="text-stone-600 mb-6">
          Your email <strong>{data.email}</strong> is already verified.
        </p>
        <a
          href="/"
          class="inline-block px-6 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800 transition-colors"
        >
          Go to Dashboard
        </a>
      </div>
    {:else}
      <p class="text-stone-600 mb-6 text-center">
        We'll send a verification link to <strong>{data.email}</strong>
      </p>

      {#if form?.error}
        <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
          {form.error}
        </div>
      {/if}

      {#if form?.success}
        <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm">
          {form.message}
        </div>
      {/if}

      <form
        method="POST"
        use:enhance={() => {
          loading = true;
          return async ({ update }) => {
            await update();
            loading = false;
          };
        }}
      >
        <button
          type="submit"
          disabled={loading}
          class="w-full px-4 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800 disabled:opacity-50 transition-colors"
        >
          {loading ? 'Sending...' : 'Send Verification Email'}
        </button>
      </form>

      <p class="mt-4 text-sm text-stone-500 text-center">
        Didn't receive the email? Check your spam folder or try again.
      </p>
    {/if}

    <div class="mt-6 text-center">
      <a href="/" class="text-amber-700 hover:text-amber-800 text-sm">
        &larr; Back to Dashboard
      </a>
    </div>
  </div>
</div>
```

Key patterns:
- requireAuth ensures only logged-in users can resend
- Rate limiting: 3 resends per 15 minutes (in-memory Map)
- Shows "already verified" state if email is verified
- Clear feedback for success and error states
  </action>
  <verify>
Run `npm run check` - TypeScript should pass.
Log in and navigate to /auth/resend-verification - should show resend form.
Click send multiple times - should hit rate limit after 3 attempts.
  </verify>
  <done>
resend-verification route allows authenticated users to request new verification emails with rate limiting (3/15min).
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate verification email with signup and add admin badge</name>
  <files>src/routes/auth/signup/+page.server.ts, src/routes/admin/users/[id]/+page.svelte, src/routes/admin/users/[id]/+page.server.ts</files>
  <action>
**1. Modify src/routes/auth/signup/+page.server.ts:**

Add imports at top:
```typescript
import { generateEmailVerificationToken } from '$lib/server/auth';
import { sendVerificationEmail } from '$lib/server/email';
```

After user creation (after `await db.insert(users).values({...})`), add:
```typescript
// Send verification email (non-blocking - errors logged but don't prevent signup)
try {
  const verificationToken = await generateEmailVerificationToken(id);
  await sendVerificationEmail(email, verificationToken);
} catch (error) {
  console.error('Failed to send verification email:', error);
  // Continue with signup - user can request resend later
}
```

The insert values should also include `emailVerified: false` (though it defaults to false, explicit is clearer).

**2. Modify src/routes/admin/users/[id]/+page.server.ts:**

Update the user query to include emailVerified:
- Find the db.query.users.findFirst call in the load function
- Add `emailVerified: true` to the columns selection (or remove columns restriction if using relations)

The query should return emailVerified field.

**3. Modify src/routes/admin/users/[id]/+page.svelte:**

Update the User interface to include emailVerified:
```typescript
interface User {
  id: string;
  email: string;
  role: 'user' | 'admin';
  disabled: boolean;
  emailVerified: boolean;
  createdAt: Date;
}
```

Add verification badge after the existing status badges (after the Active/Disabled badge, around line 97):
```svelte
<!-- Email verification badge -->
{#if data.user.emailVerified}
  <span
    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
  >
    &#x2713; Verified
  </span>
{:else}
  <span
    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800"
  >
    &#x26A0; Unverified
  </span>
{/if}
```

Also add Email Verified status to the User Details card (in the dl grid, after Status):
```svelte
<div>
  <dt class="text-sm font-medium text-stone-500">Email Verified</dt>
  <dd class="mt-1 text-sm text-stone-900">
    {data.user.emailVerified ? 'Yes' : 'No'}
  </dd>
</div>
```

Key patterns:
- Signup: Non-blocking email send (try-catch, log errors, continue)
- Admin: Verification badge uses same style as existing badges
- Badge colors: green-100/green-800 for verified, amber-100/amber-800 for unverified
  </action>
  <verify>
Run `npm run check` - TypeScript should pass.
Create new user via signup - should receive verification email.
Visit admin user detail page - should show verification badge.
  </verify>
  <done>
Signup sends verification email (non-blocking). Admin user detail shows email verification badge and status.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes with no TypeScript errors
2. Signup flow:
   - Create new account -> verification email sent within 60 seconds
   - Signup completes even if email fails (non-blocking)
3. Verification flow:
   - Click link in email -> email marked as verified
   - Success page shows with dashboard link
   - Invalid/expired token shows error with resend link
4. Resend flow:
   - Logged-in user can request new verification email
   - Rate limited to 3 per 15 minutes
   - Already verified users see confirmation
5. Admin UI:
   - User detail page shows verification badge
   - Verified: green checkmark badge
   - Unverified: amber warning badge
</verification>

<success_criteria>
- [ ] verify-email route handles token validation and email marking
- [ ] resend-verification route has rate limiting (3/15min)
- [ ] Signup sends verification email (non-blocking)
- [ ] Admin user detail shows verification badge
- [ ] All routes use consistent amber/green styling
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-email-verification/16-02-SUMMARY.md`
</output>
