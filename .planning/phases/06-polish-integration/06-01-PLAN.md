---
phase: 06-polish-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/api/bom/generate/+server.ts
  - src/routes/bom/new/+page.svelte
autonomous: true

must_haves:
  truths:
    - "API errors return specific status codes (400, 503, 504, 500) with actionable messages"
    - "User sees specific error message when BOM generation fails"
    - "User can retry failed generation without navigating away"
    - "User sees 'taking longer than usual' message after 10 seconds"
  artifacts:
    - path: "src/routes/api/bom/generate/+server.ts"
      provides: "Error classification by type"
      contains: "504|timeout|rate.?limit"
    - path: "src/routes/bom/new/+page.svelte"
      provides: "Retry button, timeout feedback"
      contains: "retryGeneration|showExtendedWait"
  key_links:
    - from: "src/routes/api/bom/generate/+server.ts"
      to: "HTTP status codes"
      via: "Catch block error classification"
      pattern: "status:\\s*(400|503|504|500)"
    - from: "src/routes/bom/new/+page.svelte"
      to: "API error responses"
      via: "Fetch response handling"
      pattern: "response\\.status"
---

<objective>
Improve error handling across the BOM generation flow so users get helpful, actionable feedback when things go wrong.

Purpose: Error states are currently vague ("Failed to generate BOM"). Users need to know WHY generation failed and have the option to retry.
Output: Specific error messages by cause, retry capability, extended loading feedback
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/routes/api/bom/generate/+server.ts
@src/routes/bom/new/+page.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance API error classification</name>
  <files>src/routes/api/bom/generate/+server.ts</files>
  <action>
  Update the catch block to classify errors by type and return appropriate status codes:

  1. **Timeout errors** (504):
     - Check for `error.message` containing 'timeout', 'ETIMEDOUT', 'ECONNABORTED'
     - Return: `{ error: "Generation timed out. The AI service is slow - please try again." }`

  2. **Rate limit errors** (429):
     - Check for `error.message` containing 'rate limit', '429', 'too many requests'
     - Return: `{ error: "Too many requests. Please wait a moment and try again." }`

  3. **API key/auth errors** (503) - already exists, keep it:
     - Check for 'API key', 'unauthorized', '401'
     - Return: `{ error: "AI service configuration error. Check API keys." }`

  4. **Network errors** (503):
     - Check for 'ENOTFOUND', 'ECONNREFUSED', 'network'
     - Return: `{ error: "Cannot reach AI service. Check your connection." }`

  5. **Unknown errors** (500) - default:
     - Return: `{ error: "Failed to generate BOM. Please try again." }`

  Pattern:
  ```typescript
  } catch (error) {
    console.error('BOM generation error:', error);

    const message = error instanceof Error ? error.message.toLowerCase() : '';

    // Timeout
    if (message.includes('timeout') || message.includes('etimedout')) {
      return new Response(JSON.stringify({ error: 'Generation timed out. The AI service is slow - please try again.' }), {
        status: 504,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // Rate limit
    if (message.includes('rate limit') || message.includes('429') || message.includes('too many')) {
      return new Response(JSON.stringify({ error: 'Too many requests. Please wait a moment and try again.' }), {
        status: 429,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // API key (existing)
    if (message.includes('api key') || message.includes('unauthorized') || message.includes('401')) {
      return new Response(JSON.stringify({ error: 'AI service configuration error. Check API keys.' }), {
        status: 503,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // Network
    if (message.includes('enotfound') || message.includes('econnrefused') || message.includes('network')) {
      return new Response(JSON.stringify({ error: 'Cannot reach AI service. Check your connection.' }), {
        status: 503,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // Default
    return new Response(JSON.stringify({ error: 'Failed to generate BOM. Please try again.' }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
  ```
  </action>
  <verify>
  Read the updated file and confirm:
  - 5 distinct error classifications exist
  - Each returns appropriate status code
  - Error messages are user-friendly
  </verify>
  <done>API endpoint classifies errors into timeout, rate-limit, auth, network, and unknown categories with specific status codes and messages</done>
</task>

<task type="auto">
  <name>Task 2: Add retry and loading timeout feedback to client</name>
  <files>src/routes/bom/new/+page.svelte</files>
  <action>
  Update the client-side handling to support:

  1. **Retry capability** - Store project details for retry:
     ```typescript
     let lastProjectDetails = $state<ProjectDetails | null>(null);
     ```

  2. **Extended loading feedback** - Show message after 10 seconds:
     ```typescript
     let showExtendedWait = $state(false);
     let loadingTimeout: ReturnType<typeof setTimeout> | null = null;
     ```

  3. **Update handleWizardComplete**:
     ```typescript
     async function handleWizardComplete(details: ProjectDetails) {
       lastProjectDetails = details;  // Store for retry
       currentView = 'loading';
       error = null;
       showExtendedWait = false;

       // Start extended wait timer (10 seconds)
       loadingTimeout = setTimeout(() => {
         showExtendedWait = true;
       }, 10000);

       try {
         const response = await fetch('/api/bom/generate', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify(details)
         });

         if (!response.ok) {
           const data = await response.json();
           throw new Error(data.error || 'Failed to generate BOM');
         }

         const bom: BOM = await response.json();
         generatedBOM = bom;
         currentView = 'result';
       } catch (e) {
         console.error('BOM generation failed:', e);
         error = e instanceof Error ? e.message : 'An unexpected error occurred';
         currentView = 'wizard';
       } finally {
         if (loadingTimeout) {
           clearTimeout(loadingTimeout);
           loadingTimeout = null;
         }
         showExtendedWait = false;
       }
     }
     ```

  4. **Add retry function**:
     ```typescript
     function handleRetry() {
       if (lastProjectDetails) {
         handleWizardComplete(lastProjectDetails);
       }
     }
     ```

  5. **Update error display** (in the wizard view error block):
     ```svelte
     {#if error}
       <div class="mb-6 rounded-lg border border-red-200 bg-red-50 p-4">
         <p class="font-medium text-red-800">Generation Failed</p>
         <p class="mt-1 text-sm text-red-700">{error}</p>
         <div class="mt-3 flex gap-2">
           {#if lastProjectDetails}
             <button
               type="button"
               onclick={handleRetry}
               class="rounded bg-red-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-red-700"
             >
               Retry
             </button>
           {/if}
           <button
             type="button"
             onclick={() => (error = null)}
             class="text-sm font-medium text-red-700 underline hover:no-underline"
           >
             Dismiss
           </button>
         </div>
       </div>
     {/if}
     ```

  6. **Update loading view** to show extended wait message:
     ```svelte
     {:else if currentView === 'loading'}
       <div class="flex min-h-[400px] flex-col items-center justify-center">
         <div class="mb-4 h-12 w-12 animate-spin rounded-full border-4 border-amber-200 border-t-amber-600"></div>
         <p class="text-lg font-medium text-gray-900">Generating your bill of materials...</p>
         <p class="mt-1 text-gray-600">This may take a few moments.</p>
         {#if showExtendedWait}
           <p class="mt-4 text-sm text-amber-700">Taking longer than usual - still working...</p>
         {/if}
       </div>
     {/if}
     ```
  </action>
  <verify>
  1. Read updated file and confirm new state variables exist
  2. Confirm retry button appears in error block
  3. Confirm extended wait message appears in loading block
  </verify>
  <done>Client displays specific error messages, offers retry button, and shows "taking longer" feedback after 10 seconds</done>
</task>

</tasks>

<verification>
1. Code review: Verify error classification covers all cases
2. Code review: Verify retry and timeout feedback are implemented
</verification>

<success_criteria>
- API returns 5 distinct error types with specific status codes
- Client shows user-friendly error messages
- Retry button available after failure
- Extended loading feedback appears after 10 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-integration/06-01-SUMMARY.md`
</output>
