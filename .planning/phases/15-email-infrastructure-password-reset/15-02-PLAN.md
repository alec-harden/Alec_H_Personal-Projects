---
phase: 15-email-infrastructure-password-reset
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/routes/auth/forgot-password/+page.svelte
  - src/routes/auth/forgot-password/+page.server.ts
  - src/routes/auth/reset-password/+page.svelte
  - src/routes/auth/reset-password/+page.server.ts
  - src/routes/auth/login/+page.svelte
autonomous: true
user_setup:
  - service: resend
    why: "Transactional email delivery for password reset"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
      - name: PUBLIC_BASE_URL
        source: "Your deployment URL (e.g., https://woodshop.example.com)"
      - name: RESEND_FROM_EMAIL
        source: "Optional: Your verified domain email (e.g., noreply@yourdomain.com)"
    dashboard_config:
      - task: "Create Resend account"
        location: "https://resend.com/signup"
      - task: "Verify domain (for production)"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "User can access forgot password form from login page"
    - "Submitting forgot password shows success message regardless of email existence"
    - "Valid reset link allows user to set new password"
    - "Expired or invalid reset link shows error"
    - "After reset, user can login with new password"
  artifacts:
    - path: "src/routes/auth/forgot-password/+page.svelte"
      provides: "Forgot password request form UI"
      min_lines: 40
    - path: "src/routes/auth/forgot-password/+page.server.ts"
      provides: "Form action to generate token and send email"
      exports: ["actions"]
    - path: "src/routes/auth/reset-password/+page.svelte"
      provides: "Reset password form UI"
      min_lines: 50
    - path: "src/routes/auth/reset-password/+page.server.ts"
      provides: "Form action to validate token and update password"
      exports: ["load", "actions"]
    - path: "src/routes/auth/login/+page.svelte"
      provides: "Login page with forgot password link"
      contains: "Forgot password"
  key_links:
    - from: "src/routes/auth/forgot-password/+page.server.ts"
      to: "src/lib/server/auth.ts"
      via: "generatePasswordResetToken import"
      pattern: "import.*generatePasswordResetToken"
    - from: "src/routes/auth/forgot-password/+page.server.ts"
      to: "src/lib/server/email.ts"
      via: "sendPasswordResetEmail import"
      pattern: "import.*sendPasswordResetEmail"
    - from: "src/routes/auth/reset-password/+page.server.ts"
      to: "src/lib/server/auth.ts"
      via: "validatePasswordResetToken and consumePasswordResetToken imports"
      pattern: "import.*(validatePasswordResetToken|consumePasswordResetToken)"
---

<objective>
Create forgot password and reset password routes with full UI and form handling.

Purpose: Complete the password reset user flow - request reset, receive email, set new password.
Output: Two new routes (/auth/forgot-password, /auth/reset-password) and updated login page with "Forgot password?" link.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-email-infrastructure-password-reset/15-RESEARCH.md
@.planning/phases/15-email-infrastructure-password-reset/15-01-SUMMARY.md
@src/routes/auth/login/+page.svelte
@src/routes/auth/login/+page.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create forgot password route</name>
  <files>src/routes/auth/forgot-password/+page.server.ts, src/routes/auth/forgot-password/+page.svelte</files>
  <action>
Create src/routes/auth/forgot-password/+page.server.ts:

```typescript
import { redirect } from '@sveltejs/kit';
import type { Actions, PageServerLoad } from './$types';
import { db } from '$lib/server/db';
import { users } from '$lib/server/schema';
import { eq } from 'drizzle-orm';
import { generatePasswordResetToken } from '$lib/server/auth';
import { sendPasswordResetEmail } from '$lib/server/email';

export const load: PageServerLoad = async ({ locals }) => {
  // Redirect if already logged in
  if (locals.user) {
    throw redirect(302, '/');
  }
  return {};
};

export const actions: Actions = {
  default: async ({ request }) => {
    const data = await request.formData();
    const email = data.get('email')?.toString().trim().toLowerCase();

    // Always return same success message (prevents user enumeration)
    const successMessage = 'If an account exists with that email, you will receive a password reset link shortly.';

    if (!email) {
      // Still return success to prevent enumeration
      return { success: true, message: successMessage };
    }

    // Basic email validation
    if (!email.includes('@') || email.length < 5) {
      return { success: true, message: successMessage };
    }

    try {
      // Look up user
      const user = await db.query.users.findFirst({
        where: eq(users.email, email)
      });

      // Only send email if user exists, but ALWAYS return success
      if (user && !user.disabled) {
        const token = await generatePasswordResetToken(user.id);
        await sendPasswordResetEmail(email, token);
      }

      // Same response regardless of whether user exists
      return { success: true, message: successMessage };
    } catch (error) {
      // Log error but don't expose to user
      console.error('Password reset error:', error);
      return { success: true, message: successMessage };
    }
  }
};
```

Create src/routes/auth/forgot-password/+page.svelte:

```svelte
<script lang="ts">
  import { enhance } from '$app/forms';

  interface Props {
    form: { success?: boolean; message?: string } | null;
  }

  let { form }: Props = $props();
  let loading = $state(false);
  let email = $state('');
</script>

<svelte:head>
  <title>Forgot Password - WoodShop Toolbox</title>
</svelte:head>

<div class="min-h-screen flex items-center justify-center bg-stone-100 py-12 px-4">
  <div class="max-w-md w-full">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-stone-800">Forgot Password</h1>
      <p class="mt-2 text-stone-600">Enter your email to receive a reset link</p>
    </div>

    <div class="bg-white shadow-lg rounded-lg p-8">
      {#if form?.success}
        <div class="mb-4 p-4 bg-green-50 border border-green-200 text-green-800 rounded-md">
          <p class="font-medium">Check your email</p>
          <p class="text-sm mt-1">{form.message}</p>
        </div>
        <p class="text-center text-sm text-stone-600 mt-4">
          <a href="/auth/login" class="text-amber-600 hover:text-amber-700 font-medium">
            Return to login
          </a>
        </p>
      {:else}
        <form
          method="POST"
          use:enhance={() => {
            loading = true;
            return async ({ update }) => {
              await update();
              loading = false;
            };
          }}
        >
          <div class="mb-6">
            <label for="email" class="block text-sm font-medium text-stone-700 mb-1">
              Email address
            </label>
            <input
              type="email"
              id="email"
              name="email"
              bind:value={email}
              required
              class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
              placeholder="you@example.com"
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            class="w-full py-2 px-4 bg-amber-600 hover:bg-amber-700 disabled:bg-amber-400 text-white font-medium rounded-md transition-colors"
          >
            {loading ? 'Sending...' : 'Send Reset Link'}
          </button>

          <p class="mt-4 text-center text-sm text-stone-600">
            Remember your password?
            <a href="/auth/login" class="text-amber-600 hover:text-amber-700 font-medium">
              Log in
            </a>
          </p>
        </form>
      {/if}
    </div>
  </div>
</div>
```

Key patterns:
- Identical response whether email exists or not (prevents enumeration)
- Disabled accounts don't receive emails (but same response)
- Success state shows confirmation message, not form
- Amber color scheme matches rest of app
  </action>
  <verify>Navigate to /auth/forgot-password, submit form with any email, verify success message shows.</verify>
  <done>Forgot password route created with user enumeration prevention.</done>
</task>

<task type="auto">
  <name>Task 2: Create reset password route</name>
  <files>src/routes/auth/reset-password/+page.server.ts, src/routes/auth/reset-password/+page.svelte</files>
  <action>
Create src/routes/auth/reset-password/+page.server.ts:

```typescript
import { fail, redirect } from '@sveltejs/kit';
import type { Actions, PageServerLoad } from './$types';
import { db } from '$lib/server/db';
import { users } from '$lib/server/schema';
import { eq } from 'drizzle-orm';
import { validatePasswordResetToken, consumePasswordResetToken, hashPassword } from '$lib/server/auth';

export const load: PageServerLoad = async ({ url, locals }) => {
  // Redirect if already logged in
  if (locals.user) {
    throw redirect(302, '/');
  }

  const token = url.searchParams.get('token');

  if (!token) {
    return { valid: false, error: 'Missing reset token' };
  }

  // Validate token (don't consume yet)
  const userId = await validatePasswordResetToken(token);

  if (!userId) {
    return { valid: false, error: 'Invalid or expired reset link' };
  }

  return { valid: true, token };
};

export const actions: Actions = {
  default: async ({ request, url }) => {
    const data = await request.formData();
    const token = url.searchParams.get('token') || data.get('token')?.toString();
    const password = data.get('password')?.toString();
    const confirmPassword = data.get('confirmPassword')?.toString();

    if (!token) {
      return fail(400, { error: 'Missing reset token' });
    }

    if (!password || password.length < 8) {
      return fail(400, { error: 'Password must be at least 8 characters' });
    }

    if (password !== confirmPassword) {
      return fail(400, { error: 'Passwords do not match' });
    }

    // Validate token
    const userId = await validatePasswordResetToken(token);

    if (!userId) {
      return fail(400, { error: 'Invalid or expired reset link. Please request a new one.' });
    }

    try {
      // Hash new password
      const passwordHash = await hashPassword(password);

      // Update user's password
      await db.update(users)
        .set({ passwordHash })
        .where(eq(users.id, userId));

      // Consume token and invalidate all sessions
      await consumePasswordResetToken(token, userId);

      // Return success - redirect handled by page
      return { success: true };
    } catch (error) {
      console.error('Password reset error:', error);
      return fail(500, { error: 'Failed to reset password. Please try again.' });
    }
  }
};
```

Create src/routes/auth/reset-password/+page.svelte:

```svelte
<script lang="ts">
  import { enhance } from '$app/forms';
  import { goto } from '$app/navigation';

  interface Props {
    data: { valid: boolean; token?: string; error?: string };
    form: { success?: boolean; error?: string } | null;
  }

  let { data, form }: Props = $props();
  let loading = $state(false);
</script>

<svelte:head>
  <title>Reset Password - WoodShop Toolbox</title>
</svelte:head>

<div class="min-h-screen flex items-center justify-center bg-stone-100 py-12 px-4">
  <div class="max-w-md w-full">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-stone-800">Reset Password</h1>
      <p class="mt-2 text-stone-600">Enter your new password</p>
    </div>

    <div class="bg-white shadow-lg rounded-lg p-8">
      {#if form?.success}
        <div class="text-center">
          <div class="mb-4 p-4 bg-green-50 border border-green-200 text-green-800 rounded-md">
            <p class="font-medium">Password reset successful!</p>
            <p class="text-sm mt-1">You can now log in with your new password.</p>
          </div>
          <a
            href="/auth/login"
            class="inline-block mt-4 py-2 px-4 bg-amber-600 hover:bg-amber-700 text-white font-medium rounded-md transition-colors"
          >
            Go to Login
          </a>
        </div>
      {:else if !data.valid}
        <div class="text-center">
          <div class="mb-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-md">
            <p class="font-medium">Invalid Reset Link</p>
            <p class="text-sm mt-1">{data.error}</p>
          </div>
          <a
            href="/auth/forgot-password"
            class="inline-block mt-4 py-2 px-4 bg-amber-600 hover:bg-amber-700 text-white font-medium rounded-md transition-colors"
          >
            Request New Link
          </a>
        </div>
      {:else}
        <form
          method="POST"
          use:enhance={() => {
            loading = true;
            return async ({ update }) => {
              await update();
              loading = false;
            };
          }}
        >
          {#if form?.error}
            <div class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-md text-sm">
              {form.error}
            </div>
          {/if}

          <input type="hidden" name="token" value={data.token} />

          <div class="mb-4">
            <label for="password" class="block text-sm font-medium text-stone-700 mb-1">
              New Password
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              minlength="8"
              class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
              placeholder="At least 8 characters"
            />
          </div>

          <div class="mb-6">
            <label for="confirmPassword" class="block text-sm font-medium text-stone-700 mb-1">
              Confirm Password
            </label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              required
              minlength="8"
              class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
              placeholder="Confirm your password"
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            class="w-full py-2 px-4 bg-amber-600 hover:bg-amber-700 disabled:bg-amber-400 text-white font-medium rounded-md transition-colors"
          >
            {loading ? 'Resetting...' : 'Reset Password'}
          </button>
        </form>
      {/if}
    </div>
  </div>
</div>
```

Key patterns:
- Token validated in load() before showing form
- Invalid/expired tokens show error state with link to request new
- Password confirmation required
- Success state shows confirmation with login link
- Token passed as hidden field (also in URL)
- All sessions invalidated after reset (security)
  </action>
  <verify>Navigate to /auth/reset-password without token - should show invalid link error. Navigate with valid token - should show form.</verify>
  <done>Reset password route created with token validation and password update.</done>
</task>

<task type="auto">
  <name>Task 3: Add forgot password link to login page</name>
  <files>src/routes/auth/login/+page.svelte</files>
  <action>
Update src/routes/auth/login/+page.svelte to add "Forgot password?" link.

After the password input div (after line 66), add a "Forgot password?" link:

```svelte
<!-- After the password input div, before the submit button -->
<div class="mb-6 flex justify-end">
  <a href="/auth/forgot-password" class="text-sm text-amber-600 hover:text-amber-700">
    Forgot password?
  </a>
</div>
```

Move the `mb-6` from the password div to this new div. The password div should become `mb-4`.

The structure should be:
1. Email input (mb-4)
2. Password input (mb-4)
3. Forgot password link (mb-6, flex justify-end)
4. Submit button

This positions the forgot password link below the password field, right-aligned, which is the common pattern users expect.
  </action>
  <verify>Navigate to /auth/login, verify "Forgot password?" link is visible below password field and links to /auth/forgot-password.</verify>
  <done>Login page updated with forgot password link.</done>
</task>

</tasks>

<verification>
1. npm run check passes (TypeScript)
2. Login page shows "Forgot password?" link
3. Forgot password form accepts email and shows success message
4. Reset password form validates token on load
5. Reset password form rejects invalid/expired tokens
6. Password reset updates user password and invalidates sessions
7. User can login with new password after reset
</verification>

<success_criteria>
- EMAIL-01: User can request password reset from login page (via forgot-password link)
- EMAIL-02: User receives email with password reset link (sendPasswordResetEmail called)
- EMAIL-03: User can set new password via reset link (expires in 1 hour)
- All forms follow established UI patterns (amber buttons, stone backgrounds)
- User enumeration prevented (identical responses)
</success_criteria>

<output>
After completion, create `.planning/phases/15-email-infrastructure-password-reset/15-02-SUMMARY.md`
</output>
