---
phase: 22-ui-refinements-and-cut-list-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/cutlist/+page.svelte
  - src/routes/cutlist/from-bom/+page.svelte
  - src/routes/cutlist/from-bom/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "Blade Kerf section appears above Stock and Cuts input forms"
    - "Available Stock form is on the left, Required Cuts form is on the right"
    - "BOM import loads lumber items into Available Stock (not Required Cuts)"
    - "Clicking 'Optimize Cuts' shows a loading screen for at least 2.5 seconds"
  artifacts:
    - path: "src/routes/cutlist/+page.svelte"
      provides: "Reordered UI with kerf first, stock left, cuts right, loading screen"
      contains: "isOptimizing"
    - path: "src/routes/cutlist/from-bom/+page.server.ts"
      provides: "BOM items loaded as stock instead of cuts"
      contains: "stock:"
  key_links:
    - from: "src/routes/cutlist/+page.svelte"
      to: "KerfConfig component"
      via: "Component placed before input-grid"
      pattern: "KerfConfig.*input-grid"
    - from: "src/routes/cutlist/from-bom/+page.server.ts"
      to: "src/routes/cutlist/+page.svelte"
      via: "goto state passing"
      pattern: "stock.*mode"
---

<objective>
Reorder the cut list optimizer UI to show kerf configuration first, place stock on left and cuts on right, fix BOM import to populate stock instead of cuts, and add a 2.5-second minimum loading screen when optimizing.

Purpose: Improve logical flow (configure kerf before entering dimensions, understand what you have before what you need) and fix BOM import logic (lumber items are available stock, not cuts to make).
Output: Reordered cut list page, fixed BOM import action, loading screen with minimum duration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-ui-refinements-and-cut-list-fixes/22-RESEARCH.md
@src/routes/cutlist/+page.svelte
@src/routes/cutlist/from-bom/+page.svelte
@src/routes/cutlist/from-bom/+page.server.ts
@src/lib/components/cutlist/KerfConfig.svelte
@src/lib/components/cutlist/StockInputForm.svelte
@src/lib/components/cutlist/CutInputForm.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorder cut list page UI (kerf first, stock/cuts side-by-side)</name>
  <files>src/routes/cutlist/+page.svelte</files>
  <action>
1. Move the KerfConfig section ABOVE the input-grid in the template:

Current order:
```svelte
<!-- Mode Selection -->
<ModeSelector ... />

<!-- Input Forms -->
<div class="input-section">
  <div class="input-grid">
    <CutInputForm ... />
    <StockInputForm ... />
  </div>
  <div class="kerf-section">
    <KerfConfig ... />
  </div>
</div>
```

New order:
```svelte
<!-- Mode Selection -->
<ModeSelector ... />

<!-- Kerf Configuration (moved above inputs) -->
<div class="kerf-section">
  <KerfConfig bind:kerf />
</div>

<!-- Input Forms (stock left, cuts right) -->
<div class="input-section">
  <div class="input-grid">
    <!-- Stock (Available Material) on LEFT -->
    <div class="input-column">
      <StockInputForm bind:stock {mode} />
    </div>

    <!-- Cuts (Required Pieces) on RIGHT -->
    <div class="input-column">
      <CutInputForm bind:cuts {mode} />
    </div>
  </div>
</div>
```

2. Update the kerf-section styling if needed:
```css
.kerf-section {
  max-width: 600px;
  margin-bottom: var(--space-lg);
}
```

3. Remove the kerf-section from inside input-section since it's now outside.

4. Verify component headers:
   - StockInputForm should have heading "Available Stock" (check component)
   - CutInputForm should have heading "Required Cuts" (check component)
  </action>
  <verify>
- Navigate to /cutlist
- Verify order from top to bottom:
  1. Mode Selector (Linear/Sheet)
  2. Blade Kerf configuration
  3. Side-by-side: Available Stock (left), Required Cuts (right)
  4. Action buttons
- Responsive: on mobile, stock should stack above cuts
  </verify>
  <done>
- Blade Kerf section appears above input forms
- Available Stock is on the left, Required Cuts is on the right
- Layout is responsive (stacks on mobile)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 2.5-second minimum loading screen</name>
  <files>src/routes/cutlist/+page.svelte</files>
  <action>
1. Update the handleOptimize function to enforce 2.5-second minimum display time:

```typescript
async function handleOptimize() {
  isOptimizing = true;
  error = null;
  result = null;

  const startTime = Date.now();

  try {
    const response = await fetch('/api/cutlist/optimize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode, cuts, stock, kerf })
    });

    if (!response.ok) {
      // Error occurred - skip delay, show error immediately
      const data = await response.json();
      error = data.error || 'Optimization failed';
      isOptimizing = false;
      return;
    }

    // Parse result
    const optimizationResult = await response.json();

    // Enforce minimum 2.5 second loading display
    const elapsed = Date.now() - startTime;
    const minimumDuration = 2500; // 2.5 seconds

    if (elapsed < minimumDuration) {
      await new Promise(resolve => setTimeout(resolve, minimumDuration - elapsed));
    }

    result = optimizationResult;
  } catch (e) {
    // Network error - show immediately
    error = e instanceof Error ? e.message : 'An error occurred';
  } finally {
    isOptimizing = false;
  }
}
```

2. The loading state already shows a spinner and "Optimizing..." text. Verify it displays correctly:
```svelte
{#if isOptimizing}
  <svg viewBox="0 0 24 24" class="btn-spinner">
    <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="3" opacity="0.25" />
    <path d="M12 2a10 10 0 0110 10" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
  </svg>
  Optimizing...
{:else}
  <!-- ... -->
{/if}
```

Note: On error, we skip the delay and show the error immediately (better UX). The delay only applies to successful optimization.
  </action>
  <verify>
- Navigate to /cutlist
- Add some cuts and stock entries
- Click "Optimize Cuts"
- Verify loading spinner displays for at least 2.5 seconds
- Verify results appear after loading completes
- Test error case: leave stock empty, verify error shows immediately
  </verify>
  <done>
- Clicking "Optimize Cuts" shows loading screen for minimum 2.5 seconds
- Errors skip the delay and show immediately
- Loading animation is visible during the wait
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix BOM import to populate stock instead of cuts</name>
  <files>src/routes/cutlist/from-bom/+page.server.ts, src/routes/cutlist/from-bom/+page.svelte, src/routes/cutlist/+page.svelte</files>
  <action>
1. In `src/routes/cutlist/from-bom/+page.server.ts`, update the loadFromBoms action:

Change the return from `cuts` to `stock`:
```typescript
export const actions = {
  loadFromBoms: async ({ request, locals }) => {
    // ... existing validation code ...

    // Transform lumber items to Stock format (not Cut format)
    const stock = validLumberItems.map((item, index) => ({
      id: crypto.randomUUID(),
      length: item.length!,
      width: item.width,
      quantity: item.quantity,
      label: item.name,
      position: index
    }));

    return { success: true, stock, mode };  // Changed from 'cuts' to 'stock'
  }
} satisfies Actions;
```

2. In `src/routes/cutlist/from-bom/+page.svelte`, update the enhance callback:

```typescript
use:enhance={() => {
  loading = true;
  return async ({ result }) => {
    loading = false;
    if (result.type === 'success' && result.data?.stock) {  // Changed from 'cuts' to 'stock'
      // Redirect to cutlist with pre-populated stock (not cuts)
      goto('/cutlist', {
        state: {
          stock: result.data.stock,  // Changed from 'cuts' to 'stock'
          mode: result.data.mode
        }
      });
    }
  };
}}
```

Also update the description text:
```svelte
<p class="page-subtitle">
  Select a project and BOMs to pre-populate available stock from lumber items
</p>
```

And the button label from "Load Cuts" to "Load Stock":
```svelte
<button type="submit" class="btn-primary" disabled={!canLoad}>
  {#if loading}
    <!-- spinner -->
    Loading...
  {:else}
    Load Stock
  {/if}
</button>
```

3. In `src/routes/cutlist/+page.svelte`, update the $effect to handle incoming stock:

```typescript
// Handle incoming state from BOM import
$effect(() => {
  const state = $page.state as { stock?: Stock[]; mode?: CutListMode } | undefined;
  if (state?.stock && state.stock.length > 0) {
    mode = state.mode || 'linear';
    stock = state.stock;  // Populate stock (not cuts)
    // Reset cuts and results when loading from BOM
    cuts = [createCut(mode)];
    result = null;
    error = null;
  }
});
```
  </action>
  <verify>
- Navigate to /cutlist/from-bom
- Select a project with BOMs containing lumber items
- Select BOM(s) and click "Load Stock"
- Verify redirect to /cutlist
- Verify lumber items appear in "Available Stock" section (left column)
- Verify "Required Cuts" section is empty (just default empty row)
  </verify>
  <done>
- BOM import populates "Available Stock" section with lumber items
- "Required Cuts" remains empty for user to fill in
- Description and button text updated to reflect "stock" terminology
  </done>
</task>

</tasks>

<verification>
1. UI order:
   - Kerf config appears above Stock and Cuts
   - Stock (left), Cuts (right) on desktop
   - Stacks correctly on mobile

2. Loading screen:
   - Timer shows at least 2.5 seconds
   - Errors skip the delay

3. BOM import:
   - Lumber items populate Stock, not Cuts
   - User can then enter their required cuts

4. Functionality:
   - Optimization still works correctly
   - Saved cut lists still work
</verification>

<success_criteria>
- CUT-33: Blade Kerf section moved above 'Available Stock' and 'Required Cuts'
- CUT-34: Layout change: 'Available Stock' on left, 'Required Cuts' on right
- CUT-35: BOM import loads materials into 'Available Stock' (not 'Required Cuts')
- CUT-36: Mandatory 2.5-second loading screen after 'Optimize Cuts' click (errors shown immediately)
</success_criteria>

<output>
After completion, create `.planning/phases/22-ui-refinements-and-cut-list-fixes/22-03-SUMMARY.md`
</output>
