---
phase: 22-ui-refinements-and-cut-list-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/server/schema.ts
  - src/app.d.ts
  - src/routes/auth/signup/+page.svelte
  - src/routes/auth/signup/+page.server.ts
  - src/lib/components/UserMenu.svelte
  - src/lib/components/Header.svelte
autonomous: true

must_haves:
  truths:
    - "User signup form includes First Name and Last Name fields"
    - "If user leaves name fields blank, they default to 'Wood' and 'Worker'"
    - "Logged-in dropdown displays user's first name instead of email"
    - "User dropdown menu stays fixed in top-right corner when scrolling"
  artifacts:
    - path: "src/lib/server/schema.ts"
      provides: "firstName and lastName columns on users table"
      contains: "firstName: text"
    - path: "src/routes/auth/signup/+page.svelte"
      provides: "First Name and Last Name input fields"
      contains: "firstName"
    - path: "src/lib/components/UserMenu.svelte"
      provides: "First name display in dropdown trigger"
      contains: "firstName"
  key_links:
    - from: "src/routes/auth/signup/+page.server.ts"
      to: "src/lib/server/schema.ts"
      via: "insert with firstName/lastName"
      pattern: "firstName.*lastName"
    - from: "src/lib/components/UserMenu.svelte"
      to: "app.d.ts User type"
      via: "Props interface update"
      pattern: "firstName.*string"
---

<objective>
Add first and last name fields to user accounts and update the header UI to display names instead of email. Fix the user dropdown menu to stay fixed when scrolling.

Purpose: Improve personalization and fix a scroll-related UI bug where the dropdown disappears or moves when users scroll the page.
Output: Schema migration with firstName/lastName columns, updated signup form, personalized header display, fixed-position dropdown.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-ui-refinements-and-cut-list-fixes/22-RESEARCH.md
@src/lib/server/schema.ts
@src/app.d.ts
@src/routes/auth/signup/+page.svelte
@src/routes/auth/signup/+page.server.ts
@src/lib/components/UserMenu.svelte
@src/lib/components/Header.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add firstName and lastName to users schema and app types</name>
  <files>src/lib/server/schema.ts, src/app.d.ts</files>
  <action>
1. In `src/lib/server/schema.ts`, add to the users table definition after `email`:
   - `firstName: text('first_name')` - nullable, no default (allows null for existing users)
   - `lastName: text('last_name')` - nullable, no default

2. In `src/app.d.ts`, update the `App.Locals.user` interface to include:
   - `firstName?: string;` - optional since nullable in schema
   - `lastName?: string;` - optional since nullable in schema

3. Run `npm run db:push` to apply schema changes to database.

Note: Columns are nullable for backward compatibility. Existing users will have null values. Runtime defaults applied during display/signup.
  </action>
  <verify>
- `npm run db:push` completes without errors
- `npm run check` passes (type checking)
  </verify>
  <done>
- Users table has firstName and lastName columns (nullable)
- TypeScript types updated to include optional firstName/lastName
- Database migration applied successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Update signup form and action to capture names</name>
  <files>src/routes/auth/signup/+page.svelte, src/routes/auth/signup/+page.server.ts</files>
  <action>
1. In `src/routes/auth/signup/+page.svelte`:
   - Add First Name input field after email field:
     ```svelte
     <div class="mb-4">
       <label for="firstName" class="block text-sm font-medium text-stone-700 mb-1">
         First Name
       </label>
       <input
         type="text"
         id="firstName"
         name="firstName"
         value={form?.firstName ?? ''}
         class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
         placeholder="Wood"
       />
     </div>
     ```
   - Add Last Name input field after First Name:
     ```svelte
     <div class="mb-4">
       <label for="lastName" class="block text-sm font-medium text-stone-700 mb-1">
         Last Name
       </label>
       <input
         type="text"
         id="lastName"
         name="lastName"
         value={form?.lastName ?? ''}
         class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
         placeholder="Worker"
       />
     </div>
     ```
   - Update Props interface to include firstName and lastName in form type

2. In `src/routes/auth/signup/+page.server.ts`:
   - Extract firstName and lastName from form data
   - Apply defaults if blank: `firstName || 'Wood'` and `lastName || 'Worker'`
   - Include firstName and lastName in the user insert statement
   - Return firstName and lastName in error responses for form repopulation

Note: Fields are optional (no `required` attribute). If left blank, defaults are applied server-side.
  </action>
  <verify>
- Navigate to /auth/signup
- Verify First Name and Last Name fields are visible
- Submit with blank names: verify 'Wood' and 'Worker' are saved
- Submit with custom names: verify custom values are saved
- Check database: `npm run db:studio` shows firstName/lastName columns populated
  </verify>
  <done>
- Signup form has First Name and Last Name input fields
- Blank values default to 'Wood' and 'Worker' on form submission
- Names saved to database during user creation
  </done>
</task>

<task type="auto">
  <name>Task 3: Update UserMenu to display first name and fix positioning</name>
  <files>src/lib/components/UserMenu.svelte, src/lib/components/Header.svelte</files>
  <action>
1. In `src/lib/components/UserMenu.svelte`:
   - Update Props interface to add optional firstName and lastName:
     ```typescript
     interface Props {
       email: string;
       firstName?: string;
       lastName?: string;
       role: 'user' | 'admin';
     }
     ```
   - Create displayName derived value:
     ```typescript
     const displayName = $derived(firstName || email.split('@')[0]);
     const initial = $derived((firstName?.[0] || email[0]).toUpperCase());
     ```
   - Update the button to show displayName instead of email:
     - Change `{email}` to `{displayName}` in the visible span
     - Change `{email[0].toUpperCase()}` to `{initial}` for avatar
   - Keep full email display in the dropdown header for reference

2. Fix dropdown positioning for scroll:
   - Change dropdown div from `absolute` to `fixed` positioning
   - Calculate position relative to viewport:
     ```svelte
     <div class="fixed top-14 right-4 w-48 bg-white rounded-md shadow-lg border border-stone-200 py-1 z-50">
     ```
   - The `top-14` (56px) accounts for header height
   - The `right-4` (16px) matches typical container padding
   - z-index: 50 ensures dropdown is above other elements

3. In `src/lib/components/Header.svelte`:
   - Pass firstName and lastName props to UserMenu component:
     ```svelte
     <UserMenu
       email={user.email}
       firstName={user.firstName}
       lastName={user.lastName}
       role={user.role}
     />
     ```
   - Verify user object is accessed from page data with optional chaining

Note: Fixed positioning removes the dropdown from document flow, so it stays in place during scroll. The position values (top-14, right-4) should match the header layout.
  </action>
  <verify>
- Log in as a user with firstName set
- Verify dropdown trigger shows first name (or email prefix if no firstName)
- Scroll down the page
- Click dropdown: verify it appears fixed in top-right corner, not scrolling with content
- Open dropdown header still shows full email address
  </verify>
  <done>
- UserMenu displays first name instead of email (falls back to email prefix)
- Dropdown menu uses fixed positioning with z-index 50
- Dropdown stays visible and fixed during scroll
  </done>
</task>

</tasks>

<verification>
1. Schema verification:
   - `npm run db:studio` shows firstName and lastName columns in users table
   - Existing users have null values (backward compatible)

2. Signup flow:
   - Create new account with names filled in: verify saved correctly
   - Create new account with names blank: verify defaults to 'Wood Worker'

3. Header display:
   - Log in and verify first name shows in header (not email)
   - Scroll page and click dropdown: stays fixed in corner

4. Type safety:
   - `npm run check` passes with no errors
</verification>

<success_criteria>
- UI-01: Account creation captures First and Last names with 'Wood'/'Worker' defaults
- UI-02: Logged-in dropdown displays user's First Name
- UI-03: User dropdown fixed to top-right corner during scroll
</success_criteria>

<output>
After completion, create `.planning/phases/22-ui-refinements-and-cut-list-fixes/22-01-SUMMARY.md`
</output>
