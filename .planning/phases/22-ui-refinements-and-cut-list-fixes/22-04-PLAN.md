---
phase: 22-ui-refinements-and-cut-list-fixes
plan: 04
type: execute
wave: 2
depends_on: ["22-03"]
files_modified:
  - src/routes/cutlist/+page.svelte
  - src/routes/cutlist/results/+page.svelte
  - src/routes/cutlist/results/+page.ts
  - src/routes/cutlists/+page.svelte
  - src/routes/cutlists/+page.server.ts
  - src/routes/cutlist/[id]/+page.svelte
  - src/routes/cutlist/[id]/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "After optimization, results display on a dedicated /cutlist/results page"
    - "Results page has 'Go Back' button to return to optimizer"
    - "Results page has 'Save to Project' button to save the cut list"
    - "Users can view saved cut lists from the cut lists listing page"
    - "Saved cut lists are viewable and display correctly"
  artifacts:
    - path: "src/routes/cutlist/results/+page.svelte"
      provides: "Dedicated results page with Go Back and Save buttons"
      contains: "OptimizationResults"
    - path: "src/routes/cutlists/+page.svelte"
      provides: "Cut lists listing page"
      contains: "cutLists"
    - path: "src/routes/cutlist/[id]/+page.svelte"
      provides: "Individual cut list view"
      contains: "cutList"
  key_links:
    - from: "src/routes/cutlist/+page.svelte"
      to: "src/routes/cutlist/results/+page.svelte"
      via: "goto navigation after optimization"
      pattern: "goto.*results"
    - from: "src/routes/cutlists/+page.svelte"
      to: "src/routes/cutlist/[id]/+page.svelte"
      via: "Link to individual cut lists"
      pattern: "href.*cutlist"
---

<objective>
Create a dedicated results page for optimization output with navigation buttons, add a cut lists listing page for viewing all saved cut lists, and fix any bugs preventing saved cut list viewing.

Purpose: Separate optimization results from the input form for cleaner UX, provide a centralized view of all saved cut lists, and ensure saved lists are viewable.
Output: New /cutlist/results route, /cutlists listing page, verified [id] route functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-ui-refinements-and-cut-list-fixes/22-RESEARCH.md
@.planning/phases/22-ui-refinements-and-cut-list-fixes/22-03-SUMMARY.md
@src/routes/cutlist/+page.svelte
@src/routes/cutlist/[id]/+page.svelte
@src/routes/cutlist/[id]/+page.server.ts
@src/lib/components/cutlist/OptimizationResults.svelte
@src/lib/components/cutlist/SaveCutListModal.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dedicated results page route</name>
  <files>src/routes/cutlist/results/+page.svelte, src/routes/cutlist/results/+page.ts, src/routes/cutlist/+page.svelte</files>
  <action>
1. Create `src/routes/cutlist/results/+page.ts` (client-side load):
```typescript
import { redirect } from '@sveltejs/kit';
import type { PageLoad } from './$types';

export const load: PageLoad = async ({ url }) => {
  // This page receives data via $page.state from navigation
  // If accessed directly without state, redirect to optimizer
  return {};
};
```

2. Create `src/routes/cutlist/results/+page.svelte`:
```svelte
<script lang="ts">
  import { page } from '$app/stores';
  import { goto } from '$app/navigation';
  import { browser } from '$app/environment';
  import OptimizationResults from '$lib/components/cutlist/OptimizationResults.svelte';
  import SaveCutListModal from '$lib/components/cutlist/SaveCutListModal.svelte';
  import type { OptimizationResult } from '$lib/server/cutOptimizer';
  import type { CutListMode, Cut, Stock } from '$lib/types/cutlist';
  import type { PageData } from './$types';

  let { data }: { data: PageData } = $props();

  // State from navigation
  let result = $state<OptimizationResult | null>(null);
  let mode = $state<CutListMode>('linear');
  let cuts = $state<Cut[]>([]);
  let stock = $state<Stock[]>([]);
  let kerf = $state<number>(0.125);

  // Save modal state
  let showSaveModal = $state(false);
  let saving = $state(false);
  let saveSuccess = $state(false);
  let savedCutListId = $state<string | null>(null);

  // Load state from navigation
  $effect(() => {
    const state = $page.state as {
      result?: OptimizationResult;
      mode?: CutListMode;
      cuts?: Cut[];
      stock?: Stock[];
      kerf?: number;
    } | undefined;

    if (state?.result) {
      result = state.result;
      mode = state.mode || 'linear';
      cuts = state.cuts || [];
      stock = state.stock || [];
      kerf = state.kerf || 0.125;
    } else if (browser) {
      // No state - redirect to optimizer
      goto('/cutlist');
    }
  });

  function handleGoBack() {
    // Navigate back to optimizer with current data
    goto('/cutlist', {
      state: { cuts, stock, mode, kerf }
    });
  }

  async function handleSave(projectId: string, name: string) {
    saving = true;

    try {
      const response = await fetch('/api/cutlist/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          projectId,
          name,
          mode,
          cuts,
          stock,
          kerf
        })
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'Failed to save');
      }

      const savedData = await response.json();
      savedCutListId = savedData.id;
      showSaveModal = false;
      saveSuccess = true;
    } catch (e) {
      console.error('Save failed:', e);
    } finally {
      saving = false;
    }
  }
</script>

<svelte:head>
  <title>Optimization Results | WoodShop Toolbox</title>
</svelte:head>

<div class="results-page animate-fade-in">
  <header class="page-header">
    <h1 class="page-title">Optimization Results</h1>
    <p class="page-description">
      Review your optimized cutting plans below.
    </p>
  </header>

  {#if saveSuccess}
    <div class="success-banner">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="success-icon">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div>
        <span class="success-title">Cut List Saved!</span>
        {#if savedCutListId}
          <a href="/cutlist/{savedCutListId}" class="success-link">View saved cut list</a>
        {/if}
      </div>
    </div>
  {/if}

  {#if result}
    <OptimizationResults {result} {mode} {kerf} />
  {:else}
    <div class="loading-state">
      <p>Loading results...</p>
    </div>
  {/if}

  <div class="action-buttons">
    <button type="button" class="btn-ghost" onclick={handleGoBack}>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Go Back
    </button>
    {#if !saveSuccess}
      <button
        type="button"
        class="btn-primary"
        onclick={() => (showSaveModal = true)}
        disabled={saving}
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
        </svg>
        Save to Project
      </button>
    {/if}
  </div>
</div>

<SaveCutListModal
  open={showSaveModal}
  projects={data.projects || []}
  onSave={handleSave}
  onClose={() => (showSaveModal = false)}
  {saving}
/>

<style>
  .results-page {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .page-header {
    margin-bottom: var(--space-md);
  }

  .page-title {
    font-family: var(--font-display);
    font-size: 1.75rem;
    color: var(--color-ink);
    margin: 0 0 var(--space-xs) 0;
  }

  .page-description {
    font-size: 0.9375rem;
    color: var(--color-ink-muted);
    margin: 0;
  }

  .success-banner {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: #d1fae5;
    border: 1px solid #a7f3d0;
    border-radius: var(--radius-md);
  }

  .success-icon {
    width: 24px;
    height: 24px;
    color: #059669;
    flex-shrink: 0;
  }

  .success-title {
    font-weight: 600;
    color: #065f46;
  }

  .success-link {
    display: block;
    margin-top: var(--space-xs);
    color: #047857;
    text-decoration: underline;
    font-size: 0.875rem;
  }

  .loading-state {
    text-align: center;
    padding: var(--space-2xl);
    color: var(--color-ink-muted);
  }

  .action-buttons {
    display: flex;
    justify-content: center;
    gap: var(--space-md);
    padding: var(--space-lg) 0;
    border-top: 1px solid rgba(17, 17, 17, 0.08);
  }

  .btn-icon {
    width: 20px;
    height: 20px;
  }
</style>
```

3. Create `src/routes/cutlist/results/+page.server.ts` to load projects for save modal:
```typescript
import type { PageServerLoad } from './$types';
import { db } from '$lib/server/db';
import { projects } from '$lib/server/schema';
import { eq, desc } from 'drizzle-orm';

export const load: PageServerLoad = async ({ locals }) => {
  if (!locals.user) {
    return { projects: [] };
  }

  const userProjects = await db.query.projects.findMany({
    where: eq(projects.userId, locals.user.id),
    orderBy: [desc(projects.updatedAt)]
  });

  return { projects: userProjects };
};
```

4. Update `src/routes/cutlist/+page.svelte` to navigate to results page after optimization:

Replace the result display section with navigation:
```typescript
// In handleOptimize, after successful optimization:
result = optimizationResult;

// Navigate to results page with data
goto('/cutlist/results', {
  state: {
    result: optimizationResult,
    mode,
    cuts,
    stock,
    kerf
  }
});
```

Remove the OptimizationResults component from this page (it's now on /results).
Remove the results display section from the template.
Keep the error display for immediate error feedback.
  </action>
  <verify>
- Navigate to /cutlist
- Enter cuts and stock, click Optimize
- Verify navigation to /cutlist/results after loading
- Verify results display correctly
- Click "Go Back" - returns to /cutlist with data preserved
- Click "Save to Project" - modal works, saves successfully
- After save, link to view saved cut list appears
  </verify>
  <done>
- New /cutlist/results route created
- Results page displays optimization output
- "Go Back" button returns to optimizer with data preserved
- "Save to Project" button opens save modal and works correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cut lists listing page</name>
  <files>src/routes/cutlists/+page.svelte, src/routes/cutlists/+page.server.ts</files>
  <action>
1. Create `src/routes/cutlists/+page.server.ts`:
```typescript
import type { PageServerLoad } from './$types';
import { requireAuth } from '$lib/server/auth';
import { db } from '$lib/server/db';
import { cutLists, projects } from '$lib/server/schema';
import { eq, desc } from 'drizzle-orm';

export const load: PageServerLoad = async (event) => {
  const user = requireAuth(event);

  const userCutLists = await db.query.cutLists.findMany({
    where: eq(cutLists.userId, user.id),
    with: {
      project: {
        columns: { id: true, name: true }
      }
    },
    orderBy: [desc(cutLists.updatedAt)]
  });

  return { cutLists: userCutLists };
};
```

2. Create `src/routes/cutlists/+page.svelte`:
```svelte
<script lang="ts">
  import type { PageData } from './$types';

  let { data }: { data: PageData } = $props();

  function formatDate(date: Date): string {
    return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    }).format(date);
  }

  function getModeLabel(mode: string): string {
    return mode === 'linear' ? 'Linear (1D)' : 'Sheet (2D)';
  }
</script>

<svelte:head>
  <title>Cut Lists | WoodShop Toolbox</title>
</svelte:head>

<div class="page-container animate-fade-in">
  <header class="page-header">
    <div class="header-content">
      <h1 class="page-title">Cut Lists</h1>
      <p class="page-description">View and manage your saved cut optimization lists.</p>
    </div>
    <a href="/cutlist" class="btn-primary">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
      </svg>
      New Cut List
    </a>
  </header>

  {#if data.cutLists.length === 0}
    <div class="empty-state sanded-surface">
      <div class="empty-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
        </svg>
      </div>
      <p class="empty-text">No saved cut lists yet.</p>
      <a href="/cutlist" class="btn-ghost">Create your first cut list</a>
    </div>
  {:else}
    <div class="cutlist-grid">
      {#each data.cutLists as cutList (cutList.id)}
        <a href="/cutlist/{cutList.id}" class="cutlist-card sanded-surface">
          <div class="cutlist-header">
            <h3 class="cutlist-name">{cutList.name}</h3>
            <span class="cutlist-mode">{getModeLabel(cutList.mode)}</span>
          </div>
          <div class="cutlist-meta">
            {#if cutList.project}
              <span class="meta-item">
                <svg viewBox="0 0 20 20" fill="currentColor" class="meta-icon">
                  <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                </svg>
                {cutList.project.name}
              </span>
            {/if}
            <span class="meta-item">
              <svg viewBox="0 0 20 20" fill="currentColor" class="meta-icon">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
              </svg>
              {formatDate(cutList.createdAt)}
            </span>
          </div>
          <div class="cutlist-kerf">
            Kerf: {cutList.kerf}"
          </div>
        </a>
      {/each}
    </div>
  {/if}
</div>

<style>
  .page-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
    flex-wrap: wrap;
  }

  .header-content {
    flex: 1;
    min-width: 200px;
  }

  .page-title {
    font-family: var(--font-display);
    font-size: 2rem;
    color: var(--color-ink);
    margin: 0 0 var(--space-sm) 0;
  }

  .page-description {
    font-size: 0.9375rem;
    color: var(--color-ink-muted);
    margin: 0;
  }

  .btn-icon {
    width: 18px;
    height: 18px;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);
    padding: var(--space-2xl);
    text-align: center;
    border-radius: var(--radius-lg);
  }

  .empty-icon {
    width: 64px;
    height: 64px;
    color: var(--color-ink-muted);
    opacity: 0.5;
  }

  .empty-icon svg {
    width: 100%;
    height: 100%;
  }

  .empty-text {
    font-size: 1rem;
    color: var(--color-ink-muted);
    margin: 0;
  }

  .cutlist-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-lg);
  }

  .cutlist-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    padding: var(--space-lg);
    border-radius: var(--radius-lg);
    text-decoration: none;
    color: inherit;
    transition: all var(--transition-base);
  }

  .cutlist-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .cutlist-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-sm);
  }

  .cutlist-name {
    font-family: var(--font-display);
    font-size: 1.125rem;
    color: var(--color-ink);
    margin: 0;
  }

  .cutlist-mode {
    font-size: 0.75rem;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-walnut-soft);
    color: var(--color-walnut-dark);
    border-radius: var(--radius-sm);
  }

  .cutlist-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-md);
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.8125rem;
    color: var(--color-ink-muted);
  }

  .meta-icon {
    width: 14px;
    height: 14px;
  }

  .cutlist-kerf {
    font-size: 0.8125rem;
    color: var(--color-ink-soft);
    font-family: var(--font-mono, monospace);
  }
</style>
```
  </action>
  <verify>
- Navigate to /cutlists
- Verify page shows all user's saved cut lists
- Each card shows name, mode, project (if linked), date, kerf
- Click a card - navigates to /cutlist/[id]
- Empty state shows when no cut lists exist
- "New Cut List" button navigates to /cutlist
  </verify>
  <done>
- /cutlists page created showing all saved cut lists
- Each cut list displays name, mode, project link, date, kerf
- Cards link to individual cut list view
- Empty state and create button work correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify and fix saved cut list viewing</name>
  <files>src/routes/cutlist/[id]/+page.svelte, src/routes/cutlist/[id]/+page.server.ts</files>
  <action>
1. Verify the existing /cutlist/[id] route works correctly:
   - Check +page.server.ts loads cutList with cuts and stock
   - Check +page.svelte renders the data correctly

2. Based on CUT-39 (fix bug where saved Cut Lists are not viewable), investigate:
   - Run the app and try viewing a saved cut list
   - Check browser console for errors
   - Verify the route exists and has correct file structure

3. Common issues to check and fix:
   a. Missing route files: Ensure +page.svelte and +page.server.ts exist in src/routes/cutlist/[id]/
   b. Database query issues: Verify the query includes both cuts and stock relations
   c. Component prop issues: Ensure ShopChecklist and ManualPlacement receive correct props
   d. Type mismatches: Verify types align between server and client

4. Update the back link in /cutlist/[id]/+page.svelte to point to /cutlists (the new listing page):
```svelte
<a href="/cutlists" class="back-link">
  <svg ... >
    <path ... />
  </svg>
  Back to Cut Lists
</a>
```

5. Add error boundary or loading state if not present:
```svelte
{#if !data.cutList}
  <div class="error-state">
    <p>Cut list not found.</p>
    <a href="/cutlists">Return to Cut Lists</a>
  </div>
{:else}
  <!-- existing content -->
{/if}
```
  </action>
  <verify>
- Save a cut list from the optimizer
- Navigate to /cutlists
- Click on the saved cut list
- Verify /cutlist/[id] page loads correctly
- Verify cut list name, mode, kerf display correctly
- Verify Checklist tab shows cuts with completion tracking
- Verify Manual Placement tab shows cuts and stock
- Test with both linear and sheet mode cut lists
  </verify>
  <done>
- Saved cut lists are viewable from /cutlist/[id]
- Checklist and Manual Placement tabs work correctly
- Navigation between listing and detail pages works
- No console errors when viewing saved cut lists
  </done>
</task>

</tasks>

<verification>
1. Results page flow:
   - Optimize cuts -> navigate to /results -> results display
   - Go Back -> returns to /cutlist with data
   - Save to Project -> saves and shows link to view

2. Cut lists listing:
   - /cutlists shows all saved cut lists
   - Cards display correct metadata
   - Links navigate to detail pages

3. Cut list detail:
   - /cutlist/[id] loads and displays correctly
   - Both tabs (Checklist, Manual Placement) work
   - No console errors

4. End-to-end flow:
   - Create cut list -> optimize -> save -> view from listing -> view detail
</verification>

<success_criteria>
- CUT-37: New results page with 'Go Back' and 'Save to Project' buttons
- CUT-38: New route/view for saved Cut Lists (/cutlists listing page)
- CUT-39: Fixed bug where saved Cut Lists are not viewable (verified working)
</success_criteria>

<output>
After completion, create `.planning/phases/22-ui-refinements-and-cut-list-fixes/22-04-SUMMARY.md`
</output>
