---
phase: 04-bom-editing
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/lib/components/bom/AddItemForm.svelte
  - src/lib/components/bom/BOMCategory.svelte
  - src/lib/components/bom/BOMDisplay.svelte
  - src/routes/bom/new/+page.svelte
autonomous: false

must_haves:
  truths:
    - "User can add a custom material to any category"
    - "Added items appear in the correct category"
    - "Summary shows visible vs total item counts"
    - "All edit operations (quantity, visibility, add) work together"
  artifacts:
    - path: "src/lib/components/bom/AddItemForm.svelte"
      provides: "Inline form for adding custom materials"
      min_lines: 60
    - path: "src/lib/components/bom/BOMDisplay.svelte"
      provides: "Display with full mutation support"
      contains: "onAddItem"
    - path: "src/routes/bom/new/+page.svelte"
      provides: "Page with mutation handlers"
      contains: "handleAddItem"
  key_links:
    - from: "AddItemForm.svelte"
      to: "BOMCategory.svelte"
      via: "onAdd callback"
      pattern: "onAdd"
    - from: "BOMCategory.svelte"
      to: "BOMDisplay.svelte"
      via: "onAddItem callback"
      pattern: "onAddItem"
    - from: "BOMDisplay.svelte"
      to: "+page.svelte"
      via: "mutation callbacks"
      pattern: "onQuantityChange|onToggleVisibility|onAddItem"
---

<objective>
Add custom material capability and integrate all editing features.

Purpose: Complete EDIT-02 (add custom materials) and wire up all mutation handlers from page through components. This plan depends on 04-01 and 04-02 completing first.

Output: AddItemForm component, fully wired BOMDisplay and BOMCategory, page-level mutation handlers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Components after 04-01 and 04-02 complete:
@src/lib/components/bom/BOMItem.svelte
@src/lib/components/bom/BOMCategory.svelte
@src/lib/components/bom/BOMDisplay.svelte
@src/routes/bom/new/+page.svelte

# Types:
@src/lib/types/bom.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddItemForm component</name>
  <files>src/lib/components/bom/AddItemForm.svelte</files>
  <action>
Create a compact inline form for adding custom materials to the BOM.

**Props:**
```typescript
interface Props {
  category: BOMCategory;
  onAdd: (item: BOMItem) => void;
  onCancel: () => void;
}
```

**Implementation:**

1. Form fields with state:
```typescript
let name = $state('');
let quantity = $state(1);
let unit = $state('pcs');
let notes = $state('');
```

2. Unit options based on category:
```typescript
const unitOptions: Record<BOMCategory, string[]> = {
  lumber: ['bf', 'pcs', 'lf', 'sq ft'],
  hardware: ['pcs', 'each', 'set', 'box'],
  finishes: ['qt', 'gal', 'oz', 'can'],
  consumables: ['pcs', 'sheet', 'roll', 'box']
};
```

3. Form layout (horizontal, compact):
```svelte
<form onsubmit={handleSubmit} class="flex flex-wrap items-end gap-2 p-3 bg-gray-50 border-t border-gray-200">
  <div class="flex-1 min-w-[150px]">
    <label class="block text-xs font-medium text-gray-600 mb-1">Name</label>
    <input type="text" bind:value={name} required class="..." placeholder="Material name" />
  </div>
  <div class="w-20">
    <label class="block text-xs font-medium text-gray-600 mb-1">Qty</label>
    <input type="number" bind:value={quantity} min="1" required class="..." />
  </div>
  <div class="w-24">
    <label class="block text-xs font-medium text-gray-600 mb-1">Unit</label>
    <select bind:value={unit} class="...">
      {#each unitOptions[category] as opt}
        <option value={opt}>{opt}</option>
      {/each}
    </select>
  </div>
  <div class="flex-1 min-w-[100px]">
    <label class="block text-xs font-medium text-gray-600 mb-1">Notes</label>
    <input type="text" bind:value={notes} class="..." placeholder="Optional" />
  </div>
  <div class="flex gap-2">
    <button type="submit" class="px-3 py-1.5 bg-amber-600 text-white text-sm rounded hover:bg-amber-700">
      Add
    </button>
    <button type="button" onclick={onCancel} class="px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300">
      Cancel
    </button>
  </div>
</form>
```

4. Submit handler:
```typescript
function handleSubmit(e: Event) {
  e.preventDefault();
  const newItem: BOMItem = {
    id: `custom-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
    name: name.trim(),
    quantity,
    unit,
    category,
    notes: notes.trim() || undefined,
    hidden: false
  };
  onAdd(newItem);
  // Reset form
  name = '';
  quantity = 1;
  notes = '';
}
```

5. Input styling: Match existing inputs (rounded-md, border-gray-300, focus:ring-amber-500)
  </action>
  <verify>npm run check passes, AddItemForm.svelte exists and exports properly</verify>
  <done>AddItemForm component created with all fields and submit logic</done>
</task>

<task type="auto">
  <name>Task 2: Add "Add Item" button to BOMCategory</name>
  <files>src/lib/components/bom/BOMCategory.svelte</files>
  <action>
Integrate AddItemForm into BOMCategory with toggle visibility.

**Import:**
```typescript
import AddItemForm from './AddItemForm.svelte';
```

**Props changes:**
Add to Props interface:
```typescript
onAddItem?: (item: BOMItem) => void;
```

**State:**
```typescript
let showAddForm = $state(false);
```

**Implementation:**

1. After the items list (inside the expanded section), add:
```svelte
{#if expanded}
  <div class="border-t border-gray-200">
    {#each items as item (item.id)}
      <BOMItem {item} {onQuantityChange} {onToggleVisibility} />
    {/each}
  </div>

  <!-- Add Item section -->
  {#if onAddItem}
    {#if showAddForm}
      <AddItemForm
        {category}
        onAdd={(item) => {
          onAddItem(item);
          showAddForm = false;
        }}
        onCancel={() => showAddForm = false}
      />
    {:else}
      <button
        type="button"
        onclick={() => showAddForm = true}
        class="w-full px-4 py-2 text-sm text-amber-700 hover:bg-amber-50 border-t border-gray-200 flex items-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Add Item
      </button>
    {/if}
  {/if}
{/if}
```

The form shows inline when clicking "Add Item", then hides after adding or canceling.
  </action>
  <verify>npm run check passes, "Add Item" button appears in categories</verify>
  <done>BOMCategory has "Add Item" button that reveals AddItemForm inline</done>
</task>

<task type="auto">
  <name>Task 3: Update BOMDisplay with full mutation support</name>
  <files>src/lib/components/bom/BOMDisplay.svelte</files>
  <action>
Add all mutation callback props and update summary to exclude hidden items.

**Props changes:**
Update Props interface:
```typescript
interface Props {
  bom: BOM;
  onStartOver: () => void;
  onQuantityChange?: (id: string, quantity: number) => void;
  onToggleVisibility?: (id: string) => void;
  onAddItem?: (item: BOMItem) => void;
}
```

**Implementation:**

1. Destructure new props:
```typescript
let { bom, onStartOver, onQuantityChange, onToggleVisibility, onAddItem }: Props = $props();
```

2. Pass callbacks to each BOMCategory:
```svelte
{#each categoryOrder as category}
  {@const items = groupedItems.get(category) ?? []}
  {#if items.length > 0}
    <BOMCategory
      {category}
      {items}
      {onQuantityChange}
      {onToggleVisibility}
      {onAddItem}
    />
  {/if}
{/each}
```

3. Update summary footer to show visible vs total:
```typescript
const totalItems = $derived(bom.items.length);
const visibleItems = $derived(bom.items.filter(i => !i.hidden).length);
const hasHiddenItems = $derived(visibleItems < totalItems);
const categoriesWithItems = $derived(
  categoryOrder.filter((c) => (groupedItems.get(c)?.length ?? 0) > 0).length
);
```

```svelte
<div class="mt-6 rounded-lg border border-gray-200 bg-gray-50 px-4 py-3">
  <p class="text-sm text-gray-600">
    {#if hasHiddenItems}
      <span class="font-medium">{visibleItems} visible</span> of {totalItems} total items
    {:else}
      <span class="font-medium">{totalItems} total items</span>
    {/if}
    across {categoriesWithItems} categories
  </p>
</div>
```
  </action>
  <verify>npm run check passes, BOMDisplay accepts and passes all callbacks</verify>
  <done>BOMDisplay has full mutation support and accurate visible/total counts</done>
</task>

<task type="auto">
  <name>Task 4: Implement mutation handlers in page</name>
  <files>src/routes/bom/new/+page.svelte</files>
  <action>
Add mutation handlers and pass to BOMDisplay.

**Import update:**
Ensure BOMItem type is imported:
```typescript
import type { BOM, ProjectDetails, BOMItem } from '$lib/types/bom';
```

**Add mutation handlers after handleStartOver:**

```typescript
// Handle quantity change
function handleQuantityChange(id: string, quantity: number) {
  if (!generatedBOM) return;
  generatedBOM = {
    ...generatedBOM,
    items: generatedBOM.items.map(item =>
      item.id === id ? { ...item, quantity } : item
    )
  };
}

// Handle visibility toggle
function handleToggleVisibility(id: string) {
  if (!generatedBOM) return;
  generatedBOM = {
    ...generatedBOM,
    items: generatedBOM.items.map(item =>
      item.id === id ? { ...item, hidden: !item.hidden } : item
    )
  };
}

// Handle add item
function handleAddItem(item: BOMItem) {
  if (!generatedBOM) return;
  generatedBOM = {
    ...generatedBOM,
    items: [...generatedBOM.items, item]
  };
}
```

**Update BOMDisplay usage:**
```svelte
<BOMDisplay
  bom={generatedBOM}
  onStartOver={handleStartOver}
  onQuantityChange={handleQuantityChange}
  onToggleVisibility={handleToggleVisibility}
  onAddItem={handleAddItem}
/>
```

The handlers use immutable updates to trigger Svelte reactivity.
  </action>
  <verify>npm run check passes, all handlers implemented</verify>
  <done>Page has all mutation handlers wired to BOMDisplay</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete BOM editing functionality: quantity editing, visibility toggle, and add custom materials</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:5173/bom/new
    3. Complete the wizard to generate a BOM
    4. Verify: BOM displays with categories

    **Test EDIT-01 (Quantity Editing):**
    5. Click on any item's quantity number
    6. Change the value and press Enter or click away
    7. Verify: Quantity updates immediately

    **Test EDIT-03 (Visibility Toggle):**
    8. Uncheck the checkbox on any item
    9. Verify: Item appears greyed out with strikethrough
    10. Verify: Category header shows "X of Y items"
    11. Verify: Summary footer shows "X visible of Y total items"

    **Test EDIT-02 (Add Custom Material):**
    12. Click "Add Item" button in any category
    13. Fill out the form (name, quantity, unit)
    14. Click "Add"
    15. Verify: New item appears in the category

    **Integration test:**
    16. Edit the quantity of the item you just added
    17. Toggle visibility on a few items
    18. Verify: All changes persist in the display
    19. Click "Start Over" - verify wizard resets
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run check` passes (0 errors)
- [ ] AddItemForm.svelte component exists and works
- [ ] "Add Item" button appears in each category
- [ ] Adding item puts it in correct category
- [ ] All callbacks flow correctly: Page -> BOMDisplay -> BOMCategory -> BOMItem/AddItemForm
- [ ] Summary footer shows visible vs total counts
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification approved
- All EDIT requirements satisfied:
  - EDIT-01: Quantity editing works
  - EDIT-02: Custom materials can be added
  - EDIT-03: Visibility toggle works
  - EDIT-04: Category grouping (already complete)
</success_criteria>

<output>
After completion, create `.planning/phases/04-bom-editing/04-03-SUMMARY.md`
</output>
